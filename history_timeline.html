<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freedom Trail - A New Perspective</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Eczar:wght@600&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        :root {
            --saffron: #FF9933;
            --green: #138808;
            --primary: #8e44ad;
            --secondary: #3498db;
            --text-light: #ecf0f1;
            --parchment: #F5E8D8;
            --parchment-dark: #D4C3A3;
        }
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            color: var(--text-light);
            perspective: 1000px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            position: relative;
        }

        /* Dynamic Background Layer */
        #dynamic-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #1A202C, #2D3748, #4A5568);
            background-size: 400% 400%;
            animation: gradient-flow 30s ease infinite;
            transition: background 1s ease-in-out;
            z-index: 1;
        }
        @keyframes gradient-flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Animated floating particles/fog overlay */
        #dynamic-background::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 10%, rgba(0,0,0,0) 70%);
            animation: pulse-light 15s linear infinite alternate;
        }
        @keyframes pulse-light {
            0% { transform: scale(1); opacity: 0.5; }
            100% { transform: scale(1.2); opacity: 0.8; }
        }

        /* Screens */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease, transform 0.5s ease;
            backface-visibility: hidden;
            z-index: 10;
        }
        .screen.hidden { opacity: 0; pointer-events: none; transform: rotateY(180deg); }
        #game-screen.hidden { transform: rotateY(-180deg); }

        /* Start/End Screen Button */
        .action-btn {
            padding: 1rem 2rem; font-size: 1.5rem; font-family: 'Eczar', serif;
            background: linear-gradient(145deg, var(--saffron), #e68a2e);
            color: white; border: none; border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            cursor: pointer; transition: all 0.2s ease;
        }
        .action-btn:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.4); }

        /* Game UI */
        .top-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            width: 100%; max-width: 800px; margin-bottom: 1rem; 
            background: rgba(0,0,0,0.4); padding: 0.75rem 1.5rem; border-radius: 15px;
            backdrop-filter: blur(10px);
            z-index: 11;
        }
        #lives-container, #score-container, #level-container {
            font-size: 1.2rem; font-weight: bold;
        }
        #score { transition: transform 0.3s ease; display: inline-block; }
        .score-pulse { transform: scale(1.3); }
        #sound-toggle { background: none; border: none; cursor: pointer; font-size: 1.5rem; }
        .progress-container { flex-grow: 1; margin: 0 1rem; background-color: rgba(255,255,255,0.1); border-radius: 10px; }
        #progress-fill { height: 1.25rem; border-radius: 10px; background: linear-gradient(90deg, var(--saffron), var(--green)); transition: width 0.5s ease; }
        
        /* New Game Path Styling */
        #game-path-container {
            width: 80%; max-width: 600px;
            height: 10px;
            background-color: rgba(255,255,255,0.2);
            border-radius: 5px;
            position: relative;
            margin: 2rem 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .path-step {
            width: 30px; height: 30px;
            background-color: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
            color: #fff;
            border: 2px solid transparent;
            transition: all 0.5s ease;
        }
        .path-step.current {
            background-color: var(--saffron);
            transform: scale(1.3);
            border-color: #fff;
            box-shadow: 0 0 15px var(--saffron);
        }
        .path-step.completed {
            background-color: var(--green);
            transform: scale(1.1);
        }

        #quiz-container {
            width: 100%; max-width: 800px; padding: 2rem;
            background: rgba(20, 15, 10, 0.7); backdrop-filter: blur(15px);
            border-radius: 20px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1); position: relative;
        }
        /* New Hint area style */
        #hint-container {
            margin-top: 1rem;
            text-align: center;
            font-style: italic;
            color: #a0aec0;
        }

        #question-container {
            background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white;
            padding: 1.5rem; border-radius: 15px; margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transform-style: preserve-3d;
            animation: flipIn 0.6s ease forwards;
        }

        @keyframes flipIn {
            from { transform: rotateX(-90deg); opacity: 0; }
            to { transform: rotateX(0deg); opacity: 1; }
        }

        .option-btn {
            background-color: rgba(255,255,255,0.9); color: #333;
            transition: all 0.3s ease; opacity: 0;
            animation: optionFadeIn 0.5s ease forwards;
        }
        .option-btn:hover:not(:disabled) {
            transform: translateY(-5px) scale(1.02); box-shadow: 0 6px 20px rgba(0,0,0,0.15); border-color: var(--saffron);
        }

        @keyframes optionFadeIn {
            to { opacity: 1; transform: translateY(0); }
        }

        .correct-answer {
            background-color: #d1fae5; border-color: #10b981;
        }
        .incorrect-answer {
            background-color: #fee2e2; border-color: #ef4444;
        }
        .animate-shake {
            animation: incorrect-shake 0.4s ease;
        }
        @keyframes incorrect-shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
        
        /* Gandhi Animations */
        .gandhi-animation-container {
            position: absolute;
            top: -250px; /* Start above screen */
            left: 50%;
            width: 200px;
            height: 250px;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
        }
        .gandhi-animation-container.animate {
            animation: fallAndFade 3s cubic-bezier(0.3, 0.6, 0.8, 1) forwards;
        }
        @keyframes fallAndFade {
            0% { top: -250px; opacity: 1; transform: translateX(-50%) rotate(-15deg); }
            50% { top: 50vh; transform: translateX(-50%) translateY(-50%) rotate(10deg); }
            100% { top: 110vh; opacity: 0; transform: translateX(-50%) translateY(-50%) rotate(0deg); }
        }

        /* Correct Answer Popup */
        #correct-answer-popup { z-index: 2000; background-color: rgba(0,0,0,0.5); }
        .animate-pop { animation: pop-in 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes pop-in {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .sparkle {
            position: absolute;
            width: 10px; height: 10px;
            background-color: white;
            border-radius: 50%;
            pointer-events: none;
            opacity: 0;
        }
        .sparkle.animate {
            animation: sparkle-animation 1s ease-out forwards;
        }
        @keyframes sparkle-animation {
            0% { transform: scale(0) rotate(0deg); opacity: 1; }
            100% { transform: scale(1.5) rotate(360deg); opacity: 0; }
        }


        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7); z-index: 50;
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #2c3e50; color: var(--text-light);
            border: 1px solid rgba(255, 153, 51, 0.5);
            animation: modalPopIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes modalPopIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        
        .loader {
            border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid var(--saffron); width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #gemini-response {
            background-color: rgba(0,0,0,0.3); border-left: 4px solid var(--green); padding: 15px; margin-top: 20px;
            border-radius: 5px; text-align: left; font-style: italic;
        }

        /* Emoji Rain */
        #emoji-rain-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 999;
        }
        .emoji {
            position: absolute;
            top: -10%;
            font-size: 2rem;
            animation: fall linear forwards;
        }
        @keyframes fall {
            to {
                top: 110%;
                transform: rotate(360deg);
            }
        }

        /* Unique Modal/Parchment styling */
        .parchment-modal {
            background-color: var(--parchment);
            color: black;
            font-family: 'Eczar', serif;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border-radius: 10px;
            position: relative;
            padding: 3rem;
            animation: parchment-unroll 1s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes parchment-unroll {
            from { transform: scaleY(0.1) scaleX(0.8); opacity: 0; }
            to { transform: scaleY(1) scaleX(1); opacity: 1; }
        }
        .parchment-modal::before {
            content: '';
            position: absolute;
            top: 0; bottom: 0; left: 0; right: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.1' fill-rule='evenodd'%3E%3Cpath d='M10 0h1v60h-1V0zm10 0h1v60h-1V0zM0 10h60v1H0v-1zM0 20h60v1H0v-1z'/%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.1;
            pointer-events: none;
        }

        /* Hidden story section */
        .hidden-story {
            background: rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--green);
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 5px;
            font-style: italic;
            transition: all 0.5s ease-in-out;
            transform: scale(0.95);
            opacity: 0;
            animation: story-in 1s forwards;
            animation-delay: 2.5s;
        }

        .hidden-story.show {
            opacity: 1;
            transform: scale(1);
        }
        
        @keyframes story-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #gemini-loader {
            filter: invert(1);
        }

        /* ‡§®‡§ø‡§ï‡§æ‡§∏ ‡§¨‡§ü‡§® ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤ (Exit button style) */
        #exit-btn {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 1.5rem;
            transition: color 0.2s ease;
            /* Update to make it stand out more */
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 20;
            background-color: rgba(255, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            padding: 0.5rem 1rem;
            border-radius: 10px;
        }
        #exit-btn:hover {
            color: white;
            background-color: rgba(255, 0, 0, 0.6);
        }
        
        /* Flowchart Modal Style */
        .flowchart-modal-content {
            background: linear-gradient(135deg, #1A202C, #2D3748, #4A5568);
            color: white;
            border: 2px solid var(--saffron);
            padding: 2rem;
            text-align: center;
        }
        .flowchart-nodes-container {
            display: flex;
            flex-wrap: wrap; /* Changed to wrap so it doesn't get cut off */
            justify-content: center;
            gap: 1rem;
            padding: 1rem;
            overflow-x: hidden;
        }
        .flowchart-node {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--green);
            border-radius: 10px;
            padding: 1rem;
            width: 180px; /* Increased size to prevent cutting */
            font-size: 1rem;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transform-style: preserve-3d;
            transform: rotateY(-90deg);
            animation: flipInNode 0.8s forwards;
            margin-bottom: 2rem; /* Added space between rows */
        }
        @keyframes flipInNode {
            to {
                transform: rotateY(0deg);
            }
        }
        .flowchart-node h4 {
            font-weight: bold;
        }
        .flowchart-node p {
            font-size: 0.9rem;
            color: #cbd5e1;
            margin-top: 0.5rem;
        }
        .arrow-down {
            display: block;
            margin-bottom: 1rem;
            font-size: 2rem;
            color: var(--green);
            animation: bounce-arrow-down 1s infinite;
        }
        @keyframes bounce-arrow-down {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(10px); }
        }
    </style>
</head>
<body>

    <!-- Dynamic Background Div -->
    <div id="dynamic-background"></div>

    <!-- Start Screen -->
    <div id="start-screen" class="screen p-4 text-center">
        <h1 class="text-5xl md:text-7xl font-bold font-display mb-4">
            <span class="header-saffron">Freedom Trail</span>: <span class="header-green">A New Perspective</span>
        </h1>
        <p class="text-xl text-gray-300 mb-8 max-w-2xl">An unique journey through the story of India's independence. Are you ready to turn the pages of history?</p>
        <button id="start-btn" class="action-btn">Start Game</button>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="screen hidden p-4">
        <div class="w-full flex flex-col items-center">
            <!-- New Top Bar with Level Display -->
            <div class="top-bar">
                <div id="lives-container">Lives: <span id="lives"></span></div>
                <div id="score-container">Score: <span id="score">0</span></div>
                <div id="level-container">Level: <span id="current-level"></span></div>
                <div class="progress-container"><div id="progress-fill"></div></div>
                <button id="sound-toggle"></button>
            </div>
            <button id="exit-btn"><i class="fas fa-door-open"></i> Exit</button>
            <div id="game-path-container"></div>
            <div id="quiz-container">
                <div id="question-container"><h2 id="question-text" class="text-xl md:text-2xl font-bold text-center"></h2></div>
                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                <!-- New Hint button and hint display area -->
                <button id="hint-btn" class="action-btn mt-4 text-sm py-2 px-4" style="background: linear-gradient(145deg, #1f643e, #138808);"><i class="fas fa-question-circle"></i> Hint</button>
                <div id="hint-area" class="mt-4 text-center font-bold text-gray-300"></div>
            </div>
        </div>
    </div>

    <!-- End Screen -->
    <div id="end-screen" class="screen hidden p-4 text-center">
        <h2 id="end-title" class="text-5xl font-display mb-4">Game Over!</h2>
        <p id="end-message" class="text-xl mb-2">Your final score is:</p>
        <p id="final-score" class="text-7xl font-bold header-saffron mb-8">0</p>
        <button id="restart-btn" class="action-btn">Play Again</button>
    </div>

    <!-- Info Modal -->
    <div id="info-modal" class="modal">
        <div class="modal-content w-11/12 max-w-2xl p-8 rounded-lg shadow-2xl text-center">
             <h2 id="modal-title" class="text-2xl font-bold mb-4 header-saffron font-display"></h2>
             <p id="modal-text" class="text-gray-900 mb-6"></p>
             <div id="gemini-container" class="hidden">
                 <div id="gemini-loader" class="loader hidden"></div>
                 <div id="gemini-response" class="hidden hidden-story"></div>
             </div>
             <div class="flex justify-center flex-wrap gap-4 mt-4">
                 <button id="gemini-btn" class="action-btn text-base py-2 px-4">Hidden Story</button>
                 <button id="modal-close-btn" class="action-btn text-base py-2 px-4">Continue</button>
             </div>
        </div>
    </div>

    <!-- Flowchart Modal -->
    <div id="flowchart-modal" class="modal">
        <div class="modal-content flowchart-modal-content w-11/12 max-w-2xl p-8 rounded-lg shadow-2xl text-center">
            <h2 id="flowchart-title" class="text-3xl font-bold font-display mb-4">Level Complete!</h2>
            <div id="flowchart-content" class="mb-4"></div>
            <button id="flowchart-close-btn" class="action-btn">Continue to Next Level</button>
        </div>
    </div>
    
    <!-- Animations -->
    <div id="emoji-rain-container"></div>
    <div id="correct-answer-popup" class="screen hidden">
        <div class="relative text-center p-8 bg-purple-900/80 backdrop-blur-sm rounded-2xl shadow-lg border-4 border-yellow-400 animate-pop">
            <div id="sparkle-container" class="absolute top-0 left-0 w-full h-full pointer-events-none"></div>
            <h2 class="text-5xl font-display text-yellow-300 mb-4">Congratulations!</h2>
            <div class="w-48 h-auto mx-auto">
                 <svg viewBox="0 0 200 250" xmlns="http://www.w3.org/2000/svg">
                    <!-- Happy Gandhi SVG -->
                    <g transform="translate(0, 10)"><rect x="145" y="120" width="10" height="120" rx="5" fill="#6b4a3a" transform="rotate(10, 150, 230)"/><path d="M 100,50 A 30,35 0 0 1 100,120 A 30,35 0 0 1 100,50 Z" fill="#E0B59A"/><g stroke="#333" stroke-width="2.5" fill="none"><circle cx="85" cy="85" r="12"/><circle cx="115" cy="85" r="12"/><path d="M 97,85 L 103,85"/></g><path d="M90 105 Q 100 115 110 105" stroke="#333" stroke-width="2" fill="none" /><path d="M 70,85 C 65,85 65,75 75,75" stroke="#333" stroke-width="2" fill="none" transform="rotate(-5, 70, 85)"/><path d="M 130,85 C 135,85 135,75 125,75" stroke="#333" stroke-width="2" fill="none" transform="rotate(5, 130, 85)"/><path d="M 100,130 Q 100,150 80,220 L 120,220 Q 100,150 100,130" fill="#E0B59A"/><path d="M 80 210 C 70 230, 70 280, 80 220 L 120 220 C 130 280, 130 230, 120 210 Q 100 230 80 210 Z" fill="#fffaf0" stroke="#d3d3d3" stroke-width="1"/><path d="M 60,140 C 40,140 30,170 40,220 L 60,220 C 50,180 60,140 60,140" fill="#E0B59A"/><path d="M 140,140 C 160,140 170,170 160,220 L 140,220 C 150,180 140,140 140,140" fill="#E0B59A"/></g>
                 </svg>
            </div>
        </div>
    </div>
    <div id="gandhi-cry" class="gandhi-animation-container">
        <svg viewBox="0 0 200 250" xmlns="http://www.w3.org/2000/svg">
            <!-- Crying Gandhi SVG -->
            <g transform="translate(0, 10)"><rect x="145" y="120" width="10" height="120" rx="5" fill="#6b4a3a" transform="rotate(10, 150, 230)"/><path d="M 100,50 A 30,35 0 0 1 100,120 A 30,35 0 0 1 100,50 Z" fill="#E0B59A"/><g stroke="#333" stroke-width="2.5" fill="none"><circle cx="85" cy="85" r="12"/><circle cx="115" cy="85" r="12"/><path d="M 97,85 L 103,85"/></g><path d="M90 110 Q 100 100 110 110" stroke="#333" stroke-width="2" fill="none" /><path d="M 70,85 C 65,85 65,75 75,75" stroke="#333" stroke-width="2" fill="none" transform="rotate(-5, 70, 85)"/><path d="M 130,85 C 135,85 135,75 125,75" stroke="#333" stroke-width="2" fill="none" transform="rotate(5, 130, 85)"/><path d="M 100,130 Q 100,150 80,220 L 120,220 Q 100,150 100,130" fill="#E0B59A"/><path d="M 80 210 C 70 230, 70 280, 80 220 L 120 220 C 130 280, 130 230, 120 210 Q 100 230 80 210 Z" fill="#fffaf0" stroke="#d3d3d3" stroke-width="1"/><path d="M 60,140 C 40,140 30,170 40,220 L 60,220 C 50,180 60,140 60,140" fill="#E0B59A"/><path d="M 140,140 C 160,140 170,170 160,220 L 140,220 C 150,180 140,140 140,140" fill="#E0B59A"/><path d="M85 95 q 0 10 -5 20" stroke="#3498db" stroke-width="4" fill="none"><animate attributeName="d" values="M85 95 q 0 10 -5 20; M85 95 q 0 20 -5 40; M85 95 q 0 10 -5 20" dur="1.5s" repeatCount="indefinite"/></path><path d="M115 95 q 0 10 5 20" stroke="#3498db" stroke-width="4" fill="none"><animate attributeName="d" values="M115 95 q 0 10 5 20; M115 95 q 0 20 5 40; M115 95 q 0 10 5 20" dur="1.5s" repeatCount="indefinite" begin="0.2s"/></path></g>
                </svg>
            </div>
        </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // New questions divided by level, now with exactly 5 per level
    const allEvents = {
        easy: [
            { id: 1, year: "1857", question: "The First War of Independence is also known as what?", description: "The First War of Independence (Sepoy Mutiny)", details: "A major, but ultimately unsuccessful, uprising in India in 1857‚Äì58 against the rule of the British East India Company...", hint: "The name of a well-known rifle was a major cause.", flowchart_details: "The Sepoy Mutiny marked the beginning of India's long struggle for independence." },
            { id: 2, year: "1885", question: "In which year was the Indian National Congress formed?", description: "Formation of the Indian National Congress", details: "Founded to create a platform for civic and political dialogue among educated Indians...", hint: "This organization was established by a retired British civil servant.", flowchart_details: "INC was the first modern nationalist movement in India." }
        ],
        medium: [
            { id: 3, year: "1905", question: "The decision to partition Bengal was made by which Viceroy?", description: "Partition of Bengal", details: "The decision to partition the state of Bengal by the Viceroy of India, Lord Curzon, sparked massive protests...", hint: "The protests were famously led by 'Swadeshi' and 'Boycott' movements.", flowchart_details: "This event led to the rise of Swadeshi and Boycott movements." },
            { id: 4, year: "1915", question: "What is the key event of 1915 related to Mahatma Gandhi?", description: "Mahatma Gandhi returns to India", details: "After spending two decades in South Africa, Gandhi returned to India and became a central figure...", hint: "The day of his return is celebrated as 'Pravasi Bharatiya Divas'.", flowchart_details: "Gandhi's return marked the beginning of a new era of non-violent resistance." },
            { id: 5, year: "1919", question: "Which tragic event occurred in Amritsar in 1919?", description: "Jallianwala Bagh Massacre", details: "British troops fired on a large crowd of unarmed Indians in Amritsar, a turning point that fueled national anger.", hint: "A well was filled with the bodies of those who jumped to escape the bullets.", flowchart_details: "The brutal massacre was a turning point, accelerating the independence movement." }
        ],
        difficult: [
            { id: 6, year: "1920", question: "Which non-violent movement was suspended after the Chauri Chaura incident?", description: "Non-Cooperation Movement", details: "A nationwide campaign of non-violent civil disobedience led by Mahatma Gandhi.", hint: "This movement was suspended after a violent incident at Chauri Chaura.", flowchart_details: "The first large-scale movement to challenge British authority." },
            { id: 7, year: "1930", question: "Which famous march did Gandhi lead to protest the British salt tax?", description: "The Dandi March (Salt March)", details: "An act of nonviolent civil disobedience led by Mahatma Gandhi to protest the British salt tax.", hint: "The journey was over 240 miles to a coastal village.", flowchart_details: "A symbolic act of defiance that mobilized millions across India." },
            { id: 8, year: "1942", question: "What was the name of the movement started by Gandhi with the call 'Do or Die'?", description: "Quit India Movement", details: "A movement launched by Mahatma Gandhi, demanding an end to British rule of India.", hint: "Gandhiji's call to action was 'Do or Die'.", flowchart_details: "A mass civil disobedience movement demanding British withdrawal from India." },
            { id: 9, year: "1943", question: "Which armed force was formed by Subhas Chandra Bose in 1943?", description: "Formation of the Azad Hind Fauj", details: "Led by Subhas Chandra Bose, it was an armed force formed by Indian nationalists to secure India's independence from British rule.", hint: "Its battle cry was 'Jai Hind!'", flowchart_details: "An armed force dedicated to fighting for India's freedom." },
            { id: 10, year: "1946", question: "What widespread mutiny by Indian sailors contributed to the British decision to leave India?", description: "Royal Indian Navy Mutiny", details: "A widespread mutiny by Indian sailors against British officers, which contributed to the British decision to leave India.", hint: "This mutiny started in Mumbai (then Bombay) and spread to other cities.", flowchart_details: "This event showed the waning loyalty of British India's armed forces." }
        ]
    };
    
    // An array of gradients to cycle through
    const gradients = [
        "linear-gradient(45deg, #480C68, #15083F, #0D0124, #FF9933)",
        "linear-gradient(135deg, #1A202C, #2D3748, #4A5568)",
        "linear-gradient(45deg, #2c3e50, #34495e, #1f643e, #138808)",
        "linear-gradient(135deg, #3498db, #2c3e50, #FF9933)"
    ];
    
    // Flowchart data for each level
    const flowchartContent = {
        easy: `
            <div class="flowchart-nodes-container">
                <div class="flowchart-node" style="animation-delay: 0.1s">
                    <h4>1857</h4>
                    <p>First War of Independence</p>
                    <p class="mt-2 text-xs text-gray-400">The Sepoy Mutiny marked the beginning of India's long struggle for independence.</p>
                </div>
                <div class="arrow-right">‚Üí</div>
                <div class="flowchart-node" style="animation-delay: 0.3s">
                    <h4>1885</h4>
                    <p>Indian National Congress Formed</p>
                    <p class="mt-2 text-xs text-gray-400">INC was the first modern nationalist movement in India.</p>
                </div>
            </div>
        `,
        medium: `
            <div class="flowchart-nodes-container">
                <div class="flowchart-node" style="animation-delay: 0.1s">
                    <h4>1905</h4>
                    <p>Partition of Bengal</p>
                    <p class="mt-2 text-xs text-gray-400">This event led to the rise of Swadeshi and Boycott movements.</p>
                </div>
                <div class="arrow-right">‚Üí</div>
                <div class="flowchart-node" style="animation-delay: 0.3s">
                    <h4>1915</h4>
                    <p>Gandhi's Return</p>
                    <p class="mt-2 text-xs text-gray-400">Gandhi's return marked the beginning of a new era of non-violent resistance.</p>
                </div>
                <div class="arrow-right">‚Üí</div>
                <div class="flowchart-node" style="animation-delay: 0.5s">
                    <h4>1919</h4>
                    <p>Jallianwala Bagh Massacre</p>
                    <p class="mt-2 text-xs text-gray-400">The brutal massacre was a turning point, accelerating the independence movement.</p>
                </div>
            </div>
        `,
        difficult: `
            <div class="flowchart-nodes-container">
                <div class="flowchart-node" style="animation-delay: 0.1s">
                    <h4>1920</h4>
                    <p>Non-Cooperation Movement</p>
                    <p class="mt-2 text-xs text-gray-400">The first large-scale movement to challenge British authority.</p>
                </div>
                <div class="arrow-right">‚Üí</div>
                <div class="flowchart-node" style="animation-delay: 0.3s">
                    <h4>1930</h4>
                    <p>The Dandi March</p>
                    <p class="mt-2 text-xs text-gray-400">A symbolic act of defiance that mobilized millions across India.</p>
                </div>
                <div class="arrow-right">‚Üí</div>
                <div class="flowchart-node" style="animation-delay: 0.5s">
                    <h4>1942</h4>
                    <p>Quit India Movement</p>
                    <p class="mt-2 text-xs text-gray-400">A mass civil disobedience movement demanding British withdrawal from India.</p>
                </div>
                <div class="arrow-right">‚Üí</div>
                <div class="flowchart-node" style="animation-delay: 0.7s">
                    <h4>1943</h4>
                    <p>Azad Hind Fauj Formed</p>
                    <p class="mt-2 text-xs text-gray-400">An armed force dedicated to fighting for India's freedom.</p>
                </div>
                <div class="arrow-right">‚Üí</div>
                <div class="flowchart-node" style="animation-delay: 0.9s">
                    <h4>1946</h4>
                    <p>Royal Indian Navy Mutiny</p>
                    <p class="mt-2 text-xs text-gray-400">This event showed the waning loyalty of British India's armed forces.</p>
                </div>
            </div>
        `
    };
    
    // Create a single array of all questions for filtering
    const allQuestions = Object.values(allEvents).flat();

    // State
    let shuffledQuestions, currentQuestionIndex, score, lives, soundEnabled = true, hintUsed = false;
    let currentLevel = 'easy';

    // Screens
    const startScreen = document.getElementById('start-screen');
    const gameScreen = document.getElementById('game-screen');
    const endScreen = document.getElementById('end-screen');
    
    // Buttons
    const startBtn = document.getElementById('start-btn');
    const restartBtn = document.getElementById('restart-btn');
    const soundToggle = document.getElementById('sound-toggle');
    const exitBtn = document.getElementById('exit-btn');
    const hintBtn = document.getElementById('hint-btn');
    
    // Game Elements
    const questionText = document.getElementById('question-text');
    const optionsContainer = document.getElementById('options-container');
    const progressFill = document.getElementById('progress-fill');
    const scoreEl = document.getElementById('score');
    const livesEl = document.getElementById('lives');
    const levelEl = document.getElementById('current-level');
    const gamePathContainer = document.getElementById('game-path-container');
    const dynamicBackground = document.getElementById('dynamic-background');
    const hintArea = document.getElementById('hint-area');
    
    // Modal & Gemini Elements
    const modal = document.getElementById('info-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalText = document.getElementById('modal-text');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const geminiBtn = document.getElementById('gemini-btn');
    const geminiContainer = document.getElementById('gemini-container');
    const geminiLoader = document.getElementById('gemini-loader');
    const geminiResponse = document.getElementById('gemini-response');

    // Flowchart Elements
    const flowchartModal = document.getElementById('flowchart-modal');
    const flowchartTitle = document.getElementById('flowchart-title');
    const flowchartContentEl = document.getElementById('flowchart-content');
    const flowchartCloseBtn = document.getElementById('flowchart-close-btn');
    
    // Animation Elements
    const correctAnswerPopup = document.getElementById('correct-answer-popup');
    const gandhiCry = document.getElementById('gandhi-cry');
    const emojiRainContainer = document.getElementById('emoji-rain-container');

    // Sounds - More unique sounds
    const correctSound = new Tone.Synth({
        oscillator: { type: "triangle" },
        envelope: { attack: 0.1, decay: 0.5, sustain: 0.1, release: 0.5 }
    }).toDestination();
    const incorrectSound = new Tone.NoiseSynth({
        noise: { type: "pink" },
        envelope: { attack: 0.005, decay: 0.2, sustain: 0, release: 0.05 }
    }).toDestination();
    const clickSound = new Tone.PluckSynth().toDestination();

    function playSound(type) {
        if (!soundEnabled || Tone.context.state !== 'running') return;
        try {
            if (type === 'correct') correctSound.triggerAttackRelease("C5", "8n");
            else if (type === 'incorrect') incorrectSound.triggerAttackRelease();
            else if (type === 'click') clickSound.triggerAttackRelease("C4");
        } catch (e) { console.error("Sound error:", e); }
    }

    function initGame() {
        score = 0;
        lives = 3;
        currentQuestionIndex = 0;
        currentLevel = 'easy';
        shuffledQuestions = [...allEvents[currentLevel]].sort(() => 0.5 - Math.random());
        updateScore(0);
        updateLives();
        updateLevelDisplay(); // Set the initial level display
        createGamePath();
        loadNextQuestion();
    }
    
    // New function to update background gradient
    function updateBackground() {
        const gradientIndex = currentQuestionIndex % gradients.length;
        dynamicBackground.style.background = gradients[gradientIndex];
    }
    
    function updateLevelDisplay() {
        levelEl.textContent = currentLevel.charAt(0).toUpperCase() + currentLevel.slice(1);
    }

    function createGamePath() {
        gamePathContainer.innerHTML = '';
        const levelQuestions = allEvents[currentLevel];
        levelQuestions.forEach((_, index) => {
            const step = document.createElement('div');
            step.className = 'path-step';
            step.textContent = index + 1;
            gamePathContainer.appendChild(step);
        });
        updateGamePath();
    }
    
    function updateGamePath() {
        const steps = gamePathContainer.querySelectorAll('.path-step');
        steps.forEach((step, index) => {
            step.classList.remove('current', 'completed');
            if (index < currentQuestionIndex) {
                step.classList.add('completed');
            } else if (index === currentQuestionIndex) {
                step.classList.add('current');
            }
        });
    }

    function startGame() {
        playSound('click');
        startScreen.classList.add('hidden');
        gameScreen.classList.remove('hidden');
        initGame();
    }

    function loadNextQuestion() {
        if (currentQuestionIndex >= shuffledQuestions.length) {
            nextLevel();
            return;
        }

        hintUsed = false;
        hintBtn.disabled = false;
        hintBtn.style.opacity = '1';
        hintArea.textContent = '';
        
        updateBackground();
        updateLevelDisplay();

        const currentEvent = shuffledQuestions[currentQuestionIndex];
        
        // Differentiate question types based on level
        if (currentLevel === 'easy') {
            questionText.textContent = `Which of these events happened in the year ${currentEvent.year}?`;
        } else if (currentLevel === 'medium') {
            questionText.textContent = currentEvent.question;
        } else if (currentLevel === 'difficult') {
            questionText.textContent = currentEvent.question;
        }

        questionText.parentElement.style.animation = 'none';
        void questionText.parentElement.offsetWidth; // Trigger reflow
        questionText.parentElement.style.animation = 'flipIn 0.6s ease forwards';
        
        // Corrected to use the combined list of all questions to get wrong answers
        const wrongAnswers = allQuestions.filter(e => e.id !== currentEvent.id).sort(() => 0.5 - Math.random()).slice(0, 3);
        const options = [currentEvent, ...wrongAnswers].sort(() => 0.5 - Math.random());
        
        optionsContainer.innerHTML = '';
        options.forEach((option, index) => {
            const button = document.createElement('button');
            button.className = 'option-btn p-4 border-2 border-yellow-700/50 rounded-lg font-semibold';
            button.textContent = option.description;
            button.style.animationDelay = `${index * 100 + 300}ms`;
            button.onclick = () => { playSound('click'); checkAnswer(button, option.id === currentEvent.id, currentEvent); };
            optionsContainer.appendChild(button);
        });
        updateGamePath();
    }

    function nextLevel() {
        const levels = ['easy', 'medium', 'difficult'];
        const currentLevelIndex = levels.indexOf(currentLevel);
        
        if (currentLevelIndex < levels.length - 1) {
            // Show flowchart and prepare for next level
            flowchartTitle.textContent = `${currentLevel.charAt(0).toUpperCase() + currentLevel.slice(1)} Level Complete!`;
            flowchartContentEl.innerHTML = flowchartContent[currentLevel];
            flowchartModal.style.display = 'flex';
            
            // Set up next level
            currentLevel = levels[currentLevelIndex + 1];
            currentQuestionIndex = 0;
            shuffledQuestions = [...allEvents[currentLevel]].sort(() => 0.5 - Math.random());
            flowchartCloseBtn.textContent = `Continue to ${currentLevel.charAt(0).toUpperCase() + currentLevel.slice(1)} Level`;
            
        } else {
            // End the game
            endGame(true);
        }
    }

    function triggerEmojiRain(type) {
        // Updated to use actual emojis for celebrations and sadness
        const emojis = type === 'correct' ? ['üéâ', 'üåü', '‚ú®', 'üéà', 'üéä'] : ['üò≠', 'üò•', 'üíî', 'üò¢'];
        emojiRainContainer.innerHTML = '';
        for (let i = 0; i < 30; i++) {
            const emoji = document.createElement('span');
            emoji.className = 'emoji';
            emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            emoji.style.left = `${Math.random() * 100}vw`;
            emoji.style.animationDuration = `${Math.random() * 2 + 3}s`;
            emoji.style.animationDelay = `${Math.random() * 2}s`;
            emojiRainContainer.appendChild(emoji);
        }
    }
    
    function showCorrectAnswerPopup() {
        correctAnswerPopup.classList.remove('hidden');
        
        const sparkleContainer = document.getElementById('sparkle-container');
        sparkleContainer.innerHTML = '';
        for (let i = 0; i < 20; i++) {
            const sparkle = document.createElement('div');
            sparkle.className = 'sparkle';
            sparkle.style.top = `${Math.random() * 100}%`;
            sparkle.style.left = `${Math.random() * 100}%`;
            sparkle.style.animationDelay = `${Math.random() * 1}s`;
            sparkleContainer.appendChild(sparkle);
            sparkle.classList.add('animate');
        }

        setTimeout(() => {
            correctAnswerPopup.classList.add('hidden');
        }, 2000);
    }
    
    function triggerGandhiAnimation() {
        const el = gandhiCry;
        el.classList.add('animate');
        el.addEventListener('animationend', () => {
            el.classList.remove('animate');
        }, { once: true });
    }
    
    function checkAnswer(button, isCorrect, event) {
        const allButtons = Array.from(optionsContainer.querySelectorAll('.option-btn'));
        allButtons.forEach(btn => btn.disabled = true);

        if (isCorrect) {
            playSound('correct');
            showCorrectAnswerPopup();
            triggerEmojiRain('correct');
            updateScore(10);
            button.classList.add('correct-answer');
            setTimeout(() => showModal(`Correct Answer! ${event.year}`, event.details, event), 2500);
        } else {
            playSound('incorrect');
            triggerGandhiAnimation();
            triggerEmojiRain('incorrect');
            button.classList.add('incorrect-answer', 'animate-shake');
            lives--;
            updateLives();
            if (lives <= 0) {
                setTimeout(() => endGame(false), 1000);
            } else {
                setTimeout(() => {
                    button.classList.remove('incorrect-answer', 'animate-shake');
                    allButtons.forEach(btn => btn.disabled = false);
                }, 1000);
            }
        }
    }
    
    function showModal(title, text, event) {
        const modalContent = document.querySelector('#info-modal .modal-content');
        modalContent.classList.add('parchment-modal');
        modalContent.classList.remove('bg-purple-900', 'text-gray-200');
        modalTitle.textContent = title;
        modalText.textContent = text; 
        
        // Hide the continue button initially
        modalCloseBtn.style.display = 'none';

        modal.style.display = 'flex';
        
        // Show the button after 2 seconds
        setTimeout(() => {
            modalCloseBtn.style.display = 'inline-block';
        }, 2000);

        geminiContainer.classList.add('hidden');
        geminiResponse.classList.add('hidden');
        geminiLoader.classList.add('hidden');
        geminiBtn.disabled = false;
        geminiBtn.classList.remove('opacity-50');

        geminiBtn.onclick = () => fetchHiddenStory(event);
    }
    
    function endGame(isWin) {
        gameScreen.classList.add('hidden');
        endScreen.classList.remove('hidden');
        document.getElementById('final-score').textContent = score;
        if (isWin) {
            document.getElementById('end-title').textContent = "Congratulations!";
            document.getElementById('end-message').textContent = "You successfully completed the journey. Your final score is:";
        } else {
            document.getElementById('end-title').textContent = "Game Over!";
            document.getElementById('end-message').textContent = "Don't worry, try again! Your final score is:";
        }
    }

    function updateScore(points) {
        if(points > 0) score += points;
        scoreEl.textContent = score;
        if (points > 0) {
            scoreEl.classList.add('score-pulse');
            setTimeout(() => scoreEl.classList.remove('score-pulse'), 300);
        }
    }

    function updateLives() {
        livesEl.textContent = '‚ù§Ô∏è'.repeat(lives) + 'üñ§'.repeat(3 - lives);
    }
    
    function updateProgressBar() {
        const percentage = (currentQuestionIndex / allEvents[currentLevel].length) * 100;
        progressFill.style.width = `${percentage}%`;
    }

    async function callGeminiApi(prompt) {
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const payload = { contents: [{ parts: [{ text: prompt }] }] };
        try {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();
            return result.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, no story is available right now. Please try again later.";
        } catch (error) {
            console.error("API call failed:", error);
            return "Sorry, no story is available right now. Please try again later.";
        }
    }

    async function fetchHiddenStory(event) {
        playSound('click');
        geminiBtn.disabled = true;
        geminiBtn.classList.add('opacity-50');
        geminiLoader.classList.remove('hidden');
        geminiResponse.classList.add('hidden');
        geminiContainer.classList.remove('hidden');
        geminiResponse.textContent = ''; 
        const prompt = `Unveil a surprising, little-known, or intriguing secret fact about the "${event.description}" which happened in India in ${event.year}. Tell this fact as if you are a mystical narrator revealing a hidden truth. Keep it short and fascinating for a quiz game player.`;
        const story = await callGeminiApi(prompt);
        geminiLoader.classList.add('hidden');
        geminiResponse.textContent = story;
        geminiResponse.classList.remove('hidden');
        geminiResponse.classList.add('show');
    }

    // Now uses an internal function for instant hints
    function fetchHint(event) {
        playSound('click');
        hintBtn.disabled = true;
        hintBtn.style.opacity = '0.5';
        updateScore(-5);
        
        hintArea.textContent = event.hint;
        hintUsed = true;
    }

    startBtn.addEventListener('click', () => {
        Tone.start();
        startGame();
    });

    restartBtn.addEventListener('click', () => {
        playSound('click');
        endScreen.classList.add('hidden');
        startScreen.classList.remove('hidden');
    });
    
    modalCloseBtn.addEventListener('click', () => {
        playSound('click');
        modal.style.display = 'none';
        currentQuestionIndex++;
        updateProgressBar();
        loadNextQuestion();
    });
    
    flowchartCloseBtn.addEventListener('click', () => {
        playSound('click');
        flowchartModal.style.display = 'none';
        createGamePath(); // Re-create path for the new level
        loadNextQuestion();
    });

    soundToggle.addEventListener('click', () => {
        soundEnabled = !soundEnabled;
        soundToggle.textContent = soundEnabled ? 'üîä' : 'üîá';
    });

    // ‡§®‡§ø‡§ï‡§æ‡§∏ ‡§¨‡§ü‡§® ‡§á‡§µ‡•á‡§Ç‡§ü ‡§≤‡§ø‡§∏‡§®‡§∞ (Exit button event listener)
    exitBtn.addEventListener('click', () => {
        playSound('click');
        endGame(false); // ‡§ó‡•á‡§Æ ‡§ñ‡§§‡•ç‡§Æ ‡§ï‡§∞‡•á‡§Ç
    });
    
    hintBtn.addEventListener('click', () => {
        if (!hintUsed) {
            fetchHint(shuffledQuestions[currentQuestionIndex]);
        }
    });

    soundToggle.textContent = soundEnabled ? 'üîä' : 'üîá';
});
</script>
</body>
</html>