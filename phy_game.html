<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Newton's Nexus: A Physics Adventure</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Exo+2:wght@700&family=Poppins:wght@400;500;600;700&display=swap');

  :root {
    --primary-color: #4a69ff;
    --secondary-color: #00b0ff;
    --correct-color: #2ecc71;
    --incorrect-color: #e74c3c;
    --sparkle-color: #f1c40f;
    --card-bg-color: rgba(255, 255, 255, 0.98);
    --text-color: #2c3e50;
    --light-text-color: #555;
    --current-neon-color: #00f2fe;
  }

  body {
    font-family: 'Poppins', sans-serif;
    margin: 0;
    padding: 20px;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    color: var(--text-color);
    background: linear-gradient(-45deg, #2c3e50, #1a5276, #5b2c6f);
    background-size: 400% 400%;
    animation: gradientBG 15s ease infinite;
    overflow-x: hidden; /* Prevent horizontal overflow */
  }
  
  @keyframes gradientBG {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  #backgroundPattern {
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%; z-index: -1;
    overflow: hidden;
  }

  .bg-symbol {
    position: absolute;
    color: rgba(255, 255, 255, 0.5);
    font-family: 'Times New Roman', serif;
    animation: floatUp 20s linear infinite;
    user-select: none;
    pointer-events: none;
  }

  @keyframes floatUp {
    0% { transform: translateY(110vh) rotate(0deg); opacity: 0; }
    10%, 90% { opacity: 1; }
    100% { transform: translateY(-10vh) rotate(360deg); opacity: 0; }
  }

  #gameContainer {
    width: 90%;
    max-width: 800px; 
    padding: 35px 40px;
    background: var(--card-bg-color); 
    border-radius: 24px;
    box-shadow: 0 0 15px var(--current-neon-color), 0 20px 60px rgba(0,0,0,0.15);
    text-align: center;
    position: relative; 
    z-index: 1;
    border: 1px solid rgba(255,255,255,0.5);
    animation: neon-border-pulse 2s infinite ease-in-out;
    box-sizing: border-box; /* Include padding in the element's total width and height */
  }
  
  @keyframes neon-border-pulse {
    0%, 100% { box-shadow: 0 0 15px var(--current-neon-color), 0 20px 60px rgba(0,0,0,0.15); }
    50% { box-shadow: 0 0 30px var(--current-neon-color), 0 20px 60px rgba(0,0,0,0.15); }
  }

  #gameContainer.shake-hard { animation: shake-hard 0.5s ease-in-out; }

  h1 { 
    font-family: 'Exo 2', sans-serif;
    font-size: 3.2em; 
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 5px; 
    letter-spacing: 1.5px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
  }
  p { color: var(--light-text-color); font-size: 1.1em; font-weight: 500;}

  #infoBar {
    display: flex; justify-content: space-around; font-size: 1.2em; font-weight: 700;
    margin-bottom: 15px;
    color: var(--text-color);
  }

  #scoreBoard.score-updated {
    animation: score-pop 0.5s ease-in-out;
  }
  @keyframes score-pop {
    0% { transform: scale(1); }
    50% { transform: scale(1.25); color: var(--correct-color); }
    100% { transform: scale(1); }
  }
  
  #timerDisplay {
    font-size: 1.5em;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 10px;
  }
  #timerDisplay.low-time {
    color: var(--incorrect-color);
    animation: pulse-danger 1s infinite;
  }
  @keyframes pulse-danger {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }


  #progressBarContainer {
    width: 100%; height: 12px; background-color: #e0e0e0;
    border-radius: 6px; margin: 25px 0;
    overflow: hidden;
  }

  #progressBar {
    width: 0%; height: 100%;
    background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
    border-radius: 6px; transition: width 0.5s ease-in-out;
  }

  #questionContainer {
    padding: 20px; margin: 25px 0;
    background: rgba(61, 90, 254, 0.05);
    border-left: 5px solid var(--primary-color);
    border-radius: 8px; text-align: left; font-size: 1.1em;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  #questionContainer:hover {
      transform: translateY(-5px);
      box-shadow: 0 0 15px var(--current-neon-color), 0 10px 20px rgba(0,0,0,0.05);
  }
  #questionContainer.new-level { animation: slideInDown 0.6s ease-out forwards; }
  
  @keyframes slideInDown {
    from { transform: translateY(-30px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  
  #questionText {
    font-weight: 600;
    font-size: 1.15em;
    line-height: 1.5;
  }

  #levelInfo { font-weight: 700; color: var(--primary-color); margin-bottom: 10px; }
  #answerContainer { margin: 20px 0; display: flex; justify-content: center; align-items: center; gap: 15px; }

  #answerContainer label {
    font-weight: 700;
  }

  #userAnswer {
    padding: 12px; font-size: 18px; border-radius: 8px;
    border: 2px solid #ccc;
    background-color: #fff;
    color: var(--text-color);
    width: 180px; text-align: center;
    transition: all 0.3s ease;
    box-shadow: 0 0 10px var(--current-neon-color);
  }
  #userAnswer:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 15px rgba(61, 90, 254, 0.5); 
    animation: input-glow 1.5s infinite alternate;
    outline: none;
  }
  @keyframes input-glow {
      from { box-shadow: 0 0 5px var(--current-neon-color), 0 0 5px rgba(61, 90, 254, 0.3); }
      to { box-shadow: 0 0 20px var(--current-neon-color), 0 0 20px rgba(61, 90, 254, 0.6); }
  }

  .correct { border-color: var(--correct-color) !important; animation: none !important; box-shadow: 0 0 15px var(--correct-color) !important; }
  .incorrect { animation: shake 0.4s ease-in-out; border-color: var(--incorrect-color) !important; }

  @keyframes shake {
    0%, 100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); }
  }
  @keyframes shake-hard {
    0%, 100% { transform: translate(0, 0); }
    10%, 30%, 50%, 70%, 90% { transform: translate(-5px, 5px); }
    20%, 40%, 60%, 80% { transform: translate(5px, -5px); }
  }

  #unitText { font-size: 1.2em; font-weight: bold; }

  .controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    margin-top: 25px;
  }

  .control-btn {
    padding: 14px 25px; font-size: 1em; font-weight: 600; cursor: pointer;
    border-radius: 10px; 
    border: none;
    background: var(--primary-color);
    color: white; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
  }
  .control-btn.hidden { display: none; }
  .control-btn.disabled { opacity: 0.6; cursor: not-allowed; }

  .control-btn:hover { 
      transform: translateY(-3px) scale(1.02); 
      box-shadow: 0 6px 20px rgba(0,0,0,0.2), 0 0 15px var(--current-neon-color);
  }
  .control-btn:active { transform: translateY(-1px) scale(0.98); }
  
  .control-btn.quit { 
      background-color: var(--incorrect-color);
  }
  
  .control-btn.hint { 
      background-color: #ffc107;
      color: #333;
      position: relative;
  }

  .hint-cost {
    position: absolute;
    top: -10px;
    right: -10px;
    background-color: #e74c3c;
    color: white;
    font-size: 0.7em;
    font-weight: 700;
    padding: 3px 6px;
    border-radius: 50%;
    border: 2px solid white;
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
  }


  .control-btn.next-level-glow { animation: pulse-glow 1.5s infinite ease-in-out; }
  @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 4px 15px rgba(61, 90, 254, 0.4); transform: scale(1); }
      50% { box-shadow: 0 6px 25px rgba(0, 176, 255, 0.7); transform: scale(1.05); }
  }

  .control-btn:disabled { 
      background: #aaa;
      cursor: not-allowed; 
      transform: none; 
      box-shadow: none; 
      animation: none; 
  }
  
  #status { margin-top: 15px; font-weight: bold; font-size: 1.2em; min-height: 25px; }

  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center;
    align-items: center; z-index: 1000; opacity: 0; visibility: hidden;
    transition: all 0.3s ease;
  }
  .modal-overlay.show { opacity: 1; visibility: visible; }
  
  .modal-content {
    background: white; 
    color: var(--text-color);
    padding: 40px; border-radius: 15px; text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    width: 90%; max-width: 450px;
    transform: scale(0.9); transition: all 0.3s ease;
  }
  .modal-overlay.show .modal-content { transform: scale(1); }
  
  #introModal .modal-content, #quitModal .modal-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: linear-gradient(180deg, #ffffff 0%, #f7f8fc 100%);
    border-radius: 24px;
    border: 1px solid rgba(255, 255, 255, 0.8);
    box-shadow: 0 0 15px var(--current-neon-color), 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  }

  #introCharacter {
    width: 150px;
    margin-bottom: 20px;
    transform: scale(0.5);
    opacity: 0;
    animation: popInCharacter 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) 0.3s forwards;
  }
  
  @keyframes popInCharacter {
      from { transform: scale(0.5) translateY(20px); opacity: 0; }
      to { transform: scale(1) translateY(0); opacity: 1; }
  }
  
  #introDialogue {
    font-size: 1.2em;
    font-weight: 500;
    color: var(--text-color);
    min-height: 80px;
    opacity: 0;
    animation: fadeInText 0.5s ease-out 0.8s forwards;
  }

  @keyframes fadeInText {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
  }

  #startBtn {
      margin-top: 20px;
      opacity: 0;
      animation: fadeInText 0.5s ease-out 1s forwards;
  }
  
  #confettiCanvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 9999;
  }

  #explosionContainer, #feedbackPopup {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none; z-index: 999;
  }
  
  #feedbackPopup {
    display: flex; justify-content: center; align-items: center;
    font-size: 4.5em; font-weight: 700; color: var(--sparkle-color);
    text-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
    opacity: 0; transform: scale(0.5);
    transition: all 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
  }
  #feedbackPopup.show { transform: scale(1); opacity: 1; }
  
  #explosionContainer { display: none; }
  #explosion {
    width: 10px; height: 10px;
    background-color: orange; border-radius: 50%;
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0);
  }
  #explosion.explode { animation: explode 0.5s ease-out forwards; }
  
  @keyframes explode {
    0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
    50% { background-color: red; }
    100% { transform: translate(-50%, -50%) scale(30); opacity: 0; }
  }

  #helperContainer {
    position: absolute; bottom: 0px; left: 10px;
    width: 200px; height: 160px; opacity: 0;
    transition: opacity 0.5s ease-in-out;
  }
  #helperContainer.visible { opacity: 1; }

  #speechBubble {
    position: absolute; background: #e9e9e9; border: 1px solid #ccc; border-radius: 12px;
    padding: 12px 15px; bottom: 105px; left: 45px;
    width: 150px; font-size: 0.9em; font-weight: 600;
    color: var(--light-text-color); transform-origin: bottom left;
    animation: popIn 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards;
  }

  @keyframes popIn {
    from { transform: scale(0); opacity: 0;}
    to { transform: scale(1); opacity: 1;}
  }

  #speechBubble::after {
    content: ''; position: absolute; bottom: -10px; left: 20px;
    width: 0; height: 0; border: 12px solid transparent;
    border-top-color: #e9e9e9; border-bottom: 0; border-left: 0;
  }

  #helperCharacter {
    position: absolute; bottom: 5px; left: 0px;
    width: 120px; height: 100px;
  }
  .character-g .mouth-happy, .character-g .mouth-sad { display: none; }
  #helperCharacter.happy .mouth-happy { display: block; }
  #helperCharacter.happy .mouth-neutral, #helperCharacter.happy .mouth-sad { display: none; }
  #helperCharacter.sad .mouth-sad { display: block; }
  #helperCharacter.sad .mouth-neutral, #helperCharacter.sad .mouth-happy { display: none; }

  #helperCharacter.jumping { animation: jump 0.6s ease-out; }
  #helperCharacter.scared { animation: scared 0.4s ease-in-out; }
  #helperCharacter.idle { animation: float 3s ease-in-out infinite; }
  
  @keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
  }
  @keyframes jump {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    50% { transform: translateY(-30px) rotate(10deg); }
  }
  @keyframes scared {
    0%, 100% { transform: translateX(0); }
    20% { transform: translateX(-5px) rotate(-3deg); }
    40% { transform: translateX(5px) rotate(3deg); }
    60% { transform: translateX(-5px) rotate(-3deg); }
    80% { transform: translateX(5px) rotate(3deg); }
  }
  
  @media (max-width: 600px) {
    body { padding: 10px; }
    #gameContainer { padding: 20px; }
    h1 { font-size: 2.2em; }
    p { font-size: 1em; }
    #answerContainer { flex-direction: column; gap: 10px; }
    #helperContainer { 
      bottom: -15px; 
      left: 5%; /* Adjusted for better responsiveness */
      transform: scale(0.8);
      transform-origin: bottom left;
    }
  }

</style>
</head>
<body>
<div id="backgroundPattern"></div>
<canvas id="confettiCanvas"></canvas>

<div id="gameContainer">
  <div id="feedbackPopup">Correct!</div>
  <div id="explosionContainer"><div id="explosion"></div></div>

  <h1>Newton's Nexus</h1>
  <p>Solve the numericals and master physics!</p>

  <div class="grade-selector-container" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 15px;">
    <label for="grade-select" style="font-weight: 600;">Select Grade:</label>
    <select id="grade-select" class="control-btn" style="padding: 8px 15px; font-size: 1em; background: #fff; color: var(--text-color); border: 2px solid var(--primary-color); box-shadow: none;">
      <option value="9">9th Grade</option>
      <option value="10">10th Grade</option>
      <option value="11">11th Grade</option>
      <option value="12">12th Grade</option>
    </select>
  </div>
  
  <div id="infoBar">
    <div id="scoreBoard">Score: 0</div>
    <div id="levelIndicator">Level: Easy</div>
    <div id="timerDisplay">Time: 60s</div>
  </div>

  <div id="progressBarContainer"><div id="progressBar"></div></div>

  <div id="questionContainer">
    <div id="levelInfo"></div>
    <p id="questionText"></p>
  </div>

  <div id="answerContainer">
    <label for="userAnswer">Your Answer:</label>
    <input type="number" id="userAnswer" placeholder="Enter value">
    <span id="unitText"></span>
  </div>

  <div class="controls">
    <button class="control-btn" id="checkBtn">Check Answer</button>
    <button class="control-btn hint" id="hintBtn">💡 Hint <span class="hint-cost">-25</span></button>
    <button class="control-btn hidden" id="nextLevelBtn">Next Level</button>
    <button class="control-btn quit" id="quitBtn">Quit Game</button>
  </div>
  
  <div id="status"></div>
  
  <div id="helperContainer">
    <div id="speechBubble"></div>
    <div id="helperCharacter" class="idle">
      <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
          <g class="character-g" transform="translate(0 20)">
              <path fill="#333" d="M 50,70 C 20,20 180,20 150,70 Q 100,90 50,70 Z" />
              <path fill="#FFDDC1" d="M 60,60 C 60,120 140,120 140,60 Q 100,40 60,60 Z" />
              <circle fill="#fff" cx="85" cy="80" r="12" /><circle fill="#fff" cx="115" cy="80" r="12" />
              <circle fill="#333" cx="85" cy="80" r="6" /><circle fill="#333" cx="115" cy="80" r="6" />
              <path class="mouth-neutral" fill="none" stroke="#333" stroke-width="3" stroke-linecap="round" d="M 95,105 Q 100,110 105,105" />
              <path class="mouth-happy" fill="none" stroke="#333" stroke-width="3" stroke-linecap="round" d="M 90,105 Q 100,125 110,105" />
              <path class="mouth-sad" fill="none" stroke="#333" stroke-width="3" stroke-linecap="round" d="M 90,115 Q 100,105 110,115" />
              <path fill="#3d5afe" d="M 70,120 L 130,120 C 140,160 60,160 70,120 Z" />
          </g>
      </svg>
    </div>
  </div>

</div>

<div id="introModal" class="modal-overlay show">
    <div class="modal-content">
        <div id="introCharacter">
            <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                <g transform="translate(0 20)">
                    <path fill="#333" d="M 50,70 C 20,20 180,20 150,70 Q 100,90 50,70 Z" />
                    <path fill="#FFDDC1" d="M 60,60 C 60,120 140,120 140,60 Q 100,40 60,60 Z" />
                    <circle fill="#fff" cx="85" cy="80" r="12" /><circle fill="#fff" cx="115" cy="80" r="12" />
                    <circle fill="#333" cx="85" cy="80" r="6" /><circle fill="#333" cx="115" cy="80" r="6" />
                    <circle fill="#FF9A9E" fill-opacity="0.6" cx="70" cy="95" r="8" />
                    <circle fill="#FF9A9E" fill-opacity="0.6" cx="130" cy="95" r="8" />
                    <path fill="none" stroke="#333" stroke-width="3" stroke-linecap="round" d="M 95,105 Q 100,115 105,105" />
                    <path fill="#3d5afe" d="M 70,120 L 130,120 C 140,160 60,160 70,120 Z" />
                </g>
            </svg>
        </div>
        <p id="introDialogue"></p>
        <button id="startBtn" class="control-btn"></button>
    </div>
</div>

<div id="gameOverModal" class="modal-overlay">
    <div class="modal-content">
        <h2>Game Over</h2>
        <p id="correctAnswerInfo"></p>
        <p id="finalScore"></p>
        <button id="tryAgainBtn" class="control-btn">Try Again</button>
    </div>
</div>

<div id="quitModal" class="modal-overlay">
    <div class="modal-content">
        <h2>Are you sure you want to quit?</h2>
        <p>Your current progress will be lost. The correct answer for this question will be revealed.</p>
        <div class="controls">
          <button id="confirmQuitBtn" class="control-btn quit">Yes, Quit</button>
          <button id="cancelQuitBtn" class="control-btn">No, Cancel</button>
        </div>
    </div>
</div>

<script>
  const allDOM = {
      checkBtn: document.getElementById('checkBtn'), nextLevelBtn: document.getElementById('nextLevelBtn'),
      quitBtn: document.getElementById('quitBtn'), status: document.getElementById('status'),
      scoreBoard: document.getElementById('scoreBoard'), levelInfo: document.getElementById('levelInfo'),
      levelIndicator: document.getElementById('levelIndicator'), questionContainer: document.getElementById('questionContainer'),
      questionText: document.getElementById('questionText'), userAnswer: document.getElementById('userAnswer'),
      unitText: document.getElementById('unitText'), introModal: document.getElementById('introModal'),
      startBtn: document.getElementById('startBtn'), gameOverModal: document.getElementById('gameOverModal'),
      finalScore: document.getElementById('finalScore'), correctAnswerInfo: document.getElementById('correctAnswerInfo'),
      tryAgainBtn: document.getElementById('tryAgainBtn'), progressBar: document.getElementById('progressBar'),
      canvas: document.getElementById('confettiCanvas'), gameContainer: document.getElementById('gameContainer'),
      feedbackPopup: document.getElementById('feedbackPopup'), explosionContainer: document.getElementById('explosionContainer'),
      explosion: document.getElementById('explosion'), 
      speechBubble: document.getElementById('speechBubble'), helperContainer: document.getElementById('helperContainer'),
      introDialogue: document.getElementById('introDialogue'), helperCharacter: document.getElementById('helperCharacter'),
      hintBtn: document.getElementById('hintBtn'), quitModal: document.getElementById('quitModal'),
      confirmQuitBtn: document.getElementById('confirmQuitBtn'), cancelQuitBtn: document.getElementById('cancelQuitBtn'),
      gradeSelect: document.getElementById('grade-select'),
      timerDisplay: document.getElementById('timerDisplay'),
  };
  const ctx = allDOM.canvas.getContext('2d');
  
  let score = 0;
  let currentLevel = 1;
  let currentGrade = 9;
  let sounds;
  let introDialogueIndex = 0;
  let isAnimatingConfetti = false;
  let timerInterval;
  let timeRemaining;
  const baseTime = 60;

  const introDialogues = [
    { text: "Hello! Will you help me with my physics questions?", button: "Of course!" },
    { text: "For each level, a question will appear. Type your answer and click 'Check'!", button: "Got it!" },
    { text: "Let's test our skills and become physics masters!", button: "Let's start!" }
  ];

  const compliments = ["Wow, you're a genius!", "Incredible!", "Amazing!", "Physics pro!", "You got it!", "Brilliant!"];
  
  const backgroundGradients = [
    'linear-gradient(-45deg, #2c3e50, #1a5276, #5b2c6f)',
    'linear-gradient(-45deg, #f6d365, #fda085)',
    'linear-gradient(-45deg, #d4fc79, #96e6a1)',
    'linear-gradient(-45deg, #89f7fe, #66a6ff)',
    'linear-gradient(-45deg, #ff9a9e, #fecfef)',
    'linear-gradient(-45deg, #a1c4fd, #c2e9fb)',
    'linear-gradient(-45deg, #667eea, #764ba2)',
    'linear-gradient(-45deg, #ff758c, #ff7eb3)',
    'linear-gradient(-45deg, #2af598, #009efd)',
    'linear-gradient(-45deg, #f093fb, #f5576c)',
    'linear-gradient(-45deg, #5ee7df, #b490ca)',
    'linear-gradient(-45deg, #fa709a, #fee140)',
    'linear-gradient(-45deg, #4facfe, #00f2fe)',
    'linear-gradient(-45deg, #43e97b, #38f9d7)',
    'linear-gradient(-45deg, #fdbb2d, #22c1c3)'
  ];

  const neonColors = [
      '#00f2fe', '#ff00e6', '#9aff00', '#ff8c00', '#ff00c6', '#00ffc6', '#c6ff00', '#ffc600', '#ff0036', '#36ff00'
  ];

  const allLevels = {
    '9': [
      // Easy Section (Levels 1-5)
      { level: 1, topic: "Force", difficulty: "Easy", question: "A body of mass 10 kg is pushed with a force of 50 N. What is the acceleration produced?", unit: 'm/s²', givens: { mass: 10, force: 50 }, correctAnswer: function() { return this.givens.force / this.givens.mass; }, hint: "Use Newton's Second Law: Force = Mass x Acceleration (F=ma)." },
      { level: 2, topic: "Gravitation", difficulty: "Easy", question: "An object is dropped from a height. If its final velocity is 20 m/s, what height was it dropped from? (Take g=10 m/s²)", unit: 'm', givens: { v: 20, g: 10 }, correctAnswer: function() { return (this.givens.v**2) / (2 * this.givens.g); }, hint: "Use the third kinematic equation: v^2 = u^2 + 2as. Here, u=0 and a=g." },
      { level: 3, topic: "Work and Energy", difficulty: "Easy", question: "A 15 kg object is lifted to a height of 10 meters. What is the work done against gravity? (Take g=10 m/s²)", unit: 'J', givens: { mass: 15, height: 10, g: 10 }, correctAnswer: function() { return this.givens.mass * this.givens.g * this.givens.height; }, hint: "Work done is equal to the change in potential energy: W=mgh." },
      { level: 4, topic: "Kinetic Energy", difficulty: "Easy", question: "A car with a mass of 1000 kg is traveling at a speed of 30 m/s. What is its kinetic energy?", unit: 'J', givens: { mass: 1000, velocity: 30 }, correctAnswer: function() { return 0.5 * this.givens.mass * this.givens.velocity**2; }, hint: "The formula for kinetic energy is: KE = 0.5 * m * v^2." },
      { level: 5, topic: "Pressure", difficulty: "Easy", question: "A force of 100 N is applied on an area of 5 m². What is the pressure exerted?", unit: 'Pa', givens: { force: 100, area: 5 }, correctAnswer: function() { return this.givens.force / this.givens.area; }, hint: "Pressure is Force per unit Area." },
      
      // Moderate Section (Levels 6-10)
      { level: 6, topic: "Force", difficulty: "Moderate", question: "A 50 N force is applied to a 10 kg box. A frictional force of 10 N opposes the motion. What is the net acceleration?", unit: 'm/s²', givens: { appliedForce: 50, mass: 10, frictionForce: 10 }, correctAnswer: function() { return (this.givens.appliedForce - this.givens.frictionForce) / this.givens.mass; }, hint: "Net Force is the key. It's the Applied Force minus the Friction. (a=F_net/m)" },
      { level: 7, topic: "Kinematics", difficulty: "Moderate", question: "A car starts from rest and accelerates uniformly at 4 m/s². How much time does it take to cover 50 meters?", unit: 's', givens: { acceleration: 4, distance: 50 }, correctAnswer: function() { return Math.sqrt(2 * this.givens.distance / this.givens.acceleration); }, hint: "Use the kinematic equation: d = (1/2)at^2." },
      { level: 8, topic: "Energy Conservation", difficulty: "Moderate", question: "An 8 kg object is dropped from a height of 20m. What is its velocity just before hitting the ground? (Take g=10 m/s²)", unit: 'm/s', givens: { mass: 8, height: 20, g: 10 }, correctAnswer: function() { return Math.sqrt(2 * this.givens.g * this.givens.height); }, hint: "Potential energy at the top (mgh) is converted into kinetic energy at the bottom (0.5mv^2)." },
      { level: 9, topic: "Power", difficulty: "Moderate", question: "A crane lifts a 200 kg crate 15 meters high in 6 seconds at a constant velocity. What is the power output of the crane? (Take g=10 m/s²)", unit: 'Watts', givens: { mass: 200, height: 15, time: 6, g: 10 }, correctAnswer: function() { const work = this.givens.mass * this.givens.g * this.givens.height; return work / this.givens.time; }, hint: "Power is Work done per unit time. Work to lift the crate is W=mgh." },
      { level: 10, topic: "Momentum", difficulty: "Moderate", question: "A 5 kg ball moving at 4 m/s collides with a 15 kg stationary object. If they stick together, what is their final velocity?", unit: 'm/s', givens: { m1: 5, v1: 4, m2: 15, v2: 0 }, correctAnswer: function() { return (this.givens.m1 * this.givens.v1 + this.givens.m2 * this.givens.v2) / (this.givens.m1 + this.givens.m2); }, hint: "Use the law of conservation of momentum: m1v1 + m2v2 = (m1+m2)vf." },

      // Difficult Section (Levels 11-15)
      { level: 11, topic: "Advanced Dynamics", difficulty: "Difficult", question: "A force gives a 25 kg mass an acceleration of 4 m/s². What is the mass of another object if the same force gives it an acceleration of 10 m/s²?", unit: 'kg', givens: { mass1: 25, acc1: 4, acc2: 10 }, correctAnswer: function() { const force = this.givens.mass1 * this.givens.acc1; return force / this.givens.acc2; }, hint: "The force is the same in both scenarios. Calculate it for the first object, then use it for the second. (F1 = F2)" },
      { level: 12, topic: "Work-Energy Theorem", difficulty: "Difficult", question: "What is the final velocity of a 15 kg box, initially at rest, after being pushed for 10 meters by a 30 N force?", unit: 'm/s', givens: { force: 30, mass: 15, distance: 10 }, correctAnswer: function() { return Math.sqrt(2 * this.givens.force * this.givens.distance / this.givens.mass); }, hint: "Work done (W=F * d) equals the change in kinetic energy (ΔKE = 0.5mv^2)." },
      { level: 13, topic: "Impulse-Momentum", difficulty: "Difficult", question: "A 50 N force is applied to a 10 kg box for 3 seconds. What is the change in its velocity?", unit: 'm/s', givens: { force: 50, mass: 10, time: 3 }, correctAnswer: function() { return (this.givens.force * this.givens.time) / this.givens.mass; }, hint: "Impulse (J=F * t) equals the change in momentum (p=mΔv)." },
      { level: 14, topic: "Projectile Motion", difficulty: "Difficult", question: "A ball is thrown at 30 m/s at an angle of 30°. What is the maximum height it reaches? (Take g=10 m/s²)", unit: 'm', givens: { v: 30, angle: 30, g: 10 }, correctAnswer: function() { const v_y = this.givens.v * Math.sin(this.givens.angle * Math.PI / 180); return v_y**2 / (2 * this.givens.g); }, hint: "Find the initial vertical velocity (v_y = v sin theta), then use v_y^2 = 2gh." },
      { level: 15, topic: "Fluid Mechanics", difficulty: "Difficult", question: "A submerged object displaces 20 kg of water. What is the buoyant force acting on it? (Take g=10 m/s²)", unit: 'N', givens: { displaced_mass: 20, g: 10 }, correctAnswer: function() { return this.givens.displaced_mass * this.givens.g; }, hint: "The buoyant force is equal to the weight of the fluid displaced by the object. (Buoyant Force = m_displaced * g)" }
    ],
    '10': [
      { level: 1, topic: "Electricity", difficulty: "Easy", question: "A bulb connected to a 12V battery draws a current of 2A. What is the resistance of the bulb filament?", unit: 'Ω', givens: { V: 12, I: 2 }, correctAnswer: function() { return this.givens.V / this.givens.I; }, hint: "Use Ohm's Law: V = IR." },
      { level: 2, topic: "Electricity", difficulty: "Easy", question: "A combination of resistors is connected to a 6V battery. If the total current is 0.5A, what is the equivalent resistance of the combination?", unit: 'Ω', givens: { V: 6, I: 0.5 }, correctAnswer: function() { return this.givens.V / this.givens.I; }, hint: "The equivalent resistance is the ratio of total voltage to total current. (R_eq = V_total / I_total)." },
      { level: 3, topic: "Light", difficulty: "Moderate", question: "An object is placed 20 cm in front of a concave mirror with a focal length of 15 cm. Find the image distance.", unit: 'cm', givens: { u: -20, f: -15 }, correctAnswer: function() { return 1 / ((1 / this.givens.f) - (1 / this.givens.u)); }, hint: "Use the mirror formula: 1/f = 1/v + 1/u. Remember to use sign conventions." },
      { level: 4, topic: "Light", difficulty: "Difficult", question: "An object is placed 10 cm in front of a convex lens of focal length 15 cm. Find the magnification of the image.", unit: '', givens: { u: -10, f: 15 }, correctAnswer: function() { const v = 1 / ((1 / this.givens.f) - (1 / this.givens.u)); return -v / this.givens.u; }, hint: "First, find the image distance (v) using the lens formula: 1/f = 1/v - 1/u. Then find magnification (m): m = -v/u." }
    ],
    '11': [
      { level: 1, topic: "Kinematics", difficulty: "Easy", question: "A car starts from rest and accelerates uniformly at 3 m/s². What is its velocity after it has covered a distance of 15 m?", unit: 'm/s', givens: { u: 0, a: 3, s: 15 }, correctAnswer: function() { return Math.sqrt(this.givens.u**2 + 2 * this.givens.a * this.givens.s); }, hint: "Use the kinematic equation: v^2 = u^2 + 2as." },
      { level: 2, topic: "Work, Energy & Power", difficulty: "Moderate", question: "A 5 kg block is pulled by a 40 N force. Over 8 meters, its speed increases from 2 m/s to 6 m/s. What is the force of friction?", unit: 'N', givens: { mass: 5, force: 40, dist: 8, v_i: 2, v_f: 6 }, correctAnswer: function() { const W_app = this.givens.force * this.givens.dist; const d_KE = 0.5 * this.givens.mass * (this.givens.v_f**2 - this.givens.v_i**2); return (W_app - d_KE) / this.givens.dist; }, hint: "Net work done equals the change in kinetic energy. Net work is (F_app - F_f) x d." },
      { level: 3, topic: "Projectile Motion", difficulty: "Moderate", question: "A ball is thrown at 30 m/s at an angle of 30°. What is the maximum height it reaches? (Take g=10 m/s²)", unit: 'm', givens: { v: 30, angle: 30, g: 10 }, correctAnswer: function() { const v_y = this.givens.v * Math.sin(this.givens.angle * Math.PI / 180); return v_y**2 / (2 * this.givens.g); }, hint: "Find the initial vertical velocity (v_y = v sin theta), then use v_y^2 = 2gh." },
      { level: 4, topic: "Rotational Motion", difficulty: "Difficult", question: "A wheel rotates with an angular acceleration of 2 rad/s². If it starts from rest, what is its angular velocity after 5 seconds?", unit: 'rad/s', givens: { alpha: 2, time: 5, omega_i: 0 }, correctAnswer: function() { return this.givens.omega_i + this.givens.alpha * this.givens.time; }, hint: "The formula for angular velocity is: omega_f = omega_i + alpha * t." }
    ],
    '12': [
      { level: 1, topic: "Electrostatics", difficulty: "Easy", question: "Two point charges, q1 = 5 uC and q2 = 3 uC, are separated by 20 cm. What is the electrostatic force between them? (Take k=9 x 10^9 Nm^2/C^2)", unit: 'N', givens: { q1: 5e-6, q2: 3e-6, r: 0.20, k: 9e9 }, correctAnswer: function() { return this.givens.k * this.givens.q1 * this.givens.q2 / (this.givens.r**2); }, hint: "Use Coulomb's Law: F = k (q1 q2 / r^2)." },
      { level: 2, topic: "Current Electricity", difficulty: "Moderate", question: "A circuit has a 10 Ω resistor in series with a parallel combination of 20 Ω and 30 Ω resistors. What is the total equivalent resistance?", unit: 'Ω', givens: { R1: 10, R2: 20, R3: 30 }, correctAnswer: function() { const parallelEq = (this.givens.R2 * this.givens.R3) / (this.givens.R2 + this.givens.R3); return this.givens.R1 + parallelEq; }, hint: "First find the equivalent resistance of the parallel combination, then add the series resistor." },
      { level: 3, topic: "Modern Physics", difficulty: "Moderate", question: "What is the de Broglie wavelength of a proton moving at a speed of 1.5 x 10^7 m/s? (Take mass of proton = 1.67 x 10^-27 kg and Planck's constant h = 6.63 x 10^-34 J * s)", unit: 'm', givens: { h: 6.63e-34, m: 1.67e-27, v: 1.5e7 }, correctAnswer: function() { return this.givens.h / (this.givens.m * this.givens.v); }, hint: "The de Broglie wavelength is given by the formula: lambda = h/p, where p is momentum (p=mv)." },
      { level: 4, topic: "Atomic Physics", difficulty: "Difficult", question: "The total energy of an electron in the first excited state (n=2) of a hydrogen atom is -3.4 eV. What is its kinetic energy in this state?", unit: 'eV', givens: { E_total: -3.4 }, correctAnswer: function() { return -this.givens.E_total; }, hint: "In a hydrogen atom, the kinetic energy is equal to the negative of the total energy: KE = -E_total." }
    ]
  };

  function updateIntroDialogue() {
    allDOM.introDialogue.textContent = introDialogues[introDialogueIndex].text;
    allDOM.startBtn.textContent = introDialogues[introDialogueIndex].button;
  }

  function initializeSounds() {
      sounds = {
          correct: new Tone.Synth().toDestination(), incorrect: new Tone.Synth({ oscillator: { type: 'square' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 } }).toDestination(),
          click: new Tone.Synth().toDestination(), explosion: new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.2 } }).toDestination()
      };
      sounds.correct.volume.value = -6; sounds.incorrect.volume.value = -6;
      sounds.click.volume.value = -12; sounds.explosion.volume.value = -3;
  }
  
  const startTimer = () => {
    clearInterval(timerInterval);
    timeRemaining = Math.max(20, baseTime - (currentLevel - 1) * 5);
    allDOM.timerDisplay.textContent = `Time: ${timeRemaining}s`;
    allDOM.timerDisplay.classList.remove('low-time');
    timerInterval = setInterval(() => {
        timeRemaining--;
        allDOM.timerDisplay.textContent = `Time: ${timeRemaining}s`;
        if (timeRemaining <= 10) {
            allDOM.timerDisplay.classList.add('low-time');
        }
        if (timeRemaining <= 0) {
            endGame('Time is up!');
        }
    }, 1000);
  };
  
  const stopTimer = () => {
      clearInterval(timerInterval);
  };

  function showHint() {
      const currentLevelData = allLevels[currentGrade][currentLevel - 1];
      if (!currentLevelData || !currentLevelData.hint) return;

      updateBubbleText(currentLevelData.hint);
      
      if (score >= 25) {
          score -= 25;
          allDOM.scoreBoard.textContent = `Score: ${score}`;
          allDOM.scoreBoard.classList.add('score-updated');
          allDOM.scoreBoard.style.color = 'var(--incorrect-color)';
          allDOM.scoreBoard.addEventListener('animationend', () => {
              allDOM.scoreBoard.classList.remove('score-updated');
              allDOM.scoreBoard.style.color = '';
          }, { once: true });
      }
      
      allDOM.hintBtn.disabled = true;
      allDOM.hintBtn.classList.add('disabled');
  }

  function updateBubbleText(text) {
    if (allDOM.speechBubble) {
        allDOM.speechBubble.textContent = text;
        allDOM.speechBubble.style.animation = 'none';
        void allDOM.speechBubble.offsetWidth; // Trigger reflow
        allDOM.speechBubble.style.animation = 'popIn 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards';
    }
  }

  function loadLevel(levelNum) {
    const levelsForGrade = allLevels[currentGrade];
    const level = levelsForGrade[levelNum - 1];
    
    document.body.style.background = backgroundGradients[(levelNum - 1) % backgroundGradients.length];
    const neonColor = neonColors[(levelNum - 1) % neonColors.length];
    document.documentElement.style.setProperty('--current-neon-color', neonColor);

    if (!level) {
        allDOM.status.textContent = 'Congratulations! You have completed all levels! 🎉';
        triggerConfetti();
        updateBubbleText('You are a Physics Master!');
        allDOM.helperCharacter.className = 'jumping happy';
        allDOM.checkBtn.classList.add('hidden');
        allDOM.nextLevelBtn.classList.add('hidden');
        allDOM.userAnswer.disabled = true;
        allDOM.hintBtn.classList.add('hidden');
        stopTimer();
        return;
    }
    
    updateBubbleText('Help me solve this one!');
    allDOM.status.textContent = '';
    allDOM.userAnswer.value = '';
    allDOM.userAnswer.disabled = false;
    allDOM.userAnswer.className = '';
    allDOM.checkBtn.classList.remove('hidden');
    allDOM.nextLevelBtn.classList.add('hidden');
    allDOM.nextLevelBtn.classList.remove('next-level-glow');
    allDOM.checkBtn.disabled = false;
    allDOM.hintBtn.disabled = false;
    allDOM.hintBtn.classList.remove('hidden');
    allDOM.hintBtn.classList.remove('disabled');
    allDOM.helperCharacter.className = 'idle';

    allDOM.levelIndicator.textContent = `Level: ${level.difficulty}`;
    allDOM.levelInfo.textContent = `Topic: ${level.topic}`;
    
    allDOM.questionText.textContent = level.question;
    allDOM.unitText.textContent = level.unit;
    allDOM.progressBar.style.width = `${((level.level - 1) / levelsForGrade.length) * 100}%`;

    allDOM.questionContainer.classList.remove('new-level');
    void allDOM.questionContainer.offsetWidth; 
    allDOM.questionContainer.classList.add('new-level');
    startTimer();
  }

  function checkAnswer() {
    stopTimer();
    allDOM.userAnswer.classList.remove('incorrect');
    const level = allLevels[currentGrade][currentLevel - 1];
    const userInput = parseFloat(allDOM.userAnswer.value);
    allDOM.hintBtn.disabled = true;

    if (isNaN(userInput)) {
        allDOM.status.textContent = 'Please enter a valid number.';
        allDOM.status.style.color = 'red';
        allDOM.hintBtn.disabled = false;
        startTimer();
        return;
    }
    
    allDOM.status.style.color = '#333';
    const correctAnswer = level.correctAnswer();
    
    const tolerance = Math.max(0.1, Math.abs(correctAnswer * 0.02));
    const difference = Math.abs(userInput - correctAnswer);

    if (difference <= tolerance) {
        if (sounds) sounds.correct.triggerAttackRelease("C5", "8n");
        allDOM.userAnswer.classList.add('correct');
        handleCorrectAnswer(level, difference > 0.01);
    } else {
        if (sounds) {
            sounds.incorrect.triggerAttackRelease("A2", "8n");
            sounds.explosion.triggerAttackRelease("8n");
        }
        allDOM.userAnswer.classList.add('incorrect');
        allDOM.helperCharacter.className = 'scared sad';
        
        allDOM.explosionContainer.style.display = 'flex';
        allDOM.explosion.classList.add('explode');
        allDOM.gameContainer.classList.add('shake-hard');
        
        allDOM.explosion.addEventListener('animationend', () => {
            allDOM.explosionContainer.style.display = 'none';
            allDOM.explosion.classList.remove('explode');
            allDOM.gameContainer.classList.remove('shake-hard');
            allDOM.helperCharacter.className = 'sad';
            endGame('Incorrect Answer. Game Over!');
        }, { once: true });
    }
  }
  
  function handleCorrectAnswer(level, isApproximate) {
    if (isApproximate) {
        allDOM.status.innerHTML = `Close enough! The exact answer is ${level.correctAnswer().toFixed(2)}. Well done! 🎉`;
    } else {
        allDOM.status.textContent = 'Correct! Well done! 🎉';
    }
    const randomCompliment = compliments[Math.floor(Math.random() * compliments.length)];
    updateBubbleText(randomCompliment);
    score += 100;
    allDOM.scoreBoard.textContent = `Score: ${score}`;
    allDOM.scoreBoard.classList.add('score-updated');
    
    allDOM.helperCharacter.className = 'jumping happy';

    allDOM.scoreBoard.addEventListener('animationend', () => {
        allDOM.scoreBoard.classList.remove('score-updated');
    }, { once: true });
    allDOM.helperCharacter.addEventListener('animationend', () => {
        allDOM.helperCharacter.className = 'idle happy';
    }, { once: true });

    allDOM.userAnswer.disabled = true;
    allDOM.checkBtn.disabled = true;
    
    allDOM.feedbackPopup.classList.add('show');
    setTimeout(() => { allDOM.feedbackPopup.classList.remove('show'); }, 1500);

    triggerConfetti();
    setTimeout(() => endLevel(level), 500);
  }

  
  function endLevel(level) {
      allDOM.status.textContent = 'Success! Ready for the next level?';
      allDOM.nextLevelBtn.classList.remove('hidden');
      allDOM.nextLevelBtn.classList.add('next-level-glow');
      allDOM.checkBtn.classList.add('hidden');
      allDOM.hintBtn.classList.add('hidden');
      const levelsForGrade = allLevels[currentGrade];
      allDOM.progressBar.style.width = `${(currentLevel / levelsForGrade.length) * 100}%`;
      stopTimer();
  }
  
  function endGame(message) {
      stopTimer();
      allDOM.gameOverModal.classList.add('show');
      allDOM.correctAnswerInfo.textContent = `The correct answer was: ${allLevels[currentGrade][currentLevel - 1]?.correctAnswer().toFixed(2) || 'N/A'} ${allLevels[currentGrade][currentLevel - 1]?.unit || ''}`;
      allDOM.finalScore.textContent = `Your final score: ${score}`;
      updateBubbleText(message);
      allDOM.userAnswer.disabled = true;
      allDOM.checkBtn.disabled = true;
      allDOM.nextLevelBtn.classList.add('hidden');
      allDOM.hintBtn.classList.add('hidden');
  }
  
  function resetGame() {
    allDOM.gameOverModal.classList.remove('show');
    allDOM.quitModal.classList.remove('show');
    currentLevel = 1; score = 0;
    allDOM.scoreBoard.textContent = `Score: ${score}`;
    loadLevel(currentLevel);
  }
  
  allDOM.startBtn.addEventListener('click', () => {
    introDialogueIndex++;
    if (introDialogueIndex < introDialogues.length) {
        updateIntroDialogue();
    } else {
        allDOM.introModal.classList.remove('show');
        if (typeof Tone !== 'undefined' && Tone.context.state !== 'running') { Tone.start(); }
        initializeSounds();
        loadLevel(currentLevel);
        allDOM.helperContainer.classList.add('visible');
    }
  });

  allDOM.checkBtn.addEventListener('click', checkAnswer);
  allDOM.hintBtn.addEventListener('click', showHint);
  allDOM.userAnswer.addEventListener('keyup', (e) => { if (e.key === 'Enter') checkAnswer(); });
  allDOM.nextLevelBtn.addEventListener('click', () => { 
    currentLevel++; 
    const levelsForGrade = allLevels[currentGrade];
    if (currentLevel <= levelsForGrade.length) {
      loadLevel(currentLevel);
    } else {
      loadLevel(levelsForGrade.length + 1);
    }
  });

  allDOM.gradeSelect.addEventListener('change', (event) => {
    currentGrade = event.target.value;
    resetGame();
  });
  
  document.querySelectorAll('button').forEach(button => {
      button.addEventListener('click', () => { if(sounds && sounds.click) sounds.click.triggerAttackRelease("C4", "16n"); });
  });

  allDOM.quitBtn.addEventListener('click', () => {
    stopTimer();
    const levelsForGrade = allLevels[currentGrade];
    const level = levelsForGrade[currentLevel - 1];
    if (level) {
      allDOM.quitModal.classList.add('show');
    } else {
      resetGame();
    }
  });
  
  allDOM.confirmQuitBtn.addEventListener('click', () => {
    endGame('You have quit the game.');
  });
  
  allDOM.cancelQuitBtn.addEventListener('click', () => {
    allDOM.quitModal.classList.remove('show');
    startTimer();
  });

  allDOM.tryAgainBtn.addEventListener('click', resetGame);
  
  function initSymbolBackground() {
      const symbols = ['α', 'β', 'γ', 'δ', 'ε', 'Σ', 'Ω', 'λ', 'μ', 'π', 'ħ', '∂', '∫', '∇', '≈', '∝', 'E=mc²', 'F=ma'];
      const container = document.getElementById('backgroundPattern');
      if (!container) return;
      container.innerHTML = '';
      
      const numberOfSymbols = 80;

      for (let i = 0; i < numberOfSymbols; i++) {
          const symbolSpan = document.createElement('span');
          symbolSpan.classList.add('bg-symbol');
          symbolSpan.textContent = symbols[Math.floor(Math.random() * symbols.length)];
          
          symbolSpan.style.left = `${Math.random() * 100}vw`;
          symbolSpan.style.animationDelay = `${Math.random() * 5}s`;
          symbolSpan.style.fontSize = `${Math.random() * 30 + 15}px`;
          symbolSpan.style.animationDuration = `${Math.random() * 20 + 15}s`;
          
          container.appendChild(symbolSpan);
      }
  }


  window.addEventListener('resize', () => {
    allDOM.canvas.width = window.innerWidth;
    allDOM.canvas.height = window.innerHeight;
    initSymbolBackground();
  });

  window.onload = () => {
    allDOM.canvas.width = window.innerWidth;
    allDOM.canvas.height = window.innerHeight;
    updateIntroDialogue();
    initSymbolBackground();
    allDOM.speechBubble.textContent = "Help me solve this one!";
  };

  let confetti = [];
  function triggerConfetti() {
      const confettiCount = 150;
      const colors = ['#3d5afe', '#00b0ff', '#4caf50', '#ffeb3b', '#ff5722'];
      for (let i = 0; i < confettiCount; i++) {
          confetti.push({
              x: Math.random() * allDOM.canvas.width,
              y: -Math.random() * 20, 
              r: Math.random() * 6 + 3,
              c: colors[Math.floor(Math.random() * colors.length)],
              dx: Math.random() * 10 - 5,
              dy: Math.random() * 5 + 2,
              opacity: 1
          });
      }
      if (!isAnimatingConfetti) {
        animateConfetti();
      }
  }

  function animateConfetti() {
    isAnimatingConfetti = true;
    ctx.clearRect(0, 0, allDOM.canvas.width, allDOM.canvas.height);
    confetti.forEach((p, i) => {
        p.x += p.dx * 0.1;
        p.y += p.dy;
        p.dy += 0.05;
        p.opacity -= 0.005;

        if (p.opacity <= 0 || p.y > allDOM.canvas.height) {
            confetti.splice(i, 1);
        }
        
        ctx.save();
        ctx.globalAlpha = p.opacity;
        ctx.beginPath();
        ctx.fillStyle = p.c;
        ctx.shadowColor = p.c;
        ctx.shadowBlur = 10;
        ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
    });

    if (confetti.length > 0) {
        requestAnimationFrame(animateConfetti);
    } else {
        ctx.clearRect(0, 0, allDOM.canvas.width, allDOM.canvas.height);
        isAnimatingConfetti = false;
    }
  }
</script>

</body>
</html>
