<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduVaani Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- General & Student/Teacher Dashboard Styles --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Original background color */
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-zap"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>') 12 12, auto;
            background-attachment: fixed;
            transition: background 0.5s ease-in-out;
        }
        .card {
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .progress-bar {
            height: 10px;
            background-color: #e2e8f0;
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            transition: width 0.5s ease-in-out;
            border-radius: 9999px;
        }
        .badge-icon {
            font-size: 2.5rem;
            transition: transform 0.2s ease-in-out;
        }
        .badge-icon:hover {
            transform: scale(1.1);
        }
        .btn-start {
            background-image: linear-gradient(to right, #6EE7B7, #34D399);
            transition: all 0.3s ease-in-out;
        }
        .btn-start:hover {
            transform: scale(1.05) rotate(2deg);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        .btn-generate {
            background-image: linear-gradient(to right, #8B5CF6, #EC4899);
            transition: all 0.3s ease-in-out;
        }
        .btn-generate:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(109, 40, 217, 0.4);
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Parent Dashboard Specific Styles --- */
        h1, h2, h3 { font-family: 'Poppins', sans-serif; font-weight: 700; }
        .parent-dashboard-bg {
            background: linear-gradient(135deg, #f0f9ff 0%, #eef2f7 100%);
            color: #334155;
        }
        .parent-dashboard-bg .themed-header { color: #1e293b; }
        .parent-dashboard-bg .themed-text { color: #475569; }
       
        .dashboard-card {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.18);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.15);
        }
        @keyframes slide-in-up {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-in-up {
            animation: slide-in-up 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
            opacity: 0;
        }

        /* NEW Parent Animations */
        @keyframes fill-progress {
            from { width: 0%; }
        }
        .progress-bar-animated > div {
            animation: fill-progress 1.5s ease-out forwards;
        }
        .stat-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .stat-card:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        @keyframes pulse-avatar {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(49, 196, 141, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(49, 196, 141, 0); }
        }
        .avatar-pulse {
            animation: pulse-avatar 2.5s infinite;
        }
       
        /* --- Styles for the added student dashboard sections --- */
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Style for the audio icon button */
        .audio-btn-playing svg {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
       
        /* --- Monkey Animation Styles --- */
        @keyframes fall-down {
            from { transform: translateY(-100vh) rotate(-60deg); }
            to { transform: translateY(0) rotate(0deg); }
        }
        @keyframes go-up {
            from { transform: translateY(0) rotate(0deg); }
            to { transform: translateY(-100vh) rotate(60deg); }
        }
        .animate-fall {
            animation: fall-down 0.8s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards; /* EaseInBack curve */
        }
        .animate-rise {
            animation: go-up 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) 0.2s forwards; /* EaseOutBack curve with a slight delay */
        }

        /* --- New Engagement Animations --- */
        @keyframes jiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-3deg); }
            75% { transform: rotate(3deg); }
        }
        .group:hover .jiggle-on-hover {
            animation: jiggle 0.4s;
        }

        /* Pulsing glow for AI feature buttons */
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 8px rgba(168, 85, 247, 0.5); }
            50% { box-shadow: 0 0 16px rgba(168, 85, 247, 0.9); }
        }
        .ai-glow {
            animation: glow 2s infinite ease-in-out;
        }

        /* Engaging Loading Animations */
        @keyframes thinking {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        .loader-thinking {
            font-size: 2.5rem;
            animation: thinking 1.5s infinite ease-in-out;
        }
       
        @keyframes page-turn {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(360deg); }
        }
        .loader-book {
              font-size: 2.5rem;
              animation: page-turn 2s infinite linear;
        }
       
        /* Styles for Math Bullseye game */
        #math-game-modal #game-container {
            background-color: #121212;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #math-game-modal canvas {
            background-color: transparent;
            touch-action: none;
            display: block;
        }
        #math-game-modal #ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            box-sizing: border-box;
            pointer-events: none;
        }
        #math-game-modal #game-over-screen {
            pointer-events: auto;
            display: none;
            flex-direction: column;
            align-items: center;
            text-align: center;
            background-color: rgba(10, 10, 30, 0.95);
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
            max-width: 90%;
            color: #f3f4f6;
        }
        #math-game-modal #game-over-screen h1 {
            font-weight: 700;
            font-size: 2.5rem;
            color: #ffc400;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        #math-game-modal .score-display {
            font-size: 1.5rem;
            font-weight: 700;
            color: #f3f4f6;
            margin-top: 20px;
        }
        #math-game-modal .button {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            margin: 0 10px;
        }
        #math-game-modal .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        #math-game-modal #play-again-btn {
            background-color: #404080;
            color: white;
        }
        #math-game-modal #play-again-btn:hover {
            background-color: #7070a0;
        }
        #math-game-modal #quit-btn {
            background-color: #404080;
            color: white;
        }
        #math-game-modal #quit-btn:hover {
            background-color: #7070a0;
        }
        #math-game-modal .leaderboard {
            width: 100%;
            max-width: 300px;
            margin-top: 30px;
        }
        #math-game-modal .leaderboard h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #e6e6cc;
        }
        #math-game-modal .leaderboard ol {
            list-style-type: none;
            padding: 0;
        }
        #math-game-modal .leaderboard li {
            font-size: 1rem;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #f3f4f6;
        }
        #math-game-modal .leaderboard li:last-child {
            border-bottom: none;
        }
        #math-game-modal .leaderboard .top-3 {
            color: #ffc400;
        }
        #math-game-modal .leaderboard .top-3:nth-child(2) {
            color: #c0c0c0;
        }
        #math-game-modal .leaderboard .top-3:nth-child(3) {
            color: #cd7f32;
        }

        /* Puzzle Mania Modal styles */
        #puzzle-mania-modal #game-container {
            background-color: #2c3e50;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 95%;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #puzzle-mania-modal .game-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            width: 100%;
            max-width: 400px;
        }
        #puzzle-mania-modal .card {
            background-color: #34495e;
            color: white;
            padding: 1rem;
            font-size: 2rem;
            text-align: center;
            border-radius: 0.5rem;
            cursor: pointer;
            user-select: none;
            transition: all 0.3s ease;
            transform-style: preserve-3d;
            position: relative;
        }
        #puzzle-mania-modal .card-inner {
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            position: relative;
        }
        #puzzle-mania-modal .card.flipped .card-inner {
            transform: rotateY(180deg);
        }
        #puzzle-mania-modal .card-front,
        #puzzle-mania-modal .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
        }
        #puzzle-mania-modal .card-front {
            background-color: #e74c3c;
            transform: rotateY(180deg);
        }
        #puzzle-mania-modal .card-back {
            background-color: #95a5a6;
        }
        #puzzle-mania-modal .card.matched .card-front {
            background-color: #2ecc71;
        }
        #puzzle-mania-modal #game-info {
            width: 100%;
            max-width: 400px;
        }
        #puzzle-mania-modal #start-button, #puzzle-mania-modal #quit-game-btn {
            background-color: #3498db;
            color: white;
            font-size: 1.25rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #puzzle-mania-modal #start-button:hover, #puzzle-mania-modal #quit-game-btn:hover {
            background-color: #2980b9;
        }
    </style>
</head>
<body class="p-4 md:p-10">

    <div id="message-container" class="fixed top-5 left-1/2 -translate-x-1/2 bg-blue-500 text-white px-6 py-3 rounded-full shadow-lg z-50 transform scale-0 opacity-0 transition-all duration-300">
        <span id="message-text"></span>
    </div>

    <div id="role-selection-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-10 rounded-3xl shadow-2xl text-center">
            <h2 id="role-modal-title" class="text-3xl font-bold mb-6 text-indigo-800">Select Your Role</h2>
            <div class="flex space-x-6">
                <button id="student-role-btn" class="px-8 py-4 rounded-full font-bold text-xl text-white bg-blue-500 hover:bg-blue-600 transition-colors">
                    <i class="fas fa-user-graduate mr-2"></i> <span class="role-student-text">Student</span>
                </button>
                <button id="teacher-role-btn" class="px-8 py-4 rounded-full font-bold text-xl text-white bg-indigo-500 hover:bg-indigo-600 transition-colors">
                    <i class="fas fa-chalkboard-teacher mr-2"></i> <span class="role-teacher-text">Teacher</span>
                </button>
                <button id="parent-role-btn" class="px-8 py-4 rounded-full font-bold text-xl text-white bg-teal-500 hover:bg-teal-600 transition-colors">
                    <i class="fas fa-user-friends mr-2"></i> <span class="role-parent-text">Parent</span>
                </button>
            </div>
        </div>
    </div>
   
    <button id="role-switch-btn" class="fixed bottom-5 right-5 z-40 bg-gray-800 text-white px-4 py-2 rounded-full shadow-lg hover:bg-gray-700 transition-colors hidden">
        Switch Role
    </button>
   
    <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-10 rounded-3xl shadow-2xl text-center w-full max-w-md">
            <h2 id="login-modal-title" class="text-3xl font-bold mb-6 text-indigo-800">Login with Phone</h2>
            <form id="login-form" class="space-y-4">
                <input type="tel" id="phone-number" class="w-full p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-indigo-400 focus:outline-none" placeholder="Enter Phone Number (e.g., 919876543210)">
                <button type="submit" id="request-otp-btn" class="w-full bg-blue-500 text-white py-3 rounded-xl font-bold hover:bg-blue-600 transition-colors duration-200">Request OTP</button>
            </form>
            <div id="otp-section" class="space-y-4 mt-6 hidden">
                <p id="otp-info-text" class="text-gray-600">Enter the mock OTP to log in.</p>
                <input type="text" id="otp-input" class="w-full p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-indigo-400 focus:outline-none" placeholder="Enter OTP (e.g., 123456)">
                <button id="verify-otp-btn" class="w-full bg-indigo-500 text-white py-3 rounded-xl font-bold hover:bg-indigo-600 transition-colors duration-200">Verify OTP</button>
            </div>
        </div>
    </div>
   
    <div id="student-dashboard" class="hidden">

        <div class="w-full">
            <header class="text-center animate-slide-in-up pt-4" style="animation-delay: 100ms;">
                <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 leading-tight tracking-tight">
                    Student Dashboard
                </h1>
                <p class="mt-2 text-lg text-gray-600">
                    Your one-stop place for everything academic.
                </p>
            </header>
        </div>
       
        <div class="container mx-auto p-4 md:p-10">
            <div class="flex justify-end mb-4">
                <select id="language-selector" class="bg-white border border-gray-300 rounded-lg px-4 py-2 text-gray-700 font-semibold shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                </select>
            </div>
           
            <div class="card bg-white p-10 mb-10 flex flex-col md:flex-row items-center space-y-8 md:space-y-0 md:space-x-16">
                <div class="flex items-center space-x-8">
                    <div class="w-32 h-32 rounded-full bg-gradient-to-tr from-purple-500 to-pink-500 flex items-center justify-center overflow-hidden shadow-xl">
                        <span id="student-user-avatar" class="text-white text-6xl font-extrabold"></span>
                    </div>
                    <div>
                        <h1 id="student-welcome-message" class="text-5xl font-black text-gray-900 leading-tight"></h1>
                        <p id="student-learning-message" class="text-xl text-gray-600 font-medium"></p>
                    </div>
                </div>
               
                <div class="flex-grow flex flex-col md:flex-row items-end md:items-center space-y-5 md:space-y-0 md:space-x-8">
                    <div class="flex items-center space-x-4 bg-yellow-200 px-8 py-4 rounded-full shadow-inner">
                        <i class="fas fa-star text-yellow-600 text-3xl"></i>
                        <span id="student-level-text" class="font-bold text-xl text-yellow-700"></span>
                        <span id="student-xp-text" class="font-extrabold text-3xl text-yellow-800"></span>
                    </div>
                    <div class="w-full md:w-80">
                        <div class="progress-bar">
                            <div id="student-xp-progress-fill" class="progress-fill bg-gradient-to-r from-yellow-400 to-orange-400"></div>
                        </div>
                    </div>
                </div>
            </div>
           
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
               
                <div class="lg:col-span-2 card bg-white p-8">
                    <h2 class="text-3xl font-bold mb-8 flex items-center space-x-4 text-emerald-600">
                        <i class="fas fa-tasks text-emerald-600 text-3xl"></i>
                        <span id="student-daily-quests-title">Daily Quests</span>
                    </h2>
                    <div id="student-quest-list" class="space-y-8">
                        </div>
                    <div class="mt-10 text-center">
                        <button id="student-generate-quest-btn" class="btn-generate text-white px-10 py-5 rounded-full font-bold text-xl shadow-xl">
                            <div class="flex items-center justify-center space-x-2">
                                <span id="student-generate-quest-btn-text">✨ Generate New Quest</span>
                                <span id="student-generate-loading" class="hidden loading-spinner"></span>
                            </div>
                        </button>
                    </div>
                </div>
               
                <div class="card bg-white p-8">
                    <h2 class="text-3xl font-bold mb-8 flex items-center space-x-4 text-amber-500">
                        <i class="fas fa-trophy text-amber-500 text-3xl"></i>
                        <span id="student-leaderboard-title">Leaderboard</span>
                    </h2>
                    <ul id="student-leaderboard-list" class="space-y-6">
                        <li id="student-my-leaderboard-entry" class="hidden"></li>
                    </ul>
                </div>
            </div>
           
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 mt-10">
                <div class="card bg-white p-8">
                    <h2 class="text-3xl font-bold mb-8 flex items-center space-x-4 text-indigo-500">
                        <i class="fas fa-certificate text-indigo-500 text-3xl"></i>
                        <span id="student-badges-title">Achievement Badges</span>
                    </h2>
                    <div id="student-badges-grid" class="grid grid-cols-3 md:grid-cols-4 gap-8">
                        </div>
                </div>
               
                <div class="card bg-white p-8">
                    <h2 class="text-3xl font-bold mb-8 flex items-center space-x-4 text-purple-600">
                        <i class="fas fa-chart-line text-purple-600 text-3xl"></i>
                        <span id="student-progress-title">Module Progress</span>
                    </h2>
                    <div id="student-module-progress-list" class="space-y-8">
                        </div>
                    <div class="mt-8">
                        <label for="voice-input" id="student-voice-label" class="block font-bold text-gray-800 mb-2">Speak your question:</label>
                        <div class="flex space-x-4">
                            <input type="text" id="voice-input" class="flex-grow p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-purple-400 focus:outline-none" placeholder="Click mic to speak...">
                            <button id="mic-btn" class="bg-purple-500 text-white px-5 py-2 rounded-full font-bold hover:bg-purple-600 transition-colors">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
       
        <div id="star-container"></div>
   
       


            <section id="attendance-section" class="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-blue-500 opacity-0 animate-slide-in-up" style="animation-delay: 200ms;">
                <div class="flex flex-col sm:flex-row justify-between items-center">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800">Attendance</h2>
                    <button id="markAttendanceBtn" class="mt-4 sm:mt-0 px-6 py-3 bg-blue-600 text-white font-semibold rounded-full hover:bg-blue-700 transition-colors duration-300 transform hover:scale-105 shadow-md disabled:bg-gray-400 disabled:scale-100">
                        Mark Attendance
                    </button>
                </div>
                <p id="attendance-status" class="mt-4 text-center text-gray-500 hidden">
                    <span id="status-message" class="font-medium text-blue-600"></span>
                </p>
            </section>

            <section id="homework-section" class="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-green-500 opacity-0 animate-slide-in-up" style="animation-delay: 300ms;">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">Homework</h2>
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-xl flex flex-col sm:flex-row justify-between items-start sm:items-center">
                        <div class="flex-grow">
                            <h3 class="font-semibold text-gray-700">Math: Algebra Chapter 3</h3>
                            <p class="text-sm text-gray-500">Due: October 26, 2025</p>
                        </div>
                        <div class="flex items-center mt-3 sm:mt-0 sm:ml-4">
                            <span class="text-sm font-medium text-red-500 mr-4">Pending</span>
                            <button class="homework-help-btn px-4 py-2 bg-purple-500 text-white text-sm rounded-full hover:bg-purple-600 transition-transform transform hover:scale-105 ai-glow" data-homework="Math: Algebra basics">Get Help ✨</button>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl flex flex-col sm:flex-row justify-between items-start sm:items-center">
                        <div>
                            <h3 class="font-semibold text-gray-700">Science: Photosynthesis Lab Report</h3>
                            <p class="text-sm text-gray-500">Due: October 20, 2025</p>
                        </div>
                        <div class="flex items-center mt-3 sm:mt-0 sm:ml-4">
                            <span class="text-sm font-medium text-green-500">Completed</span>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl flex flex-col sm:flex-row justify-between items-start sm:items-center">
                        <div class="flex-grow">
                            <h3 class="font-semibold text-gray-700">History: Civil War Essay Outline</h3>
                            <p class="text-sm text-gray-500">Due: October 28, 2025</p>
                        </div>
                        <div class="flex items-center mt-3 sm:mt-0 sm:ml-4">
                            <span class="text-sm font-medium text-red-500 mr-4">Pending</span>
                            <button class="homework-help-btn px-4 py-2 bg-purple-500 text-white text-sm rounded-full hover:bg-purple-600 transition-transform transform hover:scale-105 ai-glow" data-homework="History: How to outline an essay about a historical event">Get Help ✨</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="curious-corner" class="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-yellow-500 opacity-0 animate-slide-in-up" style="animation-delay: 400ms;">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">Curious Corner ✨</h2>
                <p class="text-gray-600 mb-4">Have a question about anything in the world? Ask me!</p>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="curious-question-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 flex-grow" placeholder="e.g., Why is the sky blue?">
                    <button id="ask-curious-question-btn" class="px-6 py-3 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 transition-colors duration-300">Ask Question</button>
                </div>
                <div id="curious-answer" class="mt-4 text-gray-700 p-4 bg-gray-50 rounded-lg min-h-[100px] hidden">
                    </div>
            </section>

            <section id="gaming-section" class="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-purple-500 opacity-0 animate-slide-in-up" style="animation-delay: 500ms;">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">Learning Games</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div id="puzzle-mania-card" class="bg-gray-100 p-4 rounded-xl text-center hover:shadow-lg transition-shadow duration-300 cursor-pointer group"><div class="text-5xl mb-2 jiggle-on-hover">👾</div><h3 class="font-semibold text-gray-800">Puzzle Mania</h3><p class="text-sm text-gray-500">Brain-teasers for fun!</p></div>
                    <div class="bg-gray-100 p-4 rounded-xl text-center hover:shadow-lg transition-shadow duration-300 cursor-pointer group"><div class="text-5xl mb-2 jiggle-on-hover">🚀</div><h3 class="font-semibold text-gray-800">Space Adventure</h3><p class="text-sm text-gray-500">Blast off and explore!</p></div>
                    <div id="math-bullseye-card" class="bg-gray-100 p-4 rounded-xl text-center hover:shadow-lg transition-shadow duration-300 cursor-pointer group"><div class="text-5xl mb-2 jiggle-on-hover">🎯</div><h3 class="font-semibold text-gray-800">Math Bullseye</h3><p class="text-sm text-gray-500">Hit the number target!</p></div>
                    <div class="bg-gray-100 p-4 rounded-xl text-center hover:shadow-lg transition-shadow duration-300 cursor-pointer group"><div class="text-5xl mb-2 jiggle-on-hover">🕸️</div><h3 class="font-semibold text-gray-800">Word Weaver</h3><p class="text-sm text-gray-500">Build words, win points!</p></div>
                    <div class="bg-gray-100 p-4 rounded-xl text-center hover:shadow-lg transition-shadow duration-300 cursor-pointer group"><div class="text-5xl mb-2 jiggle-on-hover">🗺️</div><h3 class="font-semibold text-gray-800">State Spotter</h3><p class="text-sm text-gray-500">Find the Indian states!</p></div>
                    <div class="bg-gray-100 p-4 rounded-xl text-center hover:shadow-lg transition-shadow duration-300 cursor-pointer group"><div class="text-5xl mb-2 jiggle-on-hover">🦁</div><h3 class="font-semibold text-gray-800">Animal Kingdom</h3><p class="text-sm text-gray-500">Match animals & sounds.</p></div>
                    <div class="bg-gray-100 p-4 rounded-xl text-center hover:shadow-lg transition-shadow duration-300 cursor-pointer group"><div class="text-5xl mb-2 jiggle-on-hover">⏳</div><h3 class="font-semibold text-gray-800">History Timeline</h3><p class="text-sm text-gray-500">Order the events!</p></div>
                    <div class="bg-gray-100 p-4 rounded-xl text-center hover:shadow-lg transition-shadow duration-300 cursor-pointer group"><div class="text-5xl mb-2 jiggle-on-hover">🔷</div><h3 class="font-semibold text-gray-800">Shape Sorter</h3><p class="text-sm text-gray-500">Identify geometric shapes.</p></div>
                    <div class="bg-gray-100 p-4 rounded-xl text-center hover:shadow-lg transition-shadow duration-300 cursor-pointer group"><div class="text-5xl mb-2 jiggle-on-hover">🌾</div><h3 class="font-semibold text-gray-800">Farming Fun</h3><p class="text-sm text-gray-500">Learn about crops!</p></div>
                    <div class="bg-gray-100 p-4 rounded-xl text-center hover:shadow-lg transition-shadow duration-300 cursor-pointer group"><div class="text-5xl mb-2 jiggle-on-hover">💧</div><h3 class="font-semibold text-gray-800">Clean Village</h3><p class="text-sm text-gray-500">A game on hygiene.</p></div>
                    <div class="bg-gray-100 p-4 rounded-xl text-center hover:shadow-lg transition-shadow duration-300 cursor-pointer group"><div class="text-5xl mb-2 jiggle-on-hover">🛒</div><h3 class="font-semibold text-gray-800">Market Math</h3><p class="text-sm text-gray-500">Simple money calculations.</p></div>
                    <div id="storyMaker" class="bg-gray-100 p-4 rounded-xl text-center hover:shadow-lg transition-shadow duration-300 cursor-pointer group">
                        <div class="text-5xl mb-2 jiggle-on-hover">📖</div>
                        <h3 class="font-semibold text-gray-800">Story Maker ✨</h3>
                        <p class="text-sm text-gray-500">Create with AI!</p>
                    </div>
                     <div class="bg-gray-100 p-4 rounded-xl text-center hover:shadow-lg transition-shadow duration-300 cursor-pointer group">
                         <div class="text-5xl mb-2 jiggle-on-hover">🔬</div> <h3 class="font-semibold text-gray-800">Science Lab</h3> <p class="text-sm text-gray-500">Fun science experiments.</p>
                     </div>
                </div>
            </section>
        </div>
    </div>


    <div id="teacher-dashboard" class="hidden">
        <header class="text-center mb-10 flex justify-between items-center">
            <div>
                <h1 class="text-5xl font-extrabold text-indigo-800">EduVaani</h1>
                <p id="teacher-dashboard-title" class="text-2xl font-semibold text-gray-600 mt-2">Teacher Dashboard</p>
            </div>
            <select id="teacher-language-selector" class="bg-white border border-gray-300 rounded-lg px-4 py-2 text-gray-700 font-semibold shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                </select>
        </header>
       
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
           
            <section class="lg:col-span-2 card bg-white p-6 md:p-8">
                <h2 class="text-2xl md:text-3xl font-bold mb-6 flex items-center space-x-3 text-indigo-700">
                    <i class="fas fa-users"></i>
                    <span id="teacher-student-progress-title">Student Progress</span>
                </h2>
                <div class="mb-4 flex items-center space-x-4">
                    <label for="teacher-progress-view" id="teacher-view-label" class="block text-lg font-semibold mb-0">View:</label>
                    <select id="teacher-progress-view" class="p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-indigo-400 focus:outline-none">
                        <option id="teacher-view-option-summary" value="class-summary">Class Summary</option>
                        <option id="teacher-view-option-all" value="all-students">All Students</option>
                    </select>
                    <button id="generate-report-btn" class="px-6 py-2 bg-purple-500 text-white rounded-full font-bold hover:bg-purple-600 transition-colors">
                        ✨ <span id="teacher-generate-report-btn-text">Generate Report</span>
                    </button>
                </div>
                <div id="teacher-progress-summary" class="hidden p-4 bg-indigo-50 rounded-lg">
                    <h3 id="teacher-summary-title" class="text-xl font-bold text-indigo-700 mb-2">Class Overall Performance</h3>
                    <p class="text-lg text-gray-700"><span id="teacher-summary-avg-xp-label">Average XP</span>: <span id="teacher-avg-xp" class="font-semibold">0</span></p>
                    <p class="text-lg text-gray-700"><span id="teacher-summary-avg-level-label">Average Level</span>: <span id="teacher-avg-level" class="font-semibold">0</span></p>
                    <p class="text-lg text-gray-700"><span id="teacher-summary-total-students-label">Total Students</span>: <span id="teacher-total-students" class="font-semibold">0</span></p>
                    <div id="teacher-report-text" class="mt-4 text-gray-800 italic"></div>
                </div>
                <div id="teacher-student-progress-list" class="space-y-6">
                    </div>
            </section>
           
            <section class="card bg-white p-6 md:p-8">
                <h2 class="text-2xl md:text-3xl font-bold mb-6 flex items-center space-x-3 text-amber-600">
                    <i class="fas fa-trophy"></i>
                    <span id="teacher-leaderboard-title">Class Leaderboard</span>
                </h2>
                <ul id="teacher-leaderboard-list" class="space-y-4">
                    </ul>
            </section>
           
        </div>
       
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
           
            <section class="card bg-white p-6 md:p-8">
                <h2 class="text-2xl md:text-3xl font-bold mb-6 flex items-center space-x-3 text-emerald-600">
                    <i class="fas fa-award"></i>
                    <span id="teacher-reward-title">Reward & Recognition</span>
                </h2>
                <div class="space-y-4">
                    <select id="teacher-reward-student-selector" class="w-full p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-emerald-400 focus:outline-none">
                        <option value="" disabled selected>Select a student</option>
                        </select>
                    <div id="teacher-badge-grid" class="grid grid-cols-3 md:grid-cols-4 gap-4 p-4 rounded-xl bg-gray-50">
                        </div>
                    <button id="teacher-award-badge-btn" class="w-full bg-emerald-500 text-white py-3 rounded-xl font-bold hover:bg-emerald-600 transition-colors duration-200" disabled>Award Badge</button>
                </div>
            </section>
           
            <section class="card bg-white p-6 md:p-8">
                <h2 class="text-2xl md:text-3xl font-bold mb-6 flex items-center space-x-3 text-red-500">
                    <i class="fas fa-paper-plane"></i>
                    <span id="teacher-assignment-title-main">Assignment Management</span>
                </h2>
                <form id="teacher-assignment-form" class="space-y-4">
                    <div>
                        <label for="teacher-assignment-title" id="teacher-assignment-module-label" class="block font-semibold mb-2">Module Title</label>
                        <input type="text" id="teacher-assignment-title-input" class="w-full p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-red-400 focus:outline-none" placeholder="e.g., Water Conservation Module">
                    </div>
                    <div>
                        <label for="teacher-assignment-desc" id="teacher-assignment-desc-label" class="block font-semibold mb-2">Description</label>
                        <textarea id="teacher-assignment-desc" rows="3" class="w-full p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-red-400 focus:outline-none" placeholder="Explain the key tasks for this module..."></textarea>
                    </div>
                    <div>
                        <label for="teacher-assignment-group" id="teacher-assignment-assign-label" class="block font-semibold mb-2">Assign to:</label>
                        <select id="teacher-assignment-group" class="w-full p-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-red-400 focus:outline-none">
                            <option id="teacher-assign-all" value="all">All Students</option>
                            <option id="teacher-assign-gA" value="groupA">Group A</option>
                            <option id="teacher-assign-gB" value="groupB">Group B</option>
                        </select>
                    </div>
                    <button type="submit" id="teacher-create-assignment-btn" class="w-full bg-red-500 text-white py-3 rounded-xl font-bold hover:bg-red-600 transition-colors duration-200">
                        Create Assignment
                    </button>
                </form>
            </section>
           
            <section class="lg:col-span-2 card bg-white p-6 md:p-8">
                <h2 class="text-2xl md:text-3xl font-bold mb-6 flex items-center space-x-3 text-cyan-600">
                    <i class="fas fa-bell"></i>
                    <span id="teacher-notifications-title">Notifications & Alerts</span>
                </h2>
                <div id="teacher-notification-list" class="space-y-4">
                    </div>
            </section>
           
        </div>
    </div>
   
    <div id="parent-dashboard" class="hidden">
        <div class="container mx-auto p-4 md:p-6 max-w-4xl">
   
            <header class="flex justify-between items-center mb-6 animate-slide-in-up" style="animation-delay: 100ms;">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-teal-600">EduVaani</h1>
                    <p id="greeting-message" class="themed-text text-sm md:text-base">Welcome, Parent!</p>
                </div>
                <div class="flex items-center space-x-3">
                    <select id="parent-language-selector" class="bg-white border border-gray-300 rounded-lg px-4 py-2 text-gray-700 font-semibold shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 mr-4">
                        </select>
                    <span id="parent-child-dashboard-label" class="font-semibold text-right themed-header">Priyanka's Dashboard</span>
                    <img src="https://placehold.co/60x60/31C48D/FFFFFF?text=P" alt="Priyanka's Profile Picture" class="w-12 h-12 md:w-14 md:h-14 rounded-full border-2 border-teal-500 avatar-pulse">
                </div>
            </header>
   
            <main class="grid grid-cols-1 md:grid-cols-3 gap-6">
               
                <div class="md:col-span-2 space-y-6">
                   
                    <div class="dashboard-card p-6 animate-slide-in-up" style="animation-delay: 200ms;">
                        <h2 id="parent-overall-progress-title" class="text-xl font-bold mb-4 themed-header">Overall Progress</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                            <div class="bg-teal-50 p-4 rounded-lg stat-card">
                                <i class="fas fa-rocket text-3xl text-teal-500 mb-2"></i>
                                <p class="text-lg font-semibold text-gray-800">Level 12</p>
                                <p id="parent-learning-level-label" class="text-sm text-gray-600">Learning Level</p>
                            </div>
                            <div class="bg-amber-50 p-4 rounded-lg stat-card">
                                <i class="fas fa-star text-3xl text-amber-500 mb-2"></i>
                                <p class="text-lg font-semibold text-gray-800">8,450</p>
                                <p id="parent-points-earned-label" class="text-sm text-gray-600">Points Earned</p>
                            </div>
                            <div class="bg-indigo-50 p-4 rounded-lg stat-card">
                                <i class="fas fa-trophy text-3xl text-indigo-500 mb-2"></i>
                                <p class="text-lg font-semibold text-gray-800">21</p>
                                <p id="parent-badges-collected-label" class="text-sm text-gray-600">Badges Collected</p>
                            </div>
                        </div>
                    </div>
   
                    <div class="dashboard-card p-6 animate-slide-in-up" style="animation-delay: 300ms;">
                        <h2 id="parent-subject-progress-title" class="text-xl font-bold mb-4 themed-header">Subject Progress</h2>
                        <div class="space-y-5">
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <h3 id="parent-subject-math" class="font-semibold themed-header">Mathematics</h3>
                                    <span class="text-sm font-medium themed-text">18 / 25 <span class="parent-lessons-label">Lessons</span></span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-4 progress-bar-animated">
                                    <div class="bg-blue-500 h-4 rounded-full" style="width: 72%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <h3 id="parent-subject-science" class="font-semibold themed-header">Science</h3>
                                    <span class="text-sm font-medium themed-text">22 / 30 <span class="parent-lessons-label">Lessons</span></span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-4 progress-bar-animated">
                                    <div class="bg-green-500 h-4 rounded-full" style="width: 73.3%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <h3 id="parent-subject-english" class="font-semibold themed-header">English</h3>
                                    <span class="text-sm font-medium themed-text">15 / 20 <span class="parent-lessons-label">Lessons</span></span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-4 progress-bar-animated">
                                    <div class="bg-purple-500 h-4 rounded-full" style="width: 75%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
   
                    <div class="dashboard-card p-6 animate-slide-in-up" style="animation-delay: 400ms;">
                        <h2 id="parent-homework-title" class="text-xl font-bold mb-4 themed-header">Recent Homework</h2>
                        <div class="space-y-3">
                            <div class="flex flex-col sm:flex-row sm:items-center justify-between p-3 bg-white/60 rounded-lg">
                                <div>
                                    <p id="parent-homework1-title" class="font-semibold text-gray-800">Math: Chapter 5 Problems</p>
                                    <p class="text-sm text-gray-500"><span class="parent-due-label">Due</span>: <span class="parent-due-date1">Yesterday</span></p>
                                </div>
                                <span class="mt-2 sm:mt-0 text-xs font-bold uppercase px-3 py-1 bg-green-200 text-green-800 rounded-full parent-status-submitted">Submitted</span>
                            </div>
                            <div class="flex flex-col sm:flex-row sm:items-center justify-between p-3 bg-white/60 rounded-lg">
                                <div>
                                    <p id="parent-homework2-title" class="font-semibold text-gray-800">Science: Plant Cell Diagram</p>
                                    <p class="text-sm text-gray-500"><span class="parent-due-label">Due</span>: <span class="parent-due-date2">Tomorrow</span></p>
                                </div>
                                <span class="mt-2 sm:mt-0 text-xs font-bold uppercase px-3 py-1 bg-amber-200 text-amber-800 rounded-full parent-status-pending">Pending</span>
                            </div>
                            <div class="flex flex-col sm:flex-row sm:items-center justify-between p-3 bg-white/60 rounded-lg">
                                <div>
                                    <p id="parent-homework3-title" class="font-semibold text-gray-800">English: Essay on "My Village"</p>
                                    <p class="text-sm text-gray-500"><span class="parent-due-label">Due</span>: <span class="parent-due-date3">2 days ago</span></p>
                                </div>
                                <span class="mt-2 sm:mt-0 text-xs font-bold uppercase px-3 py-1 bg-red-200 text-red-800 rounded-full parent-status-overdue">Overdue</span>
                            </div>
                        </div>
                    </div>
   
                </div>
               
                <div class="space-y-6">
                    <div class="dashboard-card p-6 animate-slide-in-up" style="animation-delay: 500ms;">
                        <h2 id="parent-attendance-title" class="text-xl font-bold mb-4 themed-header">Attendance</h2>
                        <div class="text-center bg-teal-500 text-white p-4 rounded-lg mb-4">
                            <p class="text-3xl font-bold">92%</p>
                            <p id="parent-attendance-month-label" class="text-sm">Present (This Month)</p>
                        </div>
                        <h3 id="parent-attendance-week-label" class="font-semibold text-center mb-2 themed-header">This Week</h3>
                        <div class="flex justify-around text-center">
                            <div class="flex flex-col items-center space-y-1">
                                <span class="text-xs font-bold themed-text parent-day-mon">Mon</span>
                                <span class="w-8 h-8 flex items-center justify-center bg-green-100 text-green-600 rounded-full"><i class="fas fa-check"></i></span>
                            </div>
                            <div class="flex flex-col items-center space-y-1">
                                <span class="text-xs font-bold themed-text parent-day-tue">Tue</span>
                                <span class="w-8 h-8 flex items-center justify-center bg-green-100 text-green-600 rounded-full"><i class="fas fa-check"></i></span>
                            </div>
                            <div class="flex flex-col items-center space-y-1">
                                <span class="text-xs font-bold themed-text parent-day-wed">Wed</span>
                                <span class="w-8 h-8 flex items-center justify-center bg-red-100 text-red-600 rounded-full"><i class="fas fa-times"></i></span>
                            </div>
                            <div class="flex flex-col items-center space-y-1">
                                <span class="text-xs font-bold themed-text parent-day-thu">Thu</span>
                                <span class="w-8 h-8 flex items-center justify-center bg-green-100 text-green-600 rounded-full"><i class="fas fa-check"></i></span>
                            </div>
                            <div class="flex flex-col items-center space-y-1">
                                <span class="text-xs font-bold themed-text parent-day-fri">Fri</span>
                                <span class="w-8 h-8 flex items-center justify-center bg-gray-200 text-gray-500 rounded-full"><i class="fas fa-hourglass-start"></i></span>
                            </div>
                        </div>
                    </div>
                </div>
   
            </main>
   
            <footer class="text-center mt-8 text-sm themed-text animate-slide-in-up" style="animation-delay: 600ms;">
                <p id="parent-footer-text">&copy; 2025 EduVaani. Empowering rural learning.</p>
            </footer>
   
        </div>
    </div>
   
    <div id="messageBox" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-95">
            <h3 class="text-xl font-bold text-gray-800" id="messageBoxTitle"></h3>
            <p class="mt-2 text-gray-600" id="messageBoxContent"></p>
            <div class="mt-4 text-right">
                <button id="closeMessageBtn" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">OK</button>
            </div>
        </div>
    </div>
    <div id="homeworkHelpModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full transform transition-all duration-300 scale-95">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-800">Homework Helper ✨</h3>
                <button id="closeHomeworkHelpBtn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <button id="listenHelpBtn" class="hidden mt-4 px-4 py-2 bg-green-500 text-white rounded-full hover:bg-green-600 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-volume-up-fill" viewBox="0 0 16 16"><path d="M11.536 14.01A8.47 8.47 0 0 0 14.026 8a8.47 8.47 0 0 0-2.49-6.01l-1.414 1.414A6.47 6.47 0 0 1 12.025 8a6.47 6.47 0 0 1-1.903 4.596z"/><path d="M10.121 12.596A6.47 6.47 0 0 0 12.025 8a6.47 6.47 0 0 0-1.904-4.596l-1.414 1.414A4.47 4.47 0 0 1 10.025 8a4.47 4.47 0 0 1-1.318 3.182z"/><path d="M8.707 11.182A2.47 2.47 0 0 0 9.025 8a2.47 2.47 0 0 0-.318-1.182L8.707 5.404A4.47 4.47 0 0 1 10.025 8a4.47 4.47 0 0 1-1.318 3.182zM4.252 0C2.42 0 1 1.42 1 3.252v9.496C1 14.58 2.42 16 4.252 16h1.598a1 1 0 0 0 1-1V1a1 1 0 0 0-1-1zm-1.5 4.5A1.5 1.5 0 0 1 4.252 3h1.5a1.5 1.5 0 0 1 0 3h-1.5A1.5 1.5 0 0 1 2.752 4.5"/></svg> Listen to explanation
            </button>
            <div id="homeworkHelpContent" class="mt-4 text-gray-600 space-y-2"></div>
        </div>
    </div>
    <div id="storyMakerModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full transform transition-all duration-300 scale-95 overflow-y-auto max-h-full">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-800">Story Maker ✨</h3>
                <button id="closeStoryMakerBtn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="mt-4 space-y-4">
                <p class="text-gray-600">Give me one word, and I'll start a story for you!</p>
                <input type="text" id="storyWordInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="e.g., Mango, River, Star...">
                <button id="generateStoryBtn" class="w-full px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition-colors duration-300">Generate Story</button>
                <div id="storyResult" class="mt-4 text-gray-700 p-4 bg-gray-50 rounded-lg min-h-[100px]"></div>
                <button id="visualizeStoryBtn" class="hidden w-full px-6 py-3 bg-teal-500 text-white font-semibold rounded-lg hover:bg-teal-600 transition-colors duration-300 mt-2">Visualize Story ✨</button>
                <div id="storyImageResult" class="mt-4 w-full aspect-square bg-gray-100 rounded-lg flex items-center justify-center"></div>
            </div>
        </div>
    </div>
    <div id="attendanceAnimationOverlay" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center p-4 z-[60] pointer-events-none">
        <div id="monkeyContainer" class="relative">
            <div id="animatedMonkey" class="text-8xl transform">🐒</div>
            <p id="monkeyMessage" class="absolute -bottom-12 w-max left-1/2 -translate-x-1/2 mt-4 text-xl font-bold text-white bg-green-500 rounded-full px-6 py-2 opacity-0 transition-opacity duration-300">Attendance Marked!</p>
        </div>
    </div>
   
    <div id="math-game-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div id="game-container" class="relative bg-black rounded-lg shadow-xl overflow-hidden p-6">
            <canvas id="gameCanvas"></canvas>
            <div id="ui-overlay">
                <div id="game-over-screen">
                    <h1 class="text-3xl lg:text-5xl font-bold mb-4">🏆 GAME OVER</h1>
                    <p id="final-score" class="text-xl lg:text-3xl font-bold mb-6">Your Score: 0</p>
                    <div class="leaderboard">
                        <h3 class="text-lg lg:text-xl text-yellow-200 mb-2">Leaderboard (Top 5)</h3>
                        <ol id="leaderboard-list" class="text-sm lg:text-base text-gray-200"></ol>
                    </div>
                    <div class="flex mt-8 space-x-4">
                        <button id="play-again-btn" class="button">Play Again</button>
                        <button id="quit-btn" class="button">Quit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="puzzle-mania-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div id="game-container" class="relative">
            <div id="puzzle-mania-game-ui" class="text-white flex flex-col items-center space-y-6">
                <div id="game-info" class="text-center">
                    <h2 class="text-3xl font-bold">Puzzle Mania</h2>
                    <p id="game-status" class="mt-2 text-lg">Find the matching pairs!</p>
                    <p id="moves-counter" class="mt-1 text-md">Moves: 0</p>
                </div>
                <div id="game-board" class="game-board"></div>
                <button id="start-button">Start Game</button>
                <button id="quit-game-btn" class="hidden">Quit</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug');

        // --- Firebase Configuration & Initialization (MANDATORY) ---
        const isGeminiPlatform = typeof __firebase_config !== 'undefined';
        const appId = isGeminiPlatform ? __app_id : 'default-app-id';
        const firebaseConfig = isGeminiPlatform ? JSON.parse(__firebase_config) : {
            apiKey: "dummy-api-key",
            authDomain: "dummy-auth-domain",
            projectId: "dummy-project-id",
            storageBucket: "dummy-storage-bucket",
            messagingSenderId: "dummy-messaging-id",
            appId: "dummy-app-id"
        };
        const authToken = isGeminiPlatform ? __initial_auth_token : null;
        let app, auth, db;
        let userId;

        // --- Global State & Data Management ---
        let currentRole = localStorage.getItem('userRole') || null;
        let studentData = {
            name: 'Priyanka',
            level: 3,
            xp: 550,
            nextLevelXp: 800,
            quests: [
                { id: 'seeds', xp: 75 },
                { id: 'water_conservation', xp: 90 }
            ],
            lastQuestGenerated: null
        };
        let students = []; // For teacher dashboard
        const defaultLeaderboard = [
            { id: '1', name: 'Rajesh', xp: 2100 },
            { id: '2', name: 'Anita', xp: 1950 },
            { id: '3', name: 'Vikram', xp: 1800 },
            { id: '4', name: 'Suman', xp: 1750 },
        ];
        const studentBadges = [
            { id: 'star', name: 'Village Star', icon: 'fas fa-seedling', color: 'green', earned: true },
            { id: 'water', name: 'Water Warrior', icon: 'fas fa-faucet', color: 'blue', earned: true },
            { id: 'bookworm', name: 'Bookworm', icon: 'fas fa-book-reader', color: 'pink', earned: true },
            { id: 'locked', name: 'Locked', icon: 'fas fa-lock', color: 'gray', earned: false }
        ];
        const studentModules = [
            { id: 'math', progress: 75, color: 'purple' },
            { id: 'science', progress: 50, color: 'blue' },
            { id: 'history', progress: 20, color: 'emerald' }
        ];
       
        const teacherBadges = [
            { id: 'star-performer', name: 'Star Performer', icon: 'fas fa-star', color: 'text-yellow-500' },
            { id: 'helping-hand', name: 'Helping Hand', icon: 'fas fa-hand-holding-heart', color: 'text-pink-500' },
            { id: 'problem-solver', name: 'Problem Solver', icon: 'fas fa-lightbulb', color: 'text-blue-500' },
            { id: 'water-warrior', name: 'Water Warrior', icon: 'fas fa-water', color: 'text-cyan-500' },
            { id: 'master-farmer', name: 'Master Farmer', icon: 'fas fa-seedling', color: 'text-green-500' }
        ];

        const languages = {
            'en': 'English', 'hi': 'हिन्दी', 'as': 'অসমীয়া', 'bn': 'বাংলা', 'brx': 'बोड़ो',
            'doi': 'डोगरी', 'gu': 'ગુજરાતી', 'kn': 'ಕನ್ನಡ', 'ks': 'कश्मीरी', 'kok': 'कोंकणी',
            'mai': 'मैथिली', 'ml': 'മലയാളം', 'mni': 'মৈতৈলোন্', 'mr': 'मराठी', 'ne': 'नेपाली',
            'or': 'ଓଡ଼ିଆ', 'pa': 'ਪੰਜਾਬੀ', 'sa': 'संस्कृतम्', 'sat': 'संताली', 'sd': 'सिन्धी',
            'ta': 'தமிழ்', 'te': 'తెలుగు', 'ur': 'اردو'
        };
        const ttsVoiceMap = {
            'en': 'Kore', 'hi': 'Algenib', 'as': 'Algenib', 'bn': 'Gacrux', 'brx': 'Kore',
            'doi': 'Kore', 'gu': 'Sadachbia', 'kn': 'Vindemiatrix', 'ks': 'Algenib', 'kok': 'Sadachbia',
            'mai': 'Algenib', 'ml': 'Vindemiatrix', 'mni': 'Kore', 'mr': 'Sadachbia', 'ne': 'Algenib',
            'or': 'Gacrux', 'pa': 'Sadaltager', 'sa': 'Kore', 'sat': 'Kore', 'sd': 'Algenib',
            'ta': 'Vindemiatrix', 'te': 'Zubenelgenubi', 'ur': 'Algenib',
        };

        // --- Internationalization (i18n) Data ---
        const translations = {
            en: {
                login_title: 'Login with Phone',
                request_otp: 'Request OTP',
                verify_otp: 'Verify OTP',
                otp_info: 'Enter the mock OTP to log in.',
                role_modal_title: 'Select Your Role',
                role_student: 'Student',
                role_teacher: 'Teacher',
                role_parent: 'Parent',
                switch_role_button: 'Switch Role',
                welcome_message: 'Hello, Priyanka!',
                learning_message: "Let's learn something new today!",
                level_text: 'Level',
                daily_quests_title: 'Daily Quests',
                leaderboard_title: 'Leaderboard',
                badges_title: 'Achievement Badges',
                progress_title: 'Module Progress',
                generate_quest_button: '✨ Generate New Quest',
                read_aloud_button: '✨ Read Aloud',
                explain_concept_button: '✨ Explain Concept',
                badge_star: 'Village Star',
                badge_water: 'Water Warrior',
                badge_bookworm: 'Bookworm',
                badge_locked: 'Locked',
                start_button_text: 'Start',
                seeds_title: 'Learn About Seed Types',
                seeds_desc: 'Watch a video on local crops and their seeds.',
                water_conservation_title: 'Water Our Village Fields',
                water_conservation_desc: 'Simulate watering crops to learn about conservation.',
                math_quest_title: 'Math: The Field Calculator',
                math_quest_desc: 'The Math module teaches you how to calculate crop yields, measure water usage, and manage your budget for farming.',
                science_quest_title: 'Science: Our Water Sources',
                science_quest_desc: 'In this Science module, you will learn about the water cycle, different types of water sources in your village, and how to keep them clean.',
                history_quest_title: 'Local History: Our Village Elders',
                history_quest_desc: 'The Local History module explores the stories and traditions passed down from your village elders.',
                not_yet_earned: 'Not Yet Earned',
                loading_quests: 'Generating new quest...',
                loading_audio: 'Loading audio...',
                loading_explanation: 'Generating explanation...',
                loading_report: 'Generating class report...',
                quest_generated_success: 'New quest generated!',
                quest_already_generated: 'You can only generate one quest per day.',
                no_text_to_read: 'No text to read.',
                xp_gained: '+{xp} XP!',
                no_quests: 'No quests available. Generate one to start!',
                voice_question_label: 'Speak your question:',
                teacher_dashboard_title: 'Teacher Dashboard',
                student_progress_title: 'Student Progress',
                view_label: 'View:',
                view_option_summary: 'Class Summary',
                view_option_all: 'All Students',
                generate_report_button: 'Generate Report',
                summary_title: 'Class Overall Performance',
                summary_avg_xp: 'Average XP',
                summary_avg_level: 'Average Level',
                summary_total_students: 'Total Students',
                class_leaderboard_title: 'Class Leaderboard',
                reward_title: 'Reward & Recognition',
                select_student_placeholder: 'Select a student',
                award_badge_button: 'Award Badge',
                assignment_title: 'Assignment Management',
                module_title_label: 'Module Title',
                description_label: 'Description',
                assign_to_label: 'Assign to:',
                assign_all: 'All Students',
                assign_group_a: 'Group A',
                assign_group_b: 'Group B',
                create_assignment_button: 'Create Assignment',
                notifications_title: 'Notifications & Alerts',
                notification1: "New module 'Water Conservation' assigned to all students!",
                notification2: "Rajesh achieved the 'Water Warrior' badge.",
                notification3: "Meena has completed the 'Village Star' quest.",
                parent_welcome: 'Welcome, Parent!',
                parent_greeting_morning: 'Good morning, Parent!',
                parent_greeting_afternoon: 'Good afternoon, Parent!',
                parent_greeting_evening: 'Good evening, Parent!',
                parent_greeting_night: 'Hope you had a great day!',
                child_dashboard_label: "Priyanka's Dashboard",
                overall_progress_title: 'Overall Progress',
                learning_level_label: 'Learning Level',
                points_earned_label: 'Points Earned',
                badges_collected_label: 'Badges Collected',
                subject_progress_title: 'Subject Progress',
                lessons_label: 'Lessons',
                subject_math: 'Mathematics',
                subject_science: 'Science',
                subject_english: 'English',
                homework_title: 'Recent Homework',
                due_label: 'Due',
                due_yesterday: 'Yesterday',
                due_tomorrow: 'Tomorrow',
                due_2_days_ago: '2 days ago',
                status_submitted: 'Submitted',
                status_pending: 'Pending',
                status_overdue: 'Overdue',
                homework1_title: 'Math: Chapter 5 Problems',
                homework2_title: 'Science: Plant Cell Diagram',
                homework3_title: 'English: Essay on "My Village"',
                attendance_title: 'Attendance',
                present_month_label: 'Present (This Month)',
                this_week_label: 'This Week',
                day_mon: 'Mon',
                day_tue: 'Tue',
                day_wed: 'Wed',
                day_thu: 'Thu',
                day_fri: 'Fri',
                footer_text: '© 2025 EduVaani. Empowering rural learning.',
            }
        };
       
        // Function to create translation objects with English fallback
        const createTranslation = (base) => ({ ...translations['en'], ...base });

        // All 22 Scheduled Languages
        translations['hi'] = createTranslation({
            login_title: 'फ़ोन से लॉगिन करें',
            request_otp: 'ओटीपी का अनुरोध करें',
            verify_otp: 'ओटीपी सत्यापित करें',
            otp_info: 'लॉग इन करने के लिए मॉक ओटीपी दर्ज करें।',
            role_modal_title: 'अपनी भूमिका चुनें',
            role_student: 'छात्र',
            role_teacher: 'शिक्षक',
            role_parent: 'अभिभावक',
            switch_role_button: 'भूमिका बदलें',
            welcome_message: 'नमस्ते, प्रियंका!',
            learning_message: 'आइए, आज कुछ नया सीखें!',
            level_text: 'स्तर',
            daily_quests_title: 'दैनिक कार्य',
            leaderboard_title: 'लीडरबोर्ड',
            badges_title: 'उपलब्धि बैज',
            progress_title: 'मॉड्यूल प्रगति',
            generate_quest_button: '✨ नया कार्य बनाएँ',
            read_aloud_button: '✨ पढ़कर सुनाएं',
            explain_concept_button: '✨ अवधारणा समझाएं',
            badge_star: 'ग्राम सितारा',
            badge_water: 'जल योद्धा',
            badge_bookworm: 'किताबी कीड़ा',
            badge_locked: 'बंद',
            start_button_text: 'शुरू करें',
            seeds_title: 'बीज के प्रकार के बारे में जानें',
            seeds_desc: 'स्थानीय फसलों और उनके बीजों पर एक वीडियो देखें।',
            water_conservation_title: 'हमारे गाँव के खेतों को पानी दें',
            water_conservation_desc: 'संरक्षण के बारे में जानने के लिए फसलों को पानी देने का अनुकरण करें।',
            math_quest_title: 'गणित: क्षेत्र कैलकुलेटर',
            math_quest_desc: 'गणित मॉड्यूल आपको फसल की पैदावार की गणना करना, पानी का उपयोग मापना और खेती के लिए अपना बजट प्रबंधित करना सिखाता है।',
            science_quest_title: 'विज्ञान: हमारे जल स्रोत',
            science_quest_desc: 'इस विज्ञान मॉड्यूल में, आप जल चक्र, अपने गांव में विभिन्न प्रकार के जल स्रोतों और उन्हें कैसे साफ रखें, इसके बारे में जानेंगे।',
            history_quest_title: 'स्थानीय इतिहास: हमारे ग्राम बुजुर्ग',
            history_quest_desc: 'स्थानीय इतिहास मॉड्यूल आपके गांव के बुजुर्गों द्वारा बताई गई कहानियों और परंपराओं की पड़ताल करता है।',
            not_yet_earned: 'अभी तक अर्जित नहीं किया गया',
            loading_quests: 'नया कार्य बना रहा है...',
            loading_audio: 'ऑडियो लोड हो रहा है...',
            loading_explanation: 'व्याख्या उत्पन्न हो रही है...',
            loading_report: 'कक्षा रिपोर्ट उत्पन्न हो रही है...',
            quest_generated_success: 'नया कार्य बनाया गया!',
            quest_already_generated: 'आप एक दिन में केवल एक ही कार्य बना सकते हैं।',
            no_text_to_read: 'पढ़ने के लिए कोई पाठ नहीं है।',
            xp_gained: '+{xp} XP!',
            no_quests: 'कोई कार्य उपलब्ध नहीं है। शुरू करने के लिए एक बनाएं!',
            voice_question_label: 'अपना प्रश्न बोलें:',
            teacher_dashboard_title: 'शिक्षक डैशबोर्ड',
            student_progress_title: 'छात्र प्रगति',
            view_label: 'देखें:',
            view_option_summary: 'कक्षा सारांश',
            view_option_all: 'सभी छात्र',
            generate_report_button: 'रिपोर्ट बनाएं',
            summary_title: 'कक्षा का समग्र प्रदर्शन',
            summary_avg_xp: 'औसत XP',
            summary_avg_level: 'औसत स्तर',
            summary_total_students: 'कुल छात्र',
            class_leaderboard_title: 'कक्षा लीडरबोर्ड',
            reward_title: 'पुरस्कार और मान्यता',
            select_student_placeholder: 'एक छात्र चुनें',
            award_badge_button: 'बैज प्रदान करें',
            assignment_title: 'असाइनमेंट प्रबंधन',
            module_title_label: 'मॉड्यूल शीर्षक',
            description_label: 'विवरण',
            assign_to_label: 'को सौंपें:',
            assign_all: 'सभी छात्र',
            assign_group_a: 'समूह ए',
            assign_group_b: 'समूह बी',
            create_assignment_button: 'असाइनमेंट बनाएं',
            notifications_title: 'सूचनाएं और अलर्ट',
            notification1: "नया मॉड्यूल 'जल संरक्षण' सभी छात्रों को सौंपा गया!",
            notification2: "राजेश ने 'जल योद्धा' बैज हासिल किया।",
            notification3: "मीना ने 'ग्राम सितारा' खोज पूरी कर ली है।",
            parent_welcome: 'नमस्ते, अभिभावक!',
            parent_greeting_morning: 'सुप्रभात, अभिभावक!',
            parent_greeting_afternoon: 'शुभ दोपहर, अभिभावक!',
            parent_greeting_evening: 'शुभ संध्या, अभिभावक!',
            parent_greeting_night: 'आशा है आपका दिन शानदार रहा होगा!',
            child_dashboard_label: "प्रियंका का डैशबोर्ड",
            overall_progress_title: 'समग्र प्रगति',
            learning_level_label: 'सीखने का स्तर',
            points_earned_label: 'अंक अर्जित',
            badges_collected_label: 'बैज एकत्र किए',
            subject_progress_title: 'विषय प्रगति',
            lessons_label: 'पाठ',
            subject_math: 'गणित',
            subject_science: 'विज्ञान',
            subject_english: 'अंग्रेजी',
            homework_title: 'हाल का होमवर्क',
            due_label: 'देय',
            due_yesterday: 'कल',
            due_tomorrow: 'कल',
            due_2_days_ago: '2 दिन पहले',
            status_submitted: 'प्रस्तुत',
            status_pending: 'लंबित',
            status_overdue: 'अतिदेय',
            homework1_title: 'गणित: अध्याय 5 की समस्याएं',
            homework2_title: 'विज्ञान: पादप कोशिका आरेख',
            homework3_title: 'अंग्रेजी: "मेरा गाँव" पर निबंध',
            attendance_title: 'उपस्थिति',
            present_month_label: 'उपस्थित (इस महीने)',
            this_week_label: 'यह सप्ताह',
            day_mon: 'सोम',
            day_tue: 'मंगल',
            day_wed: 'बुध',
            day_thu: 'गुरु',
            day_fri: 'शुक्र',
            footer_text: '© २०२५ एडुवाणी। ग्रामीण शिक्षा को सशक्त बनाना।',
        });
        translations['as'] = createTranslation({
            login_title: 'ফোনৰ সহায়ত লগইন কৰক',
            request_otp: 'ওটিপি অনুৰোধ কৰক',
            verify_otp: 'ওটিপি যাচাই কৰক',
            otp_info: 'লগইন কৰিবলৈ মক ওটিপি প্ৰবিষ্ট কৰক।',
            role_modal_title: 'আপোনাৰ ভূমিকা বাছনি কৰক',
            role_student: 'ছাত্ৰ',
            role_teacher: 'শিক্ষক',
            role_parent: 'অভিভাৱক',
            switch_role_button: 'ভূমিকা সলনি কৰক',
            welcome_message: 'নমস্কাৰ, প্ৰিয়ংকা!',
            learning_message: 'আজি নতুন কিবা এটা শিকোঁ আহক!',
            level_text: 'স্তৰ',
            daily_quests_title: 'দৈনন্দিন কৰ্মসূচী',
            leaderboard_title: 'লিডাৰবোর্ড',
            badges_title: 'উপলব্ধি বেজ',
            progress_title: 'মডিউল অগ্ৰগতি',
            generate_quest_button: '✨ নতুন কৰ্ম নিৰ্মাণ কৰক',
            read_aloud_button: '✨ শব্দেৰে পঢ়ক',
            explain_concept_button: '✨ ধাৰণাটো বুজাই দিয়ক',
            badge_star: 'গ্ৰাম তাৰকা',
            badge_water: 'পানি যোদ্ধা',
            badge_bookworm: 'বইপ্ৰেমী',
            badge_locked: 'লকড',
            start_button_text: 'আৰম্ভ কৰক',

            seeds_title: 'বীজৰ প্ৰকাৰবোৰ জানক',
            seeds_desc: 'স্থানীয় শস্য আৰু বীজসমূহৰ ওপৰত এটা ভিডিঅ’ চাওক।',
            water_conservation_title: 'আমাৰ গাঁৱৰ খেতিলৈ পানি যোগান কৰক',
            water_conservation_desc: 'সংৰক্ষণ সম্পৰ্কে জানিবলৈ খেতিক পানি যোগানৰ অনুকৰণ কৰক।',

            math_quest_title: 'গণিত: ক্ষেত্ৰফল গণক',
            math_quest_desc: 'গণিত মডিউলত আপুনি শস্য উৎপাদন গণনা কৰা, পানিৰ ব্যৱহাৰ মাপি চোৱা আৰু খেতিৰ বাবে বাজেট পৰিচালনা কৰা শিকিব।',

            science_quest_title: 'বিজ্ঞান: আমাৰ পানীৰ উৎস',
            science_quest_desc: 'এই বিজ্ঞান মডিউলত, আপুনি পানীৰ চক্র, গাঁওৰ পানীৰ বিভিন্ন উৎস আৰু সিহঁতক কেনেকৈ পৰিষ্কাৰ ৰাখিব সেইবোৰ শিকিব।',

            history_quest_title: 'স্থানীয় ইতিহাস: আমাৰ গাঁওৰ বয়োজ্যেষ্ঠসকল',
            history_quest_desc: 'স্থানীয় ইতিহাস মডিউলত আপুনি গাঁওৰ বয়োজ্যেষ্ঠসকলে কোৱা কাহিনী আৰু পৰম্পৰাবোৰ জানিব।',

            not_yet_earned: 'এতিয়াও লাভ হোৱা নাই',
            loading_quests: 'নতুন কৰ্ম নিৰ্মাণ কৰা হৈছে...',
            loading_audio: 'অডিঅ’ ল’ড কৰা হৈছে...',
            loading_explanation: 'ব্যাখ্যা প্ৰস্তুত কৰা হৈছে...',
            loading_report: 'ক্লাছ প্ৰতিবেদন প্ৰস্তুত কৰা হৈছে...',
            quest_generated_success: 'নতুন কৰ্ম নিৰ্মাণ হৈছে!',
            quest_already_generated: 'এদিনত কেৱল এটা কৰ্ম নিৰ্মাণ কৰিব পাৰিব।',
            no_text_to_read: 'পঢ়িবলৈ কোনো পাঠ নাই।',
            xp_gained: '+{xp} XP!',
            no_quests: 'কোনো কৰ্ম উপলব্ধ নাই। আৰম্ভ কৰিবলৈ এটা নিৰ্মাণ কৰক!',
            voice_question_label: 'আপোনাৰ প্ৰশ্নটো কওক:',

            teacher_dashboard_title: 'শিক্ষক ড্যাশব’ৰ্ড',
            student_progress_title: 'ছাত্ৰৰ অগ্ৰগতি',
            view_label: 'চাওক:',
            view_option_summary: 'ক্লাছ সাৰাংশ',
            view_option_all: 'সকলো ছাত্ৰ',
            generate_report_button: 'প্ৰতিবেদন নিৰ্মাণ কৰক',
            summary_title: 'ক্লাছৰ সামগ্ৰিক কাৰ্যক্ষমতা',
            summary_avg_xp: 'গড় XP',
            summary_avg_level: 'গড় স্তৰ',
            summary_total_students: 'মুঠ ছাত্ৰ',
            class_leaderboard_title: 'ক্লাছ লিডাৰবোর্ড',

            reward_title: 'পুৰস্কাৰ আৰু স্বীকৃতি',
            select_student_placeholder: 'এজন ছাত্ৰ বাছনি কৰক',
            award_badge_button: 'বেজ প্ৰদান কৰক',

            assignment_title: 'অ্যাসাইনমেন্ট পৰিচালনা',
            module_title_label: 'মডিউল শিৰোনাম',
            description_label: 'বিৱৰণ',
            assign_to_label: 'দিয়ক:',
            assign_all: 'সকলো ছাত্ৰ',
            assign_group_a: 'দল A',
            assign_group_b: 'দল B',
            create_assignment_button: 'অ্যাসাইনমেন্ট নিৰ্মাণ কৰক',

            notifications_title: 'অধিসূচনা আৰু সতৰ্কবাৰ্তা',
            notification1: "নতুন মডিউল 'পানি সংৰক্ষণ' সকলো ছাত্ৰলৈ প্ৰেৰণ কৰা হৈছে!",
            notification2: "ৰাজেশে 'পানি যোদ্ধা' বেজ অৰ্জন কৰিছে।",
            notification3: "মীণাই 'গ্ৰাম তাৰকা' কৰ্ম সম্পূৰ্ণ কৰিছে।",

            parent_welcome: 'নমস্কাৰ, অভিভাৱক!',
            parent_greeting_morning: 'সুপ্ৰভাত, অভিভাৱক!',
            parent_greeting_afternoon: 'শুভ দুপুর, অভিভাৱক!',
            parent_greeting_evening: 'শুভ সন্ধ্যা, অভিভাৱক!',
            parent_greeting_night: 'আশা কৰোঁ আপোনাৰ দিনটো অসাধাৰণ হৈছিল!',

            child_dashboard_label: 'প্ৰিয়ংকাৰ ড্যাশব’ৰ্ড',
            overall_progress_title: 'সামগ্ৰিক অগ্ৰগতি',
            learning_level_label: 'শিকাৰ স্তৰ',
            points_earned_label: 'পইণ্ট অৰ্জন',
            badges_collected_label: 'বেজ সংগ্ৰহ',
            subject_progress_title: 'বিষয়ৰ অগ্ৰগতি',
            lessons_label: 'পাঠ',
            subject_math: 'গণিত',
            subject_science: 'বিজ্ঞান',
            subject_english: 'ইংৰাজী',

            homework_title: 'শেহতীয়া গৃহকাৰ্য্য',
            due_label: 'সময়সীমা',
            due_yesterday: 'কালি',
            due_tomorrow: 'আজি পিছত',
            due_2_days_ago: '২ দিন আগতে',
            status_submitted: 'জমা দিয়া হৈছে',
            status_pending: 'অপেক্ষাৰত',
            status_overdue: 'সময় অতিক্ৰম',

            homework1_title: 'গণিত: অধ্যায় ৫ৰ প্ৰশ্নসমূহ',
            homework2_title: 'বিজ্ঞান: উদ্ভিদ কোষৰ আখ্যা',
            homework3_title: 'ইংৰাজী: "মোৰ গাঁও"ৰ ওপৰত প্ৰবন্ধ',

            attendance_title: 'উপস্থিতি',
            present_month_label: 'উপস্থিতি (এই মাহত)',
            this_week_label: 'এই সপ্তাহ',
            day_mon: 'সোম',
            day_tue: 'মঙ্গল',
            day_wed: 'বুধ',
            day_thu: 'বৃহ',
            day_fri: 'শুক্ৰ',

            footer_text: '© ২০২৫ এডুভাণী। গ্ৰাম্য শিক্ষা শক্তিশালীকৰণ।'  
        });
        translations['bn'] = createTranslation({
            login_title: 'ফোন দিয়ে লগইন করুন',
            request_otp: 'OTP অনুরোধ করুন',
            verify_otp: 'OTP যাচাই করুন',
            otp_info: 'লগ ইন করতে মক ওটিপি লিখুন।',
            role_modal_title: 'আপনার ভূমিকা নির্বাচন করুন',
            role_student: 'ছাত্র',
            role_teacher: 'শিক্ষক',
            role_parent: 'অভিভাবক',
            switch_role_button: 'ভূমিকা পরিবর্তন করুন',
            welcome_message: 'নমস্কার, প্রিয়াঙ্কা!',
            learning_message: 'আসুন, আজ নতুন কিছু শিখি!',
            level_text: 'স্তর',
            daily_quests_title: 'দৈনিক কাজ',
            leaderboard_title: 'লিডারবোর্ড',
            badges_title: 'কৃতিত্বের ব্যাজ',
            progress_title: 'মডিউল অগ্রগতি',
            generate_quest_button: '✨ নতুন কাজ তৈরি করুন',
            read_aloud_button: '✨ জোরে পড়ুন',
            explain_concept_button: '✨ ধারণাটি ব্যাখ্যা করুন',
            badge_star: 'গ্রামের তারকা',
            badge_water: 'জল যোদ্ধা',
            badge_bookworm: 'বইপোকা',
            badge_locked: 'লক করা',
            start_button_text: 'শুরু করুন',
            seeds_title: 'বীজের প্রকার সম্পর্কে জানুন',
            seeds_desc: 'স্থানীয় ফসল এবং তাদের বীজ নিয়ে একটি ভিডিও দেখুন।',
            water_conservation_title: 'আমাদের গ্রামের জমিতে জল দিন',
            water_conservation_desc: 'সংরক্ষণ সম্পর্কে জানতে ফসলকে জল দেওয়ার অনুকরণ করুন।',
            math_quest_title: 'গণিত: ক্ষেত্র ক্যালকুলেটর',
            math_quest_desc: 'গণিত মডিউল আপনাকে ফসলের ফলন গণনা করতে, জলের ব্যবহার পরিমাপ করতে এবং চাষের জন্য আপনার বাজেট পরিচালনা করতে শেখায়।',
            science_quest_title: 'বিজ্ঞান: আমাদের জলের উৎস',
            science_quest_desc: 'এই বিজ্ঞান মডিউলে, আপনি জলচক্র, আপনার গ্রামের বিভিন্ন ধরণের জলের উৎস এবং সেগুলি কীভাবে পরিষ্কার রাখতে হয় সে সম্পর্কে জানবেন।',
            history_quest_title: 'স্থানীয় ইতিহাস: আমাদের গ্রামের প্রবীণরা',
            history_quest_desc: 'স্থানীয় ইতিহাস মডিউলটি আপনার গ্রামের প্রবীণদের কাছ থেকে প্রাপ্ত গল্প এবং ঐতিহ্যগুলি অন্বেষণ করে।',
            not_yet_earned: 'এখনও অর্জিত হয়নি',
            loading_quests: 'নতুন কাজ তৈরি হচ্ছে...',
            loading_audio: 'অডিও লোড হচ্ছে...',
            loading_explanation: 'ব্যাখ্যা তৈরি হচ্ছে...',
            loading_report: 'ক্লাসের রিপোর্ট তৈরি হচ্ছে...',
            quest_generated_success: 'নতুন কাজ তৈরি হয়েছে!',
            quest_already_generated: 'আপনি দিনে শুধুমাত্র একটি কাজ তৈরি করতে পারেন।',
            no_text_to_read: 'পড়ার জন্য কোন লেখা নেই।',
            xp_gained: '+{xp} XP!',
            no_quests: 'কোন কাজ উপলব্ধ নেই। শুরু করতে একটি তৈরি করুন!',
            voice_question_label: 'আপনার প্রশ্ন বলুন:',
            teacher_dashboard_title: 'শিক্ষকের ড্যাশবোর্ড',
            student_progress_title: 'ছাত্রের অগ্রগতি',
            view_label: 'দেখুন:',
            view_option_summary: 'ক্লাসের সারাংশ',
            view_option_all: 'সমস্ত ছাত্র',
            generate_report_button: 'রিপোর্ট তৈরি করুন',
            summary_title: 'ক্লাসের সামগ্রিক পারফরম্যান্স',
            summary_avg_xp: 'গড় XP',
            summary_avg_level: 'গড় স্তর',
            summary_total_students: 'মোট ছাত্র',
            class_leaderboard_title: 'ক্লাসের লিডারবোর্ড',
            reward_title: 'পুরস্কার এবং স্বীকৃতি',
            select_student_placeholder: 'একজন ছাত্র নির্বাচন করুন',
            award_badge_button: 'ব্যাজ প্রদান করুন',
            assignment_title: 'অ্যাসাইনমেন্ট ম্যানেজমেন্ট',
            module_title_label: 'মডিউল শিরোনাম',
            description_label: 'বিবরণ',
            assign_to_label: 'এদেরকে দিন:',
            assign_all: 'সমস্ত ছাত্র',
            assign_group_a: 'গ্রুপ এ',
            assign_group_b: 'গ্রুপ বি',
            create_assignment_button: 'অ্যাসাইনমেন্ট তৈরি করুন',
            notifications_title: 'বিজ্ঞপ্তি এবং সতর্কতা',
            notification1: "নতুন মডিউল 'জল সংরক্ষণ' সমস্ত ছাত্রদের দেওয়া হয়েছে!",
            notification2: "রাজেশ 'জল যোদ্ধা' ব্যাজ অর্জন করেছে।",
            notification3: "মীনা 'গ্রামের তারকা' কোয়েস্ট সম্পন্ন করেছে।",
            parent_welcome: 'নমস্কার, অভিভাবক!',
            parent_greeting_morning: 'সুপ্রভাত, অভিভাবক!',
            parent_greeting_afternoon: 'শুভ বিকাল, অভিভাবক!',
            parent_greeting_evening: 'শুভ সন্ধ্যা, অভিভাবক!',
            parent_greeting_night: 'আশা করি আপনার দিনটি ভালো কেটেছে!',
            child_dashboard_label: "প্রিয়াঙ্কা ড্যাশবোর্ড",
            overall_progress_title: 'সামগ্রিক অগ্রগতি',
            learning_level_label: 'শেখার স্তর',
            points_earned_label: 'অর্জিত পয়েন্ট',
            badges_collected_label: 'সংগৃহীত ব্যাজ',
            subject_progress_title: 'বিষয় অগ্রগতি',
            lessons_label: 'পাঠ',
            subject_math: 'গণিত',
            subject_science: 'বিজ্ঞান',
            subject_english: 'ইংরেজি',
            homework_title: 'সাম্প্রতিক হোমওয়ার্ক',
            due_label: 'দেয়',
            due_yesterday: 'গতকাল',
            due_tomorrow: 'আগামীকাল',
            due_2_days_ago: '২ দিন আগে',
            status_submitted: 'জমা দেওয়া হয়েছে',
            status_pending: 'বিচারাধীন',
            status_overdue: 'বিলম্বিত',
            homework1_title: 'গণিত: অধ্যায় ৫ এর সমস্যা',
            homework2_title: 'বিজ্ঞান: উদ্ভিদ কোষের চিত্র',
            homework3_title: 'ইংরেজি: "আমার গ্রাম" উপর প্রবন্ধ',
            attendance_title: 'উপস্থিতি',
            present_month_label: 'উপস্থিত (এই মাসে)',
            this_week_label: 'এই সপ্তাহ',
            day_mon: 'সোম',
            day_tue: 'মঙ্গল',
            day_wed: 'বুধ',
            day_thu: 'বৃহস্পতি',
            day_fri: 'শুক্র',
            footer_text: '© ২০২৫ এডুবাণী। গ্রামীণ শিক্ষাকে শক্তিশালী করা।',
        });
        translations['brx'] = createTranslation({
            role_modal_title: 'नोंनि भुमिकाखौ सायख’', role_student: 'फरायसा', role_teacher: 'मास्टर', role_parent: 'अभिभावक', welcome_message: 'खुलुमबाय, प्रियंका!', footer_text: '© २०२५ एडुबाणी। गामिआरि सोलोंथाइखौ गोख्रों खालामनाय।', teacher_dashboard_title: 'मास्टरनि डेश्बर्ड', parent_welcome: 'खुलुमबाय, अभिभावक!', child_dashboard_label: "प्रियंका डेश्बर्ड",
        });
        translations['doi'] = createTranslation({
            role_modal_title: 'अपनी भूमिका चुनो', role_student: 'विद्यार्थी', role_teacher: 'अध्यापक', role_parent: 'माਪिਓ', welcome_message: 'नमस्ते, प्रियंका!', footer_text: '© २०२५ एडुवाणी। ग्रामीण शिक्षा गी सशक्त बनाओआ।', teacher_dashboard_title: 'अध्यापक दा डैशबोर्ड', parent_welcome: 'नमस्ते, माँ-प्यो!', child_dashboard_label: "प्रियंका दा डैशबोर्ड",
        });
        translations['gu'] = createTranslation({
            login_title: 'ફોન દ્વારા લૉગિન કરો',
            request_otp: 'ઓટીપી માંગો',
            verify_otp: 'ઓટીપી ચકાસો',
            otp_info: 'લૉગિન કરવા માટે મૉક ઓટીપી દાખલ કરો.',
            role_modal_title: 'તમારી ભૂમિકા પસંદ કરો',
            role_student: 'વિદ્યાર્થી',
            role_teacher: 'શિક્ષક',
            role_parent: 'વાલી',
            switch_role_button: 'ભૂમિકા બદલો',
            welcome_message: 'નમસ્તે, પ્રિયંકા!',
            learning_message: 'આવો, આજે કંઈક નવું શીખીએ!',
            level_text: 'સ્તર',
            daily_quests_title: 'દૈનિક કાર્ય',
            leaderboard_title: 'લીડરબોર્ડ',
            badges_title: 'સફળતા બેજ',
            progress_title: 'મોડ્યુલ પ્રગતિ',
            generate_quest_button: '✨ નવું કાર્ય બનાવો',
            read_aloud_button: '✨ વાંચી બતાવો',
            explain_concept_button: '✨ સમજાવો',
            badge_star: 'ગામનો તારો',
            badge_water: 'જળ યુદ્ધા',
            badge_bookworm: 'પુસ્તકપ્રેમી',
            badge_locked: 'લૉક કર્યું',
            start_button_text: 'શરૂ કરો',

            seeds_title: 'બીજના પ્રકારો જાણો',
            seeds_desc: 'સ્થાનિક પાક અને તેમના બીજ પર વિડિયો જુઓ.',
            water_conservation_title: 'અમારા ગામના ખેતરોને પાણી આપો',
            water_conservation_desc: 'જળ સંરક્ષણ વિશે શીખવા માટે ખેતરને પાણી આપવાનો અનુભવ કરો.',

            math_quest_title: 'ગણિત: વિસ્તાર કેલ્ક્યુલેટર',
            math_quest_desc: 'ગણિત મોડ્યુલ તમને પાકનું ઉત્પાદન ગણવું, પાણીનો ઉપયોગ માપવું અને ખેતી માટે બજેટ સંચાલન શીખવે છે.',

            science_quest_title: 'વિજ્ઞાન: આપણા જળસ્રોતો',
            science_quest_desc: 'આ વિજ્ઞાન મોડ્યુલમાં, તમે પાણી ચક્ર, ગામના વિવિધ જળસ્રોતો અને તેમને કેવી રીતે સ્વચ્છ રાખવા તે વિશે શીખશો.',

            history_quest_title: 'સ્થાનિક ઇતિહાસ: અમારા ગામના વડીલો',
            history_quest_desc: 'સ્થાનિક ઇતિહાસ મોડ્યુલ તમારા ગામના વડીલો દ્વારા કહેવામાં આવેલી વાર્તાઓ અને પરંપરાઓને શોધે છે.',

            not_yet_earned: 'હજુ સુધી પ્રાપ્ત નથી',
            loading_quests: 'નવું કાર્ય બનાવી રહ્યું છે...',
            loading_audio: 'ઑડિયો લોડ થઈ રહ્યું છે...',
            loading_explanation: 'સમજાવટ તૈયાર થઈ રહી છે...',
            loading_report: 'વર્ગ રિપોર્ટ તૈયાર થઈ રહ્યો છે...',
            quest_generated_success: 'નવું કાર્ય બનાવાયું!',
            quest_already_generated: 'તમે એક દિવસમાં ફક્ત એક કાર્ય બનાવી શકો છો.',
            no_text_to_read: 'વાંચવા માટે કોઈ લખાણ નથી.',
            xp_gained: '+{xp} XP!',
            no_quests: 'કોઈ કાર્ય ઉપલબ્ધ નથી. શરૂ કરવા માટે કાર્ય બનાવો!',
            voice_question_label: 'તમારો પ્રશ્ન બોલો:',

            teacher_dashboard_title: 'શિક્ષક ડેશબોર્ડ',
            student_progress_title: 'વિદ્યાર્થી પ્રગતિ',
            view_label: 'જોવું:',
            view_option_summary: 'વર્ગ સારાંશ',
            view_option_all: 'બધા વિદ્યાર્થીઓ',
            generate_report_button: 'રિપોર્ટ બનાવો',
            summary_title: 'વર્ગની કુલ કામગીરી',
            summary_avg_xp: 'સરેરાશ XP',
            summary_avg_level: 'સરેરાશ સ્તર',
            summary_total_students: 'કુલ વિદ્યાર્થીઓ',
            class_leaderboard_title: 'વર્ગ લીડરબોર્ડ',

            reward_title: 'ઇનામ અને માન્યતા',
            select_student_placeholder: 'વિદ્યાર્થી પસંદ કરો',
            award_badge_button: 'બેજ આપો',

            assignment_title: 'સોંપણી વ્યવસ્થાપન',
            module_title_label: 'મોડ્યુલ શીર્ષક',
            description_label: 'વર્ણન',
            assign_to_label: 'સોંપવું:',
            assign_all: 'બધા વિદ્યાર્થીઓ',
            assign_group_a: 'સમૂહ A',
            assign_group_b: 'સમૂહ B',
            create_assignment_button: 'સોંપણી બનાવો',

            notifications_title: 'સૂચનાઓ અને ચેતવણીઓ',
            notification1: "નવું મોડ્યુલ 'જળ સંરક્ષણ' બધા વિદ્યાર્થીઓને સોંપવામાં આવ્યું!",
            notification2: "રાજેશે 'જળ યુદ્ધા' બેજ જીત્યો.",
            notification3: "મીનાએ 'ગામનો તારો' કાર્ય પૂર્ણ કર્યું.",

            parent_welcome: 'નમસ્તે, વાલી!',
            parent_greeting_morning: 'સુપ્રભાત, વાલી!',
            parent_greeting_afternoon: 'શુભ બપોર, વાલી!',
            parent_greeting_evening: 'શુભ સાંજ, વાલી!',
            parent_greeting_night: 'આશા છે કે તમારો દિવસ સુંદર ગયો હશે!',

            child_dashboard_label: 'પ્રિયંકાનું ડેશબોર્ડ',
            overall_progress_title: 'કુલ પ્રગતિ',
            learning_level_label: 'શિક્ષણ સ્તર',
            points_earned_label: 'અંક મેળવ્યા',
            badges_collected_label: 'બેજ એકત્રિત કર્યા',
            subject_progress_title: 'વિષય પ્રગતિ',
            lessons_label: 'પાઠો',
            subject_math: 'ગણિત',
            subject_science: 'વિજ્ઞાન',
            subject_english: 'અંગ્રેજી',

            homework_title: 'તાજેતરનું હોમવર્ક',
            due_label: 'સમયમર્યાદા',
            due_yesterday: 'ગઈકાલે',
            due_tomorrow: 'કાલે',
            due_2_days_ago: '2 દિવસ પહેલા',
            status_submitted: 'સબમિટ કર્યું',
            status_pending: 'બાકી છે',
            status_overdue: 'મિયાદ પૂરી થઈ',

            homework1_title: 'ગણિત: અધ્યાય 5 ના પ્રશ્નો',
            homework2_title: 'વિજ્ઞાન: છોડના કોષનું આલેખન',
            homework3_title: 'અંગ્રેજી: "મારું ગામ" પર નિબંધ',

            attendance_title: 'હાજરી',
            present_month_label: 'હાજરી (આ મહિને)',
            this_week_label: 'આ અઠવાડિયું',
            day_mon: 'સોમ',
            day_tue: 'મંગળ',
            day_wed: 'બુધ',
            day_thu: 'ગુરૂ',
            day_fri: 'શુક્ર',

            footer_text: '© ૨૦૨૫ એડુવાણી. ગ્રામ્ય શિક્ષણને સશક્ત બનાવવું.'
        });
        translations['kn'] = createTranslation({
            role_modal_title: 'ನಿಮ್ಮ ಪಾತ್ರವನ್ನು ಆಯ್ಕೆಮಾಡಿ', role_student: 'ವಿದ್ಯಾರ್ಥಿ', role_teacher: 'ಶಿಕ್ಷಕ', role_parent: 'ಪೋಷಕ', welcome_message: 'ನಮಸ್ಕಾರ, ಪ್ರಿಯಾಂಕಾ!', footer_text: '© ೨೦೨೫ ಎಡುವಾಣಿ. ಗ್ರಾಮೀಣ ಕಲಿಕೆಯನ್ನು ಸಶಕ್ತಗೊಳಿಸುವುದು.', teacher_dashboard_title: 'ಶಿಕ್ಷಕರ ಡ್ಯಾಶ್‌ಬೋರ್ಡ್', parent_welcome: 'ಸ್ವಾಗತ, ಪೋಷಕ!', child_dashboard_label: "ಪ್ರಿಯಾಂಕಾ ಅವರ ಡ್ಯಾಶ್‌ಬೋರ್ಡ್",
        });
        translations['ks'] = createTranslation({
            role_modal_title: 'پنُن کردار ژارٕنؠ', role_student: 'طٲلبہِ عٔلِم', role_teacher: 'اُستاد', role_parent: 'مول موج', welcome_message: 'آدا̱ب , پرینکا!', footer_text: '© ۲۰۲۵ ایجوانی۔ ગ્રામیણ تٲلیٖم مضبوٗط بناوُن۔', teacher_dashboard_title: 'استاد سُنٛد ڈیش بورڈ', parent_welcome: 'خوش آمدید, والدین!', child_dashboard_label: "  روہن سُنٛد ڈیش بورڈ",
        });
        translations['kok'] = createTranslation({
            role_modal_title: 'तुमची भूमिका निवडा', role_student: 'विद्यार्थी', role_teacher: 'शिक्षक', role_parent: 'पालक', welcome_message: 'नमस्कार, प्रियंका!', footer_text: '© २०२५ एडुवाणी. ग्रामीण शिक्षणाक सक्षमीकरण.', teacher_dashboard_title: 'शिक्षक डॅशबोर्ड', parent_welcome: 'येवकार, पालक!', child_dashboard_label: "रोहनचो डॅशबोर्ड",
        });
        translations['mai'] = createTranslation({
            role_modal_title: 'अपन भूमिका चुनु', role_student: 'विद्यार्थी', role_teacher: 'शिक्षक', role_parent: 'अभिभावक', welcome_message: 'प्रणाम, प्रियंका!', footer_text: '© २०२५ एडुवाणी। ग्रामीण शिक्षा के सशक्तिकरण।', teacher_dashboard_title: 'शिक्षक डैशबोर्ड', parent_welcome: 'स्वागत अछि, अभिभावक!', child_dashboard_label: "प्रियंका डैशबोर्ड",
        });
        translations['ml'] = createTranslation({
            role_modal_title: 'നിങ്ങളുടെ പങ്ക് തിരഞ്ഞെടുക്കുക', role_student: 'വിദ്യാർത്ഥി', role_teacher: 'അധ്യാപകൻ', role_parent: 'രക്ഷകർത്താവ്', welcome_message: 'നമസ്കാരം, പ്രിയങ്ക!', footer_text: '© 2025 എഡുവാണി. ഗ്രാമീണ പഠനത്തെ ശാക്തീകരിക്കുന്നു.', teacher_dashboard_title: 'അധ്യാപകന്റെ ഡാഷ്‌ബോർഡ്', parent_welcome: 'സ്വാഗതം, രക്ഷിതാവേ!', child_dashboard_label: "രോഹന്റെ ഡാഷ്‌ബോർഡ്",
        });
        translations['mni'] = createTranslation({
            role_modal_title: 'নহাক্কী থৌদাং খনবীয়ু', role_student: 'মহৈরোই', role_teacher: 'ওজা', role_parent: 'মমা-মপা', welcome_message: 'খুরুমজরি, প্রিয়ঙ্কা!', footer_text: '© ২০২১ এদুৱানি। খুঙ্গংগী মহৈ-মশিংদা শক্তি পীব।', teacher_dashboard_title: 'ওজাশিংগী ডেশবোর্ড', parent_welcome: 'তরাম্না ওকচরি, মমা-মপা!', child_dashboard_label: "রোহনগী ডেশবোর্ড",
        });
        translations['mr'] = createTranslation({
            role_modal_title: 'तुमची भूमिका निवडा', role_student: 'विद्यार्थी', role_teacher: 'शिक्षक', role_parent: 'पालक', welcome_message: 'नमस्कार, प्रियंका!', footer_text: '© २०२५ एडुवाणी. ग्रामीण शिक्षणाचे सक्षमीकरण.', teacher_dashboard_title: 'शिक्षक डॅशबोर्ड', parent_welcome: 'स्वागत आहे, पालक!', child_dashboard_label: "प्रियंकाचे डॅशबोर्ड",
        });
        translations['ne'] = createTranslation({
            role_modal_title: 'आफ्नो भूमिका छान्नुहोस्', role_student: 'विद्यार्थी', role_teacher: 'शिक्षक', role_parent: 'अभिभावक', welcome_message: 'नमस्ते, प्रियंका!', footer_text: '© २०२५ एडुवाणी। ग्रामीण शिक्षालाई सशक्त बनाउँदै।', teacher_dashboard_title: 'शिक्षक ड्यासबोर्ड', parent_welcome: 'स्वागत छ, अभिभावक!', child_dashboard_label: "प्रियंकाको ड्यासबोर्ड",
        });
        translations['or'] = createTranslation({
            role_modal_title: 'ଆପଣଙ୍କ ଭୂମିକା ବାଛନ୍ତୁ', role_student: 'ଛାତ୍ର', role_teacher: 'ଶିକ୍ଷକ', role_parent: 'ଅଭିଭାବକ', welcome_message: 'ନମସ୍କାର, ପ୍ରିୟଙ୍କା!', footer_text: '© ୨୦୨୫ ଏଡୁବାଣୀ। ଗ୍ରାମୀଣ ଶିକ୍ଷାକୁ ସଶକ୍ତ କରିବା।', teacher_dashboard_title: 'ଶିକ୍ଷକ ଡ୍ୟାସବୋର୍ଡ', parent_welcome: 'ସ୍ୱାଗତ, ଅଭିଭାବକ!', child_dashboard_label: "ରୋହନଙ୍କ ଡ୍ୟାସବୋର୍ଡ",
        });
        translations['pa'] = createTranslation({
            role_modal_title: 'ਆਪਣੀ ਭੂਮਿਕਾ ਚੁਣੋ', role_student: 'ਵਿਦਿਆਰਥੀ', role_teacher: 'ਅਧਿਆਪਕ', role_parent: 'ਮਾਪੇ', welcome_message: 'ਸਤਿ ਸ੍ਰੀ ਅਕਾਲ, ਪ੍ਰਿਅੰਕਾ!', footer_text: '© 2025 ਐਜੂਵਾਣੀ। ਪੇਂਡੂ ਸਿਖਲਾਈ ਨੂੰ ਸ਼ਕਤੀ ਪ੍ਰਦਾਨ ਕਰਨਾ।', teacher_dashboard_title: 'ਅਧਿਆਪਕ ਡੈਸ਼ਬੋਰਡ', parent_welcome: 'ਜੀ ਆਇਆਂ ਨੂੰ, ਮਾਪਿਓ!', child_dashboard_label: "ਰੋਹਨ ਦਾ ਡੈਸ਼ਬੋਰਡ",
        });
        translations['sa'] = createTranslation({
            role_modal_title: 'स्वभूमिकां चिनोतु', role_student: 'छात्रः', role_teacher: 'शिक्षकः', role_parent: 'पालकः', welcome_message: 'नमस्ते, प्रियंका!', footer_text: '© २०२५ एडुवाणी। ग्रामीणशिक्षणस्य सशक्तीकरणम्।', teacher_dashboard_title: 'शिक्षकस्य सूचनाफलकम्', parent_welcome: 'स्वागतम्, पालक!', child_dashboard_label: "प्रियंकास्य सूचनाफलकम्",
        });
        translations['sat'] = createTranslation({
            role_modal_title: 'ᱟᱢᱟᱜ ᱠᱟᱹᱢᱤ ᱵᱟᱪᱷᱟᱣ ᱢᱮ', role_student: 'ᱯᱟᱹଠᱩᱣᱟᱹ', role_teacher: 'ᱢᱟᱪᱮᱫ', role_parent: 'ᱜᱚᱜᱚ-ᱵᱟᱵᱟ', welcome_message: 'ᱡᱚᱦᱟᱨ, ᱯᱨᱤᱭᱚᱝᱠᱟ!', footer_text: '© 2025 ᱮᱰᱩᱣᱟᱬᱤ᱿ ᱟᱹᱛᱩ ᱚᱱᱪᱚᱞ ᱨᱮᱱ ᱥᱮᱪᱮᱫ ᱫᱟᱲᱮ ᱮᱢᱚᱜ᱿', teacher_dashboard_title: 'माचेद डासबोर्ड', parent_welcome: 'जोहार, गोगो-बाबा!', child_dashboard_label: "प्रियंकाअः डासबोर्ड",
        });
        translations['sd'] = createTranslation({
            role_modal_title: 'پنهنجو ڪردار چونڊيو', role_student: 'شاگرد', role_teacher: 'استاد', role_parent: 'والدين', welcome_message: 'नमस्कार, प्रियंका!', footer_text: '© 2025 ايڊوواڻي. ڳوٺاڻي سکيا کي با اختيار بڻائڻ.', teacher_dashboard_title: 'استاد ڊيش بورڊ', parent_welcome: 'ڀلي ڪري آيا، والدين!', child_dashboard_label: "روهن جو ڊيش بورڊ",
        });
        translations['ta'] = createTranslation({
            role_modal_title: 'உங்கள் பங்கைத் தேர்ந்தெடுக்கவும்', role_student: 'மாணவர்', role_teacher: 'ஆசிரியர்', role_parent: 'பெற்றோர்', welcome_message: 'வணக்கம், பிரியங்கா!', footer_text: '© 2025 எடுவாணி. கிராமப்புற கற்றலை மேம்படுத்துதல்.', teacher_dashboard_title: 'ஆசிரியர் டாஷ்போர்டு', parent_welcome: 'வருக, பெற்றோர்!', child_dashboard_label: "ரோஹனின் டாஷ்போர்டு",
        });
        translations['te'] = createTranslation({
            role_modal_title: 'మీ పాత్రను ఎంచుకోండి', role_student: 'విద్యార్థి', role_teacher: 'ఉపాధ్యాయుడు', role_parent: 'తల్లిదండ్రులు', welcome_message: 'నమస్കാരം, ప్రియాంక!', footer_text: '© 2025 எடுவானি. గ్రామీణ అభ్యాస సాధికారత.', teacher_dashboard_title: 'ఉపాధ్యాయ డ్యాష్‌బోర్డ్', parent_welcome: 'స్వాగతం, తల్లిదండ్రులారా!', child_dashboard_label: "రోహన్ డ్యాష్‌బోర్డ్",
        });
        translations['ur'] = createTranslation({
            role_modal_title: 'اپنا کردار منتخب کریں', role_student: 'طالب علم', role_teacher: 'استاد', role_parent: 'والدین', welcome_message: 'آداب, پرینکا!', footer_text: '© 2025 ایڈیونی۔ دیہی تعلیم کو بااختیار بنانا۔', teacher_dashboard_title: 'استاد کا ڈیش بورڈ', parent_welcome: 'خوش آمدید، والدین!', child_dashboard_label: "روہن کا ڈیش بورڈ",
        });


        // --- Message Box Utility ---
        function showMessage(text, type = 'success') {
            const container = document.getElementById('message-container');
            const messageText = document.getElementById('message-text');
            let bgColor = 'bg-blue-500';
            if (type === 'error') bgColor = 'bg-red-500';
            if (type === 'success') bgColor = 'bg-green-500';
            container.className = `fixed top-5 left-1/2 -translate-x-1/2 text-white px-6 py-3 rounded-full shadow-lg z-50 transform scale-0 opacity-0 transition-all duration-300 ${bgColor}`;
            messageText.textContent = text;
            setTimeout(() => {
                container.style.transform = 'translate(-50%, 0) scale(1)';
                container.style.opacity = '1';
            }, 10);
            setTimeout(() => {
                container.style.transform = 'translate(-50%, -20px) scale(0.9)';
                container.style.opacity = '0';
            }, 3000);
        }
       
        // Helper function for Base64 to ArrayBuffer conversion
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Helper function to convert raw PCM to WAV format
        function pcmToWav(pcmData, sampleRate) {
            const dataLength = pcmData.byteLength;
            const buffer = new ArrayBuffer(44 + dataLength);
            const view = new DataView(buffer);
            let offset = 0;

            view.setUint32(offset, 0x52494646, false); offset += 4; // "RIFF"
            view.setUint32(offset, 36 + dataLength, true); offset += 4; // file size
            view.setUint32(offset, 0x57415645, false); offset += 4; // "WAVE"

            view.setUint32(offset, 0x666d7420, false); offset += 4; // "fmt "
            view.setUint32(offset, 16, true); offset += 4; // chunk size
            view.setUint16(offset, 1, true); offset += 2; // channels
            view.setUint32(offset, sampleRate, true); offset += 4; // sample rate
            view.setUint32(offset, sampleRate * 2, true); offset += 4; // byte rate
            view.setUint16(offset, 2, true); offset += 2; // block align
            view.setUint16(offset, 16, true); offset += 2; // bits per sample

            view.setUint32(offset, 0x64617461, false); offset += 4; // "data"
            view.setUint32(offset, dataLength, true); offset += 4; // chunk size

            const pcmBytes = new Int16Array(buffer, offset);
            pcmBytes.set(new Int16Array(pcmData));

            return new Blob([view], { type: 'audio/wav' });
        }


        // --- UI Rendering Functions for Student Dashboard ---
        function renderStudentQuests(quests) {
            const questList = document.getElementById('student-quest-list');
            questList.innerHTML = '';
            const lang = localStorage.getItem('userLanguage') || 'en';
            const t = translations[lang] || translations['en'];

            if (quests.length === 0) {
                questList.innerHTML = `<p class="text-center text-gray-500">${t.no_quests}</p>`;
                return;
            }
            quests.forEach(quest => {
                const questHtml = `
                    <div class="bg-gray-50 rounded-lg p-8 flex flex-col sm:flex-row items-center justify-between hover:bg-gray-100 transition-colors duration-200">
                        <div>
                            <div class="font-extrabold text-2xl text-gray-900 mb-2">${t[`${quest.id}_title`] || quest.id}</div>
                            <p class="text-lg text-gray-600">${t[`${quest.id}_desc`] || ''}</p>
                        </div>
                        <div class="mt-6 sm:mt-0 flex items-center space-x-4">
                            <span class="text-yellow-600 font-bold text-2xl">+${quest.xp} XP</span>
                            <button class="bg-blue-500 text-white text-lg px-4 py-2 rounded-full font-bold shadow-lg explain-quest-btn" data-desc="${t[`${quest.id}_desc`] || ''}">
                                <span>${t.explain_concept_button}</span>
                            </button>
                            <button class="btn-start text-white text-lg px-8 py-4 rounded-full font-bold shadow-lg student-start-quest-btn" data-xp="${quest.xp}">
                                <span>${t.start_button_text}</span>
                            </button>
                        </div>
                    </div>
                `;
                questList.insertAdjacentHTML('beforeend', questHtml);
            });
        }
        function renderStudentLeaderboard(leaderboardData) {
            const leaderboardList = document.getElementById('student-leaderboard-list');
            leaderboardList.innerHTML = '';
            const allUsers = [...leaderboardData, { name: studentData.name, xp: studentData.xp, id: userId }];
            const sortedUsers = allUsers.sort((a, b) => b.xp - a.xp).slice(0, 5);
            sortedUsers.forEach((user, index) => {
                const isCurrentUser = user.id === userId;
                const itemClass = isCurrentUser
                    ? 'flex items-center justify-between bg-emerald-100 rounded-xl p-5 font-semibold text-xl transform transition-transform duration-200 hover:scale-105'
                    : 'flex items-center justify-between p-5 rounded-xl hover:bg-gray-50 transition-colors duration-200 text-xl';
                const rankClass = isCurrentUser ? 'font-extrabold text-emerald-700 text-3xl' : 'font-bold text-gray-600 text-2xl';
                const nameClass = 'text-gray-900';
                const xpClass = isCurrentUser ? 'font-extrabold text-emerald-700 text-2xl' : 'font-semibold text-gray-600 text-xl';
                const listItemHtml = `
                    <li class="${itemClass}">
                        <div class="flex items-center space-x-5">
                            <span class="${rankClass}">#${index + 1}</span>
                            <span class="${nameClass}">${user.name}</span>
                        </div>
                        <span class="${xpClass}">${user.xp} XP</span>
                    </li>
                `;
                leaderboardList.insertAdjacentHTML('beforeend', listItemHtml);
            });
        }
        function renderStudentBadges(badges) {
            const badgesGrid = document.getElementById('student-badges-grid');
            badgesGrid.innerHTML = '';
            const lang = localStorage.getItem('userLanguage') || 'en';
            const t = translations[lang] || translations['en'];
            badges.forEach(badge => {
                const opacity = badge.earned ? 'opacity-100' : 'opacity-40';
                const ringColor = badge.earned ? `ring-4 ring-${badge.color}-300 group-hover:ring-${badge.color}-500` : 'ring-4 ring-gray-300';
                const bgColor = badge.earned ? `bg-${badge.color}-100` : 'bg-gray-200';
                const textColor = badge.earned ? `text-${badge.color}-600` : 'text-gray-500';
                const icon = badge.earned ? badge.icon : 'fas fa-lock';
                const nameKey = badge.id;
                const name = t[`badge_${nameKey}`] || t[`badge_locked`];
                const badgeHtml = `
                    <div class="flex flex-col items-center transform transition-transform duration-200 hover:scale-110 group ${opacity}">
                        <div class="w-24 h-24 rounded-full ${bgColor} flex items-center justify-center ${textColor} text-5xl ${ringColor} transition-all duration-200 shadow-lg">
                            <i class="${icon}"></i>
                        </div>
                        <span class="mt-4 text-lg text-center font-semibold text-gray-700">${name}</span>
                    </div>
                `;
                badgesGrid.insertAdjacentHTML('beforeend', badgeHtml);
            });
        }
        function renderStudentModules(modules) {
            const moduleList = document.getElementById('student-module-progress-list');
            moduleList.innerHTML = '';
            const lang = localStorage.getItem('userLanguage') || 'en';
            const t = translations[lang] || translations['en'];
            modules.forEach(module => {
                const moduleHtml = `
                    <div id="module-${module.color}">
                        <div class="flex justify-between items-center mb-3">
                            <span class="font-bold text-2xl text-gray-900">${t[`${module.id}_quest_title`]}</span>
                            <span class="text-lg text-gray-600">${module.progress}%</span>
                        </div>
                        <div class="progress-bar mb-4">
                            <div class="progress-fill bg-gradient-to-r from-${module.color}-500 to-${module.color}-500" style="width: ${module.progress}%;"></div>
                        </div>
                        <button class="read-aloud-btn bg-${module.color}-100 text-${module.color}-600 text-lg px-5 py-2 rounded-full font-semibold hover:bg-${module.color}-200 transition-colors duration-200" data-text="${t[`${module.id}_quest_desc`]}">
                            <span>${t.read_aloud_button}</span>
                        </button>
                    </div>
                `;
                moduleList.insertAdjacentHTML('beforeend', moduleHtml);
            });
        }
       
        function checkLevelUp() {
            while (studentData.xp >= studentData.nextLevelXp) {
                studentData.level++;
                studentData.xp -= studentData.nextLevelXp;
                studentData.nextLevelXp = studentData.level * 100 + 500;
                showMessage(`Level Up! You are now Level ${studentData.level}!`, 'success');
            }
        }
       
        // --- API & Firestore Functions for Student Dashboard ---
        async function updateStudentLeaderboardData(user) {
            if (!db || !userId) {
                console.log('Skipping leaderboard update: Not on Gemini platform.');
                return;
            }
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', userId);
            try {
                await setDoc(docRef, { name: user.name, xp: user.xp, lastUpdated: new Date() }, { merge: true });
            } catch (error) {
                console.error('Error updating leaderboard:', error);
            }
        }
        async function fetchInitialStudentData() {
            if (!db || !userId) {
                console.log('Skipping initial student data fetch: Not on Gemini platform.');
                return;
            }
            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'dashboardData', 'profile');
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    studentData = { ...studentData, ...docSnap.data() };
                } else {
                    await setDoc(docRef, studentData);
                }
            } catch (error) {
                console.error('Error fetching/setting user data:', error);
            }
        }
        async function saveStudentData() {
            if (!db || !userId) {
                console.log('Skipping student data save: Not on Gemini platform.');
                return;
            }
            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'dashboardData', 'profile');
            try {
                await setDoc(docRef, studentData, { merge: true });
            } catch (error) {
                console.error('Error saving user data:', error);
            }
        }
        async function generateNewQuest() {
            const generateBtn = document.getElementById('student-generate-quest-btn');
            const generateLoading = document.getElementById('student-generate-loading');
            const now = new Date();
            const today = now.toISOString().slice(0, 10);
            const lang = localStorage.getItem('userLanguage') || 'en';
            const t = translations[lang] || translations['en'];

            if (studentData.lastQuestGenerated === today) {
                showMessage(t.quest_already_generated, 'error');
                return;
            }
            generateBtn.disabled = true;
            generateLoading.classList.remove('hidden');
            showMessage(t.loading_quests);
            try {
                if (!isGeminiPlatform) {
                    // Mocking for local development
                    const mockQuest = { id: 'water_conservation', xp: 90 };
                    studentData.quests = [mockQuest];
                    studentData.lastQuestGenerated = today;
                    await saveStudentData();
                    renderStudentQuests(studentData.quests);
                    showMessage(t.quest_generated_success, 'success');
                    console.log('Mock quest generated for local development.');
                    return;
                }

                const prompt = "Generate a new daily learning quest for a user on a gamified learning platform. The user is in a village in India. The quest should be related to practical, real-world skills like agriculture, water conservation, local history, or traditional crafts. The quest should have a 'title' (max 6 words), a 'description' (max 15 words), and a numerical 'xp' reward between 50 and 100. Provide the response as a single JSON object with the keys 'title', 'description', and 'xp'.";
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "title": { "type": "STRING" },
                                "description": { "type": "STRING" },
                                "xp": { "type": "NUMBER" }
                            }
                        }
                    }
                };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                const result = await response.json();
                const content = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!content) {
                   throw new Error('No content returned from API');
                }
                const newQuest = JSON.parse(content);
                studentData.quests = [{ id: newQuest.title.toLowerCase().replace(/ /g, '_'), xp: newQuest.xp }];
                studentData.lastQuestGenerated = today;
                await saveStudentData();
                renderStudentQuests(studentData.quests);
                showMessage(t.quest_generated_success, 'success');
            } catch (error) {
                console.error('Error generating quest:', error);
                showMessage('Failed to generate quest. Please try again.', 'error');
            } finally {
                generateBtn.disabled = false;
                generateLoading.classList.add('hidden');
            }
        }

        async function explainQuestConcept(description) {
            const lang = localStorage.getItem('userLanguage') || 'en';
            const t = translations[lang] || translations['en'];
            showMessage(t.loading_explanation);
            try {
                if (!isGeminiPlatform) {
                    // Mocking for local development
                    showMessage("This is a mock explanation for local development.", 'success');
                    console.log(`Mock explanation for: "${description}"`);
                    return;
                }
                const prompt = `Explain the following concept in simple, easy-to-understand terms suitable for a student in a rural Indian village. Keep the explanation concise, no more than 3-4 sentences: ${description}`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    model: "gemini-2.5-flash-preview-05-20"
                };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                const result = await response.json();
                const explanation = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (explanation) {
                    showMessage(explanation, 'success');
                } else {
                    throw new Error('No explanation returned from API');
                }
            } catch (error) {
                console.error('Error explaining concept:', error);
                showMessage('Failed to explain concept. Please try again.', 'error');
            }
        }

        async function readAloud(text) {
            const lang = localStorage.getItem('userLanguage') || 'en';
            const t = translations[lang] || translations['en'];
            showMessage(t.loading_audio);
            try {
                if (!isGeminiPlatform) {
                    // Mocking for local development
                    showMessage("This is a mock read aloud for local development.", 'success');
                    console.log(`Mock read aloud for: "${text}"`);
                    return;
                }
                const voiceName = ttsVoiceMap[lang] || 'Kore';
                const payload = {
                    contents: [{ parts: [{ text: text }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: voiceName } } },
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`TTS API call failed with status: ${response.status}`);
                }
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;
                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRate[1], 10) : 16000;
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();
                    showMessage('Playing audio...', 'success');
                } else {
                    throw new Error('Invalid audio data or mime type received.');
                }
            } catch (error) {
                console.error('Error reading aloud:', error);
                showMessage('Failed to read aloud. Please try again.', 'error');
            }
        }

        async function generateClassReport() {
            const lang = localStorage.getItem('userLanguage') || 'en';
            const t = translations[lang] || translations['en'];
            showMessage(t.loading_report);
           
            if (!isGeminiPlatform) {
                document.getElementById('teacher-report-text').textContent = "This is a mock report generated for local development. The class is doing great, with top performers setting a good example. Let's focus on improving 'Local History' with more interactive lessons.";
                showMessage('Mock report generated successfully!', 'success');
                console.log('Mock report generated for local development.');
                return;
            }

            const prompt = `Based on the following student data, generate a concise, encouraging, and actionable class report for the teacher. Highlight the overall class performance, mention top-performing students, and identify a general area for improvement. The data is as follows: ${JSON.stringify(students)}.`;
           
            try {
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    model: "gemini-2.5-flash-preview-05-20"
                };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                const result = await response.json();
                const reportText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (reportText) {
                    document.getElementById('teacher-report-text').textContent = reportText;
                    showMessage('Report generated successfully!', 'success');
                } else {
                    throw new Error('No report text returned from API');
                }
            } catch (error) {
                console.error('Error generating report:', error);
                showMessage('Failed to generate report. Please try again.', 'error');
            }
        }

        // --- UI Rendering Functions for Teacher Dashboard ---
        function renderTeacherStudentProgress() {
            const list = document.getElementById('teacher-student-progress-list');
            const summary = document.getElementById('teacher-progress-summary');
            const viewType = document.getElementById('teacher-progress-view').value;

            if (viewType === 'class-summary') {
                list.classList.add('hidden');
                summary.classList.remove('hidden');
                if (students.length > 0) {
                    const totalXP = students.reduce((sum, s) => sum + s.xp, 0);
                    const totalLevel = students.reduce((sum, s) => sum + s.level, 0);
                    document.getElementById('teacher-avg-xp').textContent = (totalXP / students.length).toFixed(0);
                    document.getElementById('teacher-avg-level').textContent = (totalLevel / students.length).toFixed(1);
                    document.getElementById('teacher-total-students').textContent = students.length;
                } else {
                    document.getElementById('teacher-avg-xp').textContent = '0';
                    document.getElementById('teacher-avg-level').textContent = '0';
                    document.getElementById('teacher-total-students').textContent = '0';
                }
            } else { // 'all-students'
                summary.classList.add('hidden');
                list.classList.remove('hidden');
                list.innerHTML = '';
                students.sort((a, b) => b.progress - a.progress);
                students.forEach(student => {
                    const progressColor = student.progress >= 100 ? 'bg-green-500' : (student.progress > 0 ? 'bg-yellow-400' : 'bg-red-500');
                    const progressHtml = `<div class="progress-bar"><div class="progress-fill ${progressColor}" style="width: ${student.progress}%;"></div></div>`;
                    const studentHtml = `
                        <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-xl">
                            <div class="w-12 h-12 rounded-full bg-indigo-200 flex items-center justify-center font-bold text-indigo-700">
                                ${student.name.charAt(0).toUpperCase()}
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-bold">${student.name}</h3>
                                <p class="text-sm text-gray-500">Level: ${student.level}</p>
                            </div>
                            <div class="flex-1">
                                ${progressHtml}
                                <p class="text-sm text-right mt-1 font-semibold">${student.progress}%</p>
                            </div>
                        </div>
                    `;
                    list.insertAdjacentHTML('beforeend', studentHtml);
                });
            }
        }
        function renderTeacherLeaderboard() {
            const list = document.getElementById('teacher-leaderboard-list');
            list.innerHTML = '';
            const sortedStudents = [...students].sort((a, b) => b.xp - a.xp).slice(0, 5);
            sortedStudents.forEach((student, index) => {
                const rank = index + 1;
                const itemHtml = `
                    <li class="flex items-center justify-between p-4 rounded-xl bg-yellow-50 hover:bg-yellow-100 transition-colors">
                        <div class="flex items-center space-x-4">
                            <span class="text-xl font-bold text-yellow-600">#${rank}</span>
                            <span class="text-lg font-semibold">${student.name}</span>
                        </div>
                        <span class="text-lg font-bold text-gray-700">${student.xp} XP</span>
                    </li>
                `;
                list.insertAdjacentHTML('beforeend', itemHtml);
            });
        }
        function renderTeacherRewardBadges() {
            const grid = document.getElementById('teacher-badge-grid');
            grid.innerHTML = '';
            teacherBadges.forEach(badge => {
                const badgeHtml = `
                    <div class="flex flex-col items-center cursor-pointer p-2 rounded-xl hover:bg-white transition-colors" data-badge-id="${badge.id}">
                        <i class="${badge.icon} ${badge.color} badge-icon"></i>
                        <span class="text-xs font-semibold mt-1 text-center">${badge.name}</span>
                    </div>
                `;
                grid.insertAdjacentHTML('beforeend', badgeHtml);
            });
        }
        function renderTeacherStudentSelector() {
            const selector = document.getElementById('teacher-reward-student-selector');
            const lang = localStorage.getItem('userLanguage') || 'en';
            const t = translations[lang] || translations['en'];
            selector.innerHTML = `<option value="" disabled selected>${t.select_student_placeholder}</option>`;
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = student.name;
                selector.appendChild(option);
            });
        }
        function addNotification(messageKey, context = {}) {
            const list = document.getElementById('teacher-notification-list');
            const lang = localStorage.getItem('userLanguage') || 'en';
            const t = translations[lang] || translations['en'];
            let message = t[messageKey] || messageKey;
           
            // Replace placeholders like {name} or {badge}
            Object.keys(context).forEach(key => {
                message = message.replace(`{${key}}`, context[key]);
            });

            const notificationHtml = `<div class="p-4 bg-gray-100 rounded-xl font-medium">${message}</div>`;
            list.insertAdjacentHTML('afterbegin', notificationHtml);
        }

        // --- Core Application Logic ---
        function setRole(role) {
            currentRole = role;
            localStorage.setItem('userRole', role);

            // Hide all modals and dashboards first
            document.getElementById('role-selection-modal').classList.add('hidden');
            document.getElementById('student-dashboard').classList.add('hidden');
            document.getElementById('teacher-dashboard').classList.add('hidden');
            document.getElementById('parent-dashboard').classList.add('hidden');
            document.getElementById('math-game-modal').classList.add('hidden');
            document.getElementById('math-game-modal').classList.remove('flex');
            document.getElementById('puzzle-mania-modal').classList.add('hidden');
            document.getElementById('puzzle-mania-modal').classList.remove('flex');
            document.body.classList.remove('parent-dashboard-bg'); // Remove parent bg class

            // Show role switch button
            document.getElementById('role-switch-btn').classList.remove('hidden');
           
            if (role === 'student') {
                document.getElementById('student-dashboard').classList.remove('hidden');
                initStudentDashboard();
            } else if (role === 'teacher') {
                document.getElementById('teacher-dashboard').classList.remove('hidden');
                initTeacherDashboard();
            } else if (role === 'parent') {
                document.getElementById('parent-dashboard').classList.remove('hidden');
                initParentDashboard();
            }
        }
        function toggleRole() {
            if (currentRole === 'student') {
                setRole('teacher');
            } else if (currentRole === 'teacher') {
                setRole('parent');
            } else {
                setRole('student');
            }
        }
       
        async function createMockStudents() {
            const mockStudents = [
                { name: 'Ravi', level: 5, xp: 1200, progress: 85, badges: ['helping-hand'], id: 'ravi-1' },
                { name: 'Priya', level: 4, xp: 950, progress: 95, badges: ['star-performer'], id: 'priya-2' },
                { name: 'Amit', level: 3, xp: 750, progress: 60, badges: [], id: 'amit-3' },
                { name: 'Meena', level: 6, xp: 1500, progress: 100, badges: ['star-performer', 'problem-solver'], id: 'meena-4' },
                { name: 'Suresh', level: 2, xp: 400, progress: 30, badges: [], id: 'suresh-5' },
            ];
            if (!isGeminiPlatform) {
                students = mockStudents;
                console.log("Using mock student data for local development.");
                return;
            }
            const studentCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'students');
            const snapshot = await getDocs(studentCollectionRef);
            if (snapshot.empty) {
                console.log("No student data found, creating mock data.");
                for (const student of mockStudents) {
                    await setDoc(doc(studentCollectionRef, student.id), student);
                }
            }
        }
       
        async function initStudentDashboard() {
            await fetchInitialStudentData();
            updateStudentUI(); // This will handle all translations and rendering for the student dashboard
            if (!isGeminiPlatform) {
                renderStudentLeaderboard(defaultLeaderboard);
                return;
            }
            const publicLeaderboardRef = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
            onSnapshot(publicLeaderboardRef, (snapshot) => {
                const leaderboardData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderStudentLeaderboard(leaderboardData);
            }, (error) => {
                console.error('Error listening to leaderboard:', error);
                renderStudentLeaderboard(defaultLeaderboard);
            });
        }
       
        async function initTeacherDashboard() {
            const lang = localStorage.getItem('userLanguage') || 'en';
            translateTeacherDashboard(lang); // Translate static elements first
            renderTeacherRewardBadges();
            await createMockStudents();
            document.getElementById('teacher-notification-list').innerHTML = '';
            addNotification('notification1');
            addNotification('notification2');
            addNotification('notification3');
           
            if (!isGeminiPlatform) {
                renderTeacherStudentProgress();
                renderTeacherLeaderboard();
                renderTeacherStudentSelector();
                return;
            }

            const studentCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'students');
            onSnapshot(studentCollectionRef, (snapshot) => {
                students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTeacherStudentProgress();
                renderTeacherLeaderboard();
                renderTeacherStudentSelector();
            }, (error) => {
                console.error("Error listening to student data: ", error);
                showMessage("Failed to get real-time student data.", "error");
            });
        }

        async function initParentDashboard() {
            const lang = localStorage.getItem('userLanguage') || 'en';
            translateParentDashboard(lang); // Translate static elements
            setParentDashboardAppearance();
        }

        function setParentDashboardAppearance() {
            const body = document.body;
            const greetingMessage = document.getElementById('greeting-message');
            const currentHour = new Date().getHours();
            const lang = localStorage.getItem('userLanguage') || 'en';
            const t = translations[lang] || translations['en'];

            // Set background class
            body.classList.add('parent-dashboard-bg');

            // Set greeting based on time of day
            if (currentHour >= 5 && currentHour < 12) {
                greetingMessage.textContent = t.parent_greeting_morning;
            } else if (currentHour >= 12 && currentHour < 17) {
                greetingMessage.textContent = t.parent_greeting_afternoon;
            } else if (currentHour >= 17 && currentHour < 20) {
                greetingMessage.textContent = t.parent_greeting_evening;
            } else {
                greetingMessage.textContent = t.parent_greeting_night;
            }
        }
       
        async function initializeAppAndAuth() {
            try {
                populateLanguageSelectors();
               
                if (!isGeminiPlatform) {
                    console.warn("Not on Gemini platform. Using mock Firebase config.");
                    document.getElementById('login-modal').classList.remove('hidden');
                    return;
                }
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('login-modal').classList.add('hidden');
                       
                        const savedLang = localStorage.getItem('userLanguage') || 'en';
                        translateAllPages(savedLang);

                        if (currentRole) {
                            setRole(currentRole);
                        } else {
                            document.getElementById('role-selection-modal').classList.remove('hidden');
                        }

                    } else {
                        document.getElementById('login-modal').classList.remove('hidden');
                    }
                });
            } catch (error) {
                console.error('Firebase initialization or authentication failed:', error);
                showMessage('Failed to connect to the database. Check console for details.', 'error');
            }
        }

        async function handleLogin() {
            const phoneNumber = document.getElementById('phone-number').value;
            if (phoneNumber) {
                showMessage("A mock OTP has been sent. Please enter '123456'", 'success');
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('otp-section').classList.remove('hidden');
            } else {
                showMessage("Please enter a valid phone number.", 'error');
            }
        }

        async function handleOtpVerification() {
            const otpInput = document.getElementById('otp-input').value;
            if (otpInput === '123456') {
                let user;
                if (isGeminiPlatform) {
                    user = await signInWithCustomToken(auth, authToken);
                } else {
                    try {
                        user = await signInAnonymously(auth);
                        userId = user.user.uid;
                    } catch(e) {
                         console.log("Mock sign in for local dev");
                         userId = "mock-user-id";
                    }
                }
                showMessage("Login successful!", 'success');
                document.getElementById('login-modal').classList.add('hidden');

                const savedLang = localStorage.getItem('userLanguage') || 'en';
                translateAllPages(savedLang);
                if(currentRole) {
                    setRole(currentRole);
                } else {
                    document.getElementById('role-selection-modal').classList.remove('hidden');
                }
            } else {
                showMessage("Invalid OTP. Please try again.", 'error');
            }
        }

        function handleVoiceInput() {
            const voiceInput = document.getElementById('voice-input').value;
            if (voiceInput) {
                showMessage(`You said: "${voiceInput}"`, 'success');
            } else {
                showMessage("Please speak or type something first.", 'error');
            }
        }

        function populateLanguageSelectors() {
            const selectors = document.querySelectorAll('#language-selector, #teacher-language-selector, #parent-language-selector');
            const savedLang = localStorage.getItem('userLanguage') || 'en';
            selectors.forEach(selector => {
                if (!selector) return;
                selector.innerHTML = '';
                for (const code in languages) {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = languages[code];
                    selector.appendChild(option);
                }
                selector.value = savedLang;
            });
        }

        // Helper to safely set text content
        const safeSetText = (id, text) => {
            const element = document.getElementById(id);
            if (element) element.textContent = text;
        };
        const safeSetTextByQuery = (query, text) => {
            const element = document.querySelector(query);
            if (element) element.textContent = text;
        };
        const safeSetAllByQuery = (query, text) => {
            document.querySelectorAll(query).forEach(el => {
                if (el) el.textContent = text;
            });
        };
       
        function translateStudentDashboard(lang) {
            const t = translations[lang] || translations['en'];
            safeSetText('student-welcome-message', t.welcome_message);
            safeSetText('student-learning-message', t.learning_message);
            safeSetText('student-daily-quests-title', t.daily_quests_title);
            safeSetText('student-leaderboard-title', t.leaderboard_title);
            safeSetText('student-badges-title', t.badges_title);
            safeSetText('student-progress-title', t.progress_title);
            safeSetText('student-generate-quest-btn-text', t.generate_quest_button);
            safeSetText('student-voice-label', t.voice_question_label);
        }

        function translateTeacherDashboard(lang) {
            const t = translations[lang] || translations['en'];
            safeSetText('teacher-dashboard-title', t.teacher_dashboard_title);
            safeSetText('teacher-student-progress-title', t.student_progress_title);
            safeSetText('teacher-view-label', t.view_label);
            safeSetText('teacher-view-option-summary', t.view_option_summary);
            safeSetText('teacher-view-option-all', t.view_option_all);
            safeSetText('teacher-generate-report-btn-text', t.generate_report_button);
            safeSetText('teacher-summary-title', t.summary_title);
            safeSetText('teacher-summary-avg-xp-label', t.summary_avg_xp);
            safeSetText('teacher-summary-avg-level-label', t.summary_avg_level);
            safeSetText('teacher-summary-total-students-label', t.summary_total_students);
            safeSetText('teacher-leaderboard-title', t.class_leaderboard_title);
            safeSetText('teacher-reward-title', t.reward_title);
            safeSetText('teacher-award-badge-btn', t.award_badge_button);
            safeSetText('teacher-assignment-title-main', t.assignment_title);
            safeSetText('teacher-assignment-module-label', t.module_title_label);
            safeSetText('teacher-assignment-desc-label', t.description_label);
            safeSetText('teacher-assignment-assign-label', t.assign_to_label);
            safeSetText('teacher-assign-all', t.assign_all);
            safeSetText('teacher-assign-gA', t.assign_group_a);
            safeSetText('teacher-assign-gB', t.assign_group_b);
            safeSetText('teacher-create-assignment-btn', t.create_assignment_button);
            safeSetText('teacher-notifications-title', t.notifications_title);
        }

        function translateParentDashboard(lang) {
            const t = translations[lang] || translations['en'];
            safeSetText('greeting-message', t.parent_welcome);
            safeSetText('parent-child-dashboard-label', t.child_dashboard_label);
            safeSetText('parent-overall-progress-title', t.overall_progress_title);
            safeSetText('parent-learning-level-label', t.learning_level_label);
            safeSetText('parent-points-earned-label', t.points_earned_label);
            safeSetText('parent-badges-collected-label', t.badges_collected_label);
            safeSetText('parent-subject-progress-title', t.subject_progress_title);
            safeSetAllByQuery('.parent-lessons-label', t.lessons_label);
            safeSetText('parent-subject-math', t.subject_math);
            safeSetText('parent-subject-science', t.subject_science);
            safeSetText('parent-subject-english', t.subject_english);
            safeSetText('parent-homework-title', t.homework_title);
            safeSetAllByQuery('.parent-due-label', t.due_label);
            safeSetTextByQuery('.parent-due-date1', t.due_yesterday);
            safeSetTextByQuery('.parent-due-date2', t.due_tomorrow);
            safeSetTextByQuery('.parent-due-date3', t.due_2_days_ago);
            safeSetTextByQuery('.parent-status-submitted', t.status_submitted);
            safeSetTextByQuery('.parent-status-pending', t.status_pending);
            safeSetTextByQuery('.parent-status-overdue', t.status_overdue);
            safeSetText('parent-homework1-title', t.homework1_title);
            safeSetText('parent-homework2-title', t.homework2_title);
            safeSetText('parent-homework3-title', t.homework3_title);
            safeSetText('parent-attendance-title', t.attendance_title);
            safeSetText('parent-attendance-month-label', t.present_month_label);
            safeSetText('parent-attendance-week-label', t.this_week_label);
            safeSetTextByQuery('.parent-day-mon', t.day_mon);
            safeSetTextByQuery('.parent-day-tue', t.day_tue);
            safeSetTextByQuery('.parent-day-wed', t.day_wed);
            safeSetTextByQuery('.parent-day-thu', t.day_thu);
            safeSetTextByQuery('.parent-day-fri', t.day_fri);
            safeSetText('parent-footer-text', t.footer_text);
        }

        function updateStudentUI() {
            const lang = localStorage.getItem('userLanguage') || 'en';
            translateStudentDashboard(lang); // Translate static elements
            const t = translations[lang] || translations['en'];
            document.getElementById('student-user-avatar').textContent = studentData.name.charAt(0).toUpperCase();
            document.getElementById('student-level-text').textContent = `${t.level_text} ${studentData.level}`;
            document.getElementById('student-xp-text').textContent = `${studentData.xp} / ${studentData.nextLevelXp} XP`;
            const progressPercentage = (studentData.xp / studentData.nextLevelXp) * 100;
            document.getElementById('student-xp-progress-fill').style.width = `${Math.min(progressPercentage, 100)}%`;

            // Dynamic elements are translated within their render functions
            renderStudentQuests(studentData.quests);
            renderStudentLeaderboard(defaultLeaderboard);
            renderStudentBadges(studentBadges);
            renderStudentModules(studentModules);
        }

        // CORRECTED: Central translation function
        function translateAllPages(lang) {
            localStorage.setItem('userLanguage', lang);
            populateLanguageSelectors();

            const t = translations[lang] || translations['en'];

            // Translate common elements that are always available
            safeSetText('login-modal-title', t.login_title);
            safeSetText('request-otp-btn', t.request_otp);
            safeSetText('verify-otp-btn', t.verify_otp);
            safeSetText('otp-info-text', t.otp_info);
            safeSetText('role-modal-title', t.role_modal_title);
            safeSetTextByQuery('.role-student-text', t.role_student);
            safeSetTextByQuery('.role-teacher-text', t.role_teacher);
            safeSetTextByQuery('.role-parent-text', t.role_parent);
            safeSetText('role-switch-btn', t.switch_role_button);

            // Re-initialize/re-render the currently active dashboard to apply language changes
            if (currentRole === 'student') {
                updateStudentUI();
            } else if (currentRole === 'teacher') {
                initTeacherDashboard();
            } else if (currentRole === 'parent') {
                initParentDashboard();
            }
        }
       
        // --- Added from second document ---
        let currentAudio = null;
        const textApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${""}`;
        const ttsApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${""}`;
        const imageApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${""}`;

        async function callGeminiText(prompt) {
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            try {
                const response = await fetch(textApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't generate a response. Please try again.";
            } catch (error) {
                console.error("Gemini API call failed:", error);
                return "There was an error connecting to the AI helper. Please check your connection and try again.";
            }
        }

        async function callGeminiTTS(textToSpeak) {
            const payload = {
                contents: [{ parts: [{ text: textToSpeak }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } }
                },
                model: "gemini-2.5-flash-preview-tts"
            };
            try {
                const response = await fetch(ttsApiUrl, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`TTS API Error: ${response.statusText}`);
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                    const pcmData = base64ToArrayBuffer(audioData);
                    const wavBlob = pcmToWav(pcmData, sampleRate);
                    return URL.createObjectURL(wavBlob);
                }
                return null;
            } catch (error) {
                console.error("Gemini TTS call failed:", error);
                showMessage("Audio Error", "Could not generate the audio for this text.");
                return null;
            }
        }

        async function callImagen(prompt) {
            const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } };
            try {
                const response = await fetch(imageApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`Imagen API Error: ${response.statusText}`);
                const result = await response.json();
                return result.predictions?.[0]?.bytesBase64Encoded || null;
            } catch (error) {
                console.error("Imagen API call failed:", error);
                showMessage("Image Error", "Sorry, I couldn't create an image right now.");
                return null;
            }
        }

        // --- Event Handlers ---
        window.onload = initializeAppAndAuth;
        document.getElementById('student-role-btn').addEventListener('click', () => setRole('student'));
        document.getElementById('teacher-role-btn').addEventListener('click', () => setRole('teacher'));
        document.getElementById('parent-role-btn').addEventListener('click', () => setRole('parent'));
        document.getElementById('role-switch-btn').addEventListener('click', toggleRole);
        document.getElementById('language-selector').addEventListener('change', (e) => translateAllPages(e.target.value));
        document.getElementById('teacher-language-selector').addEventListener('change', (e) => translateAllPages(e.target.value));
        document.getElementById('parent-language-selector').addEventListener('change', (e) => translateAllPages(e.target.value));

        document.getElementById('student-generate-quest-btn').addEventListener('click', generateNewQuest);
        document.getElementById('student-quest-list').addEventListener('click', async (event) => {
            const btn = event.target.closest('.student-start-quest-btn');
            if (btn) {
                const xpReward = parseInt(btn.dataset.xp, 10);
                studentData.xp += xpReward;
                checkLevelUp();
                studentData.quests = [];
                await saveStudentData();
                await updateStudentLeaderboardData(studentData);
                updateStudentUI();
                const lang = localStorage.getItem('userLanguage') || 'en';
                const message = (translations[lang] || translations['en'])['xp_gained'].replace('{xp}', xpReward);
                showMessage(message, 'success');
            }
            const explainBtn = event.target.closest('.explain-quest-btn');
            if(explainBtn) {
                const description = explainBtn.dataset.desc;
                explainQuestConcept(description);
            }
        });
        document.getElementById('student-module-progress-list').addEventListener('click', (event) => {
            const btn = event.target.closest('.read-aloud-btn');
            if (btn) {
                const textToRead = btn.dataset.text;
                readAloud(textToRead);
            }
        });

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            handleLogin();
        });
        document.getElementById('verify-otp-btn').addEventListener('click', handleOtpVerification);
        document.getElementById('mic-btn').addEventListener('click', handleVoiceInput);

       
        document.getElementById('teacher-progress-view').addEventListener('change', renderTeacherStudentProgress);
        document.getElementById('generate-report-btn').addEventListener('click', generateClassReport);
        document.getElementById('teacher-reward-student-selector').addEventListener('change', (e) => {
            const awardBtn = document.getElementById('teacher-award-badge-btn');
            awardBtn.disabled = !e.target.value;
        });
        let selectedBadgeId = null;
        document.getElementById('teacher-badge-grid').addEventListener('click', (e) => {
            const badgeElement = e.target.closest('div[data-badge-id]');
            if (badgeElement) {
                document.querySelectorAll('#teacher-badge-grid > div').forEach(el => el.classList.remove('bg-white', 'ring-2', 'ring-emerald-500'));
                badgeElement.classList.add('bg-white', 'ring-2', 'ring-emerald-500');
                selectedBadgeId = badgeElement.dataset.badgeId;
            }
        });
        document.getElementById('teacher-award-badge-btn').addEventListener('click', async () => {
            const studentId = document.getElementById('teacher-reward-student-selector').value;
            if (!studentId || !selectedBadgeId) {
                showMessage("Please select a student and a badge.", "error");
                return;
            }
            try {
                if (!isGeminiPlatform) {
                    console.log(`Mock: Awarded badge ${selectedBadgeId} to student ${studentId}`);
                    showMessage("Badge awarded successfully! (Mock)", "success");
                    addNotification(`Mock: Awarded badge to student ${studentId}.`);
                    return;
                }
                const studentDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'students', studentId);
                const student = students.find(s => s.id === studentId);
                if (student && student.badges && !student.badges.includes(selectedBadgeId)) {
                    const updatedBadges = [...student.badges, selectedBadgeId];
                    await setDoc(studentDocRef, { badges: updatedBadges }, { merge: true });
                    showMessage(`${student.name} was awarded the ${selectedBadgeId} badge!`);
                    addNotification(`New assignment "${title}" created for "${group}".`);
                } else {
                    showMessage("Student already has this badge or an error occurred.", "error");
                }
            } catch (error) {
                console.error("Error awarding badge: ", error);
                showMessage("Failed to award badge. Please try again.", "error");
            }
        });
        document.getElementById('teacher-assignment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('teacher-assignment-title-input').value;
            const desc = document.getElementById('teacher-assignment-desc').value;
            const group = document.getElementById('teacher-assignment-group').value;
            if (!title || !desc) {
                showMessage("Please fill out all assignment fields.", "error");
                return;
            }
            const newAssignment = { title, description: desc, assignedTo: group, createdAt: new Date() };
            try {
                if (!isGeminiPlatform) {
                    console.log("Mock: Created new assignment", newAssignment);
                    showMessage("Assignment created and assigned successfully! (Mock)", "success");
                    addNotification(`Mock: New assignment "${title}" created for "${group}".`);
                    document.getElementById('teacher-assignment-form').reset();
                    return;
                }
                const assignmentsCollectionRef = collection(db, 'artifacts', appId, 'private', 'data', 'assignments');
                await addDoc(assignmentsCollectionRef, newAssignment);
                showMessage("Assignment created and assigned successfully!");
                addNotification(`New assignment "${title}" created for "${group}".`);
                document.getElementById('teacher-assignment-form').reset();
            } catch (error) {
                console.error("Error creating assignment: ", error);
                showMessage("Failed to create assignment. Please try again.", "error");
            }
        });
       
        // --- Math Bullseye Game Integration ---
       
        // Game configuration
        const WIDTH = 900;
        const HEIGHT = 720;
        const FPS = 60;
        const TIME_LIMIT = 45; // seconds
        const LIVES_START = 3;
        const OPTION_RADIUS = 40;
        const TARGET_CENTER = { x: WIDTH / 2, y: HEIGHT / 2 + 30 };
        const RING_RADII = [170, 120, 80, 40];
       
        // Colors
        const RING_COLORS = ['#dc143c', '#ff8c00', '#ffd700', '#228b22'];
        const RING_BORDER = '#282828';
        const OPTION_FILL = '#2064c8';
        const OPTION_BORDER = '#f5c83c';
        const HOVER_BORDER = '#ffffff';
        const FEEDBACK_POS_COLOR = '#1ec878';
        const FEEDBACK_NEG_COLOR = '#dc3232';
       
        // Audio
        let audioContext = null;
        let clickOscillator, winOscillator;

        // Initialize canvas and context
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = WIDTH;
        canvas.height = HEIGHT;

        // Game state
        let game = {};
        let lastTime = 0;
        let running = false;
        let mousePos = { x: 0, y: 0 };
        let leaderboard = [];

        // Game UI elements
        const gameOverScreen = document.getElementById('game-over-screen');
        const finalScoreText = document.getElementById('final-score');
        const leaderboardList = document.getElementById('leaderboard-list');

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            // Simple audio synthesis to avoid external files
            clickOscillator = audioContext.createOscillator();
            clickOscillator.type = 'sine';
            clickOscillator.frequency.value = 250;
            clickOscillator.start();

            winOscillator = audioContext.createOscillator();
            winOscillator.type = 'sine';
            winOscillator.frequency.value = 520;
            winOscillator.start();
        }

        function playClickSound() {
            if (!audioContext) return;
            const gainNode = audioContext.createGain();
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1);
            clickOscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            setTimeout(() => {
                gainNode.disconnect();
                clickOscillator.disconnect();
                initAudio();
            }, 100);
        }

        function playWinSound() {
            if (!audioContext) return;
            const gainNode = audioContext.createGain();
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
            winOscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            setTimeout(() => {
                gainNode.disconnect();
                winOscillator.disconnect();
                initAudio();
            }, 500);
        }

        // Utility functions
        function saveScore(score) {
            try {
                let scores = JSON.parse(localStorage.getItem('mathBullseyeScores')) || [];
                scores.push(score);
                scores.sort((a, b) => b - a);
                localStorage.setItem('mathBullseyeScores', JSON.stringify(scores));
            } catch (e) {
                console.error("Could not save score to localStorage:", e);
            }
        }

        function loadTopScores(n = 5) {
            try {
                let scores = JSON.parse(localStorage.getItem('mathBullseyeScores')) || [];
                scores.sort((a, b) => b - a);
                leaderboard = scores.slice(0, n);
            } catch (e) {
                console.error("Could not load scores from localStorage:", e);
                leaderboard = [];
            }
        }

        function circlePointCollision(circle, point) {
            const dx = point.x - circle.x;
            const dy = point.y - circle.y;
            return Math.sqrt(dx * dx + dy * dy) < circle.radius;
        }

        // Game drawing
        function drawTarget() {
            ctx.clearRect(0, 0, WIDTH, HEIGHT);
            ctx.fillStyle = '#121212';
            ctx.fillRect(0, 0, WIDTH, HEIGHT);
           
            const { x, y } = TARGET_CENTER;
            RING_RADII.forEach((r, i) => {
                ctx.beginPath();
                ctx.arc(x, y, r, 0, 2 * Math.PI);
                ctx.fillStyle = RING_COLORS[i];
                ctx.fill();
                ctx.strokeStyle = RING_BORDER;
                ctx.lineWidth = 4;
                ctx.stroke();
                ctx.closePath();
            });
        }

        function generateQuestion() {
            const a = Math.floor(Math.random() * 12) + 1;
            const b = Math.floor(Math.random() * 12) + 1;
            const ops = ['+', '-', '*'];
            const op = ops[Math.floor(Math.random() * ops.length)];
            let ans;

            if (op === '+') ans = a + b;
            else if (op === '-') ans = a - b;
            else ans = a * b;

            const qText = `${a} ${op} ${b} = ?`;
            const opts = [ans];
           
            while (opts.length < 3) {
                const delta = Math.floor(Math.random() * 6) + 1;
                const sign = Math.random() < 0.5 ? 1 : -1;
                const candidate = ans + sign * delta;
                if (!opts.includes(candidate) && candidate > -100 && candidate < 100) {
                    opts.push(candidate);
                }
            }
            opts.sort(() => Math.random() - 0.5);

            const chosenRadii = [RING_RADII[0], RING_RADII[1], RING_RADII[2]];
            const baseAngle = Math.random() * 2 * Math.PI;
            const positions = [];
            for (let i = 0; i < chosenRadii.length; i++) {
                const angle = baseAngle + i * (2 * Math.PI / 3);
                const r = chosenRadii[i] + 40; // Position options outside the bullseye
                const x = TARGET_CENTER.x + r * Math.cos(angle);
                const y = TARGET_CENTER.y + r * Math.sin(angle);
                positions.push({ x: x, y: y });
            }
           
            return {
                qText,
                answer: ans,
                options: opts.map((value, i) => ({
                    value,
                    pos: positions[i],
                    radius: OPTION_RADIUS,
                    isHover: false,
                    flashTimer: 0,
                    flashColor: null
                }))
            };
        }

        function drawOptions() {
            game.options.forEach(option => {
                ctx.beginPath();
                ctx.arc(option.pos.x, option.pos.y, option.radius, 0, 2 * Math.PI);
                ctx.fillStyle = OPTION_FILL;
                ctx.fill();
                ctx.strokeStyle = option.isHover ? HOVER_BORDER : OPTION_BORDER;
                ctx.lineWidth = option.isHover ? 6 : 4;
                if (option.flashTimer > 0) {
                    ctx.strokeStyle = option.flashColor;
                    ctx.lineWidth = 6;
                }
                ctx.stroke();
                ctx.closePath();

                ctx.font = '700 44px Inter, sans-serif';
                ctx.fillStyle = 'white';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(option.value, option.pos.x, option.pos.y);
            });
        }

        function drawUI() {
            // Question
            ctx.font = '700 44px Inter, sans-serif';
            ctx.fillStyle = 'white';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            ctx.fillText(game.question.qText, WIDTH / 2, 30);

            // Status
            ctx.font = '700 26px Inter, sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(`Score: ${game.score}`, 20, 18);
            ctx.fillText(`Lives: ${game.lives}`, 20, 48);

            // Timer
            const elapsed = (Date.now() - game.startTime) / 1000;
            const timeLeft = Math.max(0, TIME_LIMIT - elapsed);
            ctx.textAlign = 'right';
            ctx.fillText(`Time: ${Math.round(timeLeft)}s`, WIDTH - 20, 18);

            const barW = WIDTH - 240;
            const barH = 16;
            const barX = 120;
            const barY = 100;
            ctx.fillStyle = '#f0f0f0';
            ctx.beginPath();
            ctx.roundRect(barX, barY, barW, barH, 8);
            ctx.fill();
            ctx.fillStyle = '#3cb371';
            ctx.beginPath();
            ctx.roundRect(barX, barY, barW * (timeLeft / TIME_LIMIT), barH, 8);
            ctx.fill();
            ctx.strokeStyle = '#505050';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.roundRect(barX, barY, barW, barH, 8);
            ctx.stroke();
           
            return timeLeft;
        }

        function drawFeedback() {
            if (game.feedbackTimer > 0) {
                const scale = 1.0 + 0.6 * (game.feedbackTimer / 0.9);
                const fontSize = 36 * scale;
                ctx.font = `700 ${fontSize}px Inter, sans-serif`;
                ctx.fillStyle = game.feedbackColor;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
               
                // Draw shadow
                ctx.globalAlpha = 0.5;
                ctx.fillStyle = 'black';
                ctx.fillText(game.feedbackText, WIDTH / 2 + 3, 160 + 3);
               
                // Draw text
                ctx.globalAlpha = 1.0;
                ctx.fillStyle = game.feedbackColor;
                ctx.fillText(game.feedbackText, WIDTH / 2, 160);
            }
        }
       
        function showGameOverScreen() {
            loadTopScores();
           
            finalScoreText.textContent = `Your Score: ${game.score}`;
           
            leaderboardList.innerHTML = '';
            leaderboard.forEach((score, index) => {
                const li = document.createElement('li');
                li.textContent = `${index + 1}. ${score}`;
                li.classList.add('flex', 'justify-between');
                if (index < 3) {
                    li.classList.add('top-3');
                    if (index === 0) li.style.color = '#ffc400';
                    if (index === 1) li.style.color = '#c0c0c0';
                    if (index === 2) li.style.color = '#cd7f32';
                }
                leaderboardList.appendChild(li);
            });

            gameOverScreen.style.display = 'flex';
        }

        function hideGameOverScreen() {
            gameOverScreen.style.display = 'none';
        }

        // Main game loop
        function gameLoop(timestamp) {
            if (!running) return;

            const dt = (timestamp - lastTime) / 1000;
            lastTime = timestamp;

            if (game.state === 'playing') {
                drawTarget();
                drawOptions();
                drawUI();
                drawFeedback();

                // Update timers
                game.options.forEach(option => {
                    if (option.flashTimer > 0) {
                        option.flashTimer = Math.max(0, option.flashTimer - dt);
                    }
                });
               
                if (game.feedbackTimer > 0) {
                    game.feedbackTimer = Math.max(0, game.feedbackTimer - dt);
                }

                if (game.pendingNext) {
                    game.pendingTimer = Math.max(0, game.pendingTimer - dt);
                    if (game.pendingTimer <= 0) {
                        const timeLeft = TIME_LIMIT - (Date.now() - game.startTime) / 1000;
                        if (game.lives <= 0 || timeLeft <= 0) {
                            game.state = 'game_over';
                            saveScore(game.score);
                            showGameOverScreen();
                        } else {
                            resetQuestion();
                        }
                        game.pendingNext = false;
                    }
                }
            }
           
            requestAnimationFrame(gameLoop);
        }

        function resetQuestion() {
            const { qText, answer, options } = generateQuestion();
            game.question = { qText, answer };
            game.options = options;
            game.feedbackText = '';
            game.feedbackTimer = 0;
            game.pendingNext = false;
            game.pendingTimer = 0; // Reset this too
        }

        function resetGame() {
            game = {
                score: 0,
                lives: LIVES_START,
                startTime: Date.now(),
                state: 'playing',
                feedbackText: '',
                feedbackTimer: 0,
                feedbackColor: null,
                pendingNext: false,
                pendingTimer: 0
            };
            resetQuestion();
            hideGameOverScreen();
            running = true;
        }

        // Event listeners for game start and quit
        document.getElementById('math-bullseye-card').addEventListener('click', () => {
            document.getElementById('student-dashboard').classList.add('hidden');
            document.getElementById('math-game-modal').classList.remove('hidden');
            document.getElementById('math-game-modal').classList.add('flex');
            initAudio();
            resetGame();
            requestAnimationFrame(gameLoop);
        });

        document.getElementById('play-again-btn').addEventListener('click', () => {
            resetGame();
        });

        document.getElementById('quit-btn').addEventListener('click', () => {
            running = false;
            document.getElementById('math-game-modal').classList.remove('flex');
            document.getElementById('math-game-modal').classList.add('hidden');
            document.getElementById('student-dashboard').classList.remove('hidden');
            initStudentDashboard(); // Re-render the dashboard state
        });
       
        // Game interaction listeners
        canvas.addEventListener('mousemove', (event) => {
            if (!running || game.state !== 'playing' || game.pendingNext) return;
            const rect = canvas.getBoundingClientRect();
            mousePos.x = event.clientX - rect.left;
            mousePos.y = event.clientY - rect.top;
           
            game.options.forEach(option => {
                option.isHover = circlePointCollision(
                    { x: option.pos.x, y: option.pos.y, radius: option.radius },
                    mousePos
                );
            });
        });

        canvas.addEventListener('click', (event) => {
            if (game.state !== 'playing' || game.pendingNext) return;
           
            for (const option of game.options) {
                if (circlePointCollision({ x: option.pos.x, y: option.pos.y, radius: option.radius }, mousePos)) {
                    playClickSound();
                   
                    if (option.value === game.question.answer) {
                        game.score++;
                        option.flashTimer = 0.6;
                        option.flashColor = FEEDBACK_POS_COLOR;
                        game.feedbackText = 'Correct!';
                        game.feedbackColor = FEEDBACK_POS_COLOR;
                        game.feedbackTimer = 0.9;
                        playWinSound();
                    } else {
                        game.lives--;
                        option.flashTimer = 0.6;
                        option.flashColor = FEEDBACK_NEG_COLOR;
                        game.feedbackText = 'Wrong! -1 Life';
                        game.feedbackColor = FEEDBACK_NEG_COLOR;
                        game.feedbackTimer = 0.9;
                    }
                    game.pendingNext = true;
                    game.pendingTimer = 0.55;
                    break;
                }
            }
        });
       
        // --- Puzzle Mania Game Integration ---
        const puzzleManiaModal = document.getElementById('puzzle-mania-modal');
        const puzzleManiaCard = document.getElementById('puzzle-mania-card');
        const gameBoard = document.getElementById('game-board');
        const startButton = document.getElementById('start-button');
        const quitGameButton = document.getElementById('quit-game-btn');
        const gameStatus = document.getElementById('game-status');
        const movesCounter = document.getElementById('moves-counter');

        let cards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let moves = 0;
        let lockBoard = false;

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function createBoard() {
            gameBoard.innerHTML = '';
            const emojis = ['🍉', '🥭', '🚜', '🌱', '💧', '☀️', '🐄', '🏡', '🌾', '🌸'];
            const gameEmojis = shuffle(emojis.slice(0, 6).concat(emojis.slice(0, 6)));
           
            gameEmojis.forEach((emoji, index) => {
                const card = document.createElement('div');
                card.classList.add('card');
                card.dataset.emoji = emoji;
                card.dataset.index = index;
                card.innerHTML = `
                    <div class="card-inner">
                        <div class="card-front"></div>
                        <div class="card-back">${emoji}</div>
                    </div>
                `;
                card.addEventListener('click', flipCard);
                gameBoard.appendChild(card);
            });
        }
       
        function flipCard() {
            if (lockBoard || this === flippedCards[0] || this.classList.contains('flipped')) return;

            this.classList.add('flipped');
            flippedCards.push(this);
            moves++;
            movesCounter.textContent = `Moves: ${moves}`;

            if (flippedCards.length === 2) {
                lockBoard = true;
                checkForMatch();
            }
        }

        function checkForMatch() {
            const [firstCard, secondCard] = flippedCards;
            const isMatch = firstCard.dataset.emoji === secondCard.dataset.emoji;

            if (isMatch) {
                disableCards(firstCard, secondCard);
                matchedPairs++;
                if (matchedPairs === 6) {
                    setTimeout(() => {
                        gameStatus.textContent = 'You won! 🎉';
                        quitGameButton.classList.remove('hidden');
                        // Add XP logic here
                        showMessage(`Congratulations! You earned 50 XP!`, 'success');
                    }, 1000);
                }
            } else {
                unflipCards();
            }
        }

        function disableCards(card1, card2) {
            card1.removeEventListener('click', flipCard);
            card2.removeEventListener('click', flipCard);
            card1.classList.add('matched');
            card2.classList.add('matched');
            resetBoard();
        }

        function unflipCards() {
            setTimeout(() => {
                flippedCards[0].classList.remove('flipped');
                flippedCards[1].classList.remove('flipped');
                resetBoard();
            }, 1000);
        }

        function resetBoard() {
            [flippedCards, lockBoard] = [[], false];
        }

        function startGame() {
            moves = 0;
            matchedPairs = 0;
            movesCounter.textContent = 'Moves: 0';
            gameStatus.textContent = 'Find the matching pairs!';
            quitGameButton.classList.add('hidden');
            createBoard();
        }

        puzzleManiaCard.addEventListener('click', () => {
            document.getElementById('student-dashboard').classList.add('hidden');
            puzzleManiaModal.classList.remove('hidden');
            puzzleManiaModal.classList.add('flex');
            startGame();
        });

        startButton.addEventListener('click', () => {
            startGame();
        });

        quitGameButton.addEventListener('click', () => {
            puzzleManiaModal.classList.add('hidden');
            puzzleManiaModal.classList.remove('flex');
            document.getElementById('student-dashboard').classList.remove('hidden');
            initStudentDashboard(); // Re-render the dashboard state
        });
       
        // Event listeners and logic for the newly added student dashboard sections
        document.addEventListener('DOMContentLoaded', () => {
            const markAttendanceBtn = document.getElementById('markAttendanceBtn');
            const attendanceAnimationOverlay = document.getElementById('attendanceAnimationOverlay');
            const animatedMonkey = document.getElementById('animatedMonkey');
            const monkeyMessage = document.getElementById('monkeyMessage');
            const homeworkHelpBtns = document.querySelectorAll('.homework-help-btn');
            const homeworkHelpModal = document.getElementById('homeworkHelpModal');
            const homeworkHelpContent = document.getElementById('homeworkHelpContent');
            const closeHomeworkHelpBtn = document.getElementById('closeHomeworkHelpBtn');
            const listenHelpBtn = document.getElementById('listenHelpBtn');
            const storyMaker = document.getElementById('storyMaker');
            const storyMakerModal = document.getElementById('storyMakerModal');
            const closeStoryMakerBtn = document.getElementById('closeStoryMakerBtn');
            const storyWordInput = document.getElementById('storyWordInput');
            const generateStoryBtn = document.getElementById('generateStoryBtn');
            const storyResult = document.getElementById('storyResult');
            const visualizeStoryBtn = document.getElementById('visualizeStoryBtn');
            const storyImageResult = document.getElementById('storyImageResult');
            const curiousQuestionInput = document.getElementById('curious-question-input');
            const askCuriousQuestionBtn = document.getElementById('ask-curious-question-btn');
            const curiousAnswer = document.getElementById('curious-answer');

            // Attendance Animation
            if (markAttendanceBtn) {
                markAttendanceBtn.addEventListener('click', () => {
                    markAttendanceBtn.disabled = true;
                    if (attendanceAnimationOverlay) {
                        attendanceAnimationOverlay.classList.remove('hidden');
                        attendanceAnimationOverlay.classList.add('flex');
                    }
                    if (animatedMonkey) {
                        animatedMonkey.classList.add('animate-fall');
                    }
                });
            }

            if (animatedMonkey) {
                animatedMonkey.addEventListener('animationend', (event) => {
                    if (event.animationName === 'fall-down') {
                        monkeyMessage.classList.remove('opacity-0');
                        setTimeout(() => {
                            monkeyMessage.classList.add('opacity-0');
                            animatedMonkey.classList.remove('animate-fall');
                            animatedMonkey.classList.add('animate-rise');
                        }, 1500);
                    } else if (event.animationName === 'go-up') {
                        if (attendanceAnimationOverlay) {
                            attendanceAnimationOverlay.classList.add('hidden');
                            attendanceAnimationOverlay.classList.remove('flex');
                        }
                        animatedMonkey.classList.remove('animate-rise');
                        showMessage('Attendance Confirmed!', `You have successfully marked your attendance.`);
                        if (markAttendanceBtn) markAttendanceBtn.disabled = false;
                    }
                });
            }

            // Homework Help
            if (homeworkHelpBtns) {
                homeworkHelpBtns.forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if (currentAudio) currentAudio.pause();
                        if (listenHelpBtn) {
                            listenHelpBtn.classList.add('hidden');
                            listenHelpBtn.classList.remove('audio-btn-playing');
                        }
                        const topic = btn.dataset.homework;
                        if (homeworkHelpModal) {
                            homeworkHelpModal.classList.remove('hidden');
                            homeworkHelpModal.classList.add('flex');
                        }
                        if (homeworkHelpContent) {
                            homeworkHelpContent.innerHTML = '<div class="flex justify-center items-center"><div class="spinner w-8 h-8 border-4 rounded-full"></div></div>';
                        }
                        const prompt = `You are a friendly and encouraging tutor for a young student in a rural part of India (class 1-8). Explain the following topic in very simple, easy-to-understand English. Use short sentences and a simple analogy if possible. Topic: ${topic}`;
                        const response = await callGeminiText(prompt);
                        if (homeworkHelpContent) {
                            homeworkHelpContent.innerHTML = response.replace(/\n/g, '<br>');
                        }
                        if (listenHelpBtn) {
                            listenHelpBtn.classList.remove('hidden');
                        }
                    });
                });
            }

            if (listenHelpBtn) {
                listenHelpBtn.addEventListener('click', async () => {
                    if (currentAudio && !currentAudio.paused) {
                        currentAudio.pause(); return;
                    }
                    const text = homeworkHelpContent.innerText;
                    if (!text) return;
                    listenHelpBtn.disabled = true;
                    listenHelpBtn.innerHTML = 'Loading Audio...';
                    const audioUrl = await callGeminiTTS(`Say this in a helpful and clear voice: ${text}`);
                    listenHelpBtn.disabled = false;
                    listenHelpBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-volume-up-fill" viewBox="0 0 16 16"><path d="M11.536 14.01A8.47 8.47 0 0 0 14.026 8a8.47 8.47 0 0 0-2.49-6.01l-1.414 1.414A6.47 6.47 0 0 1 12.025 8a6.47 6.47 0 0 1-1.903 4.596z"/><path d="M10.121 12.596A6.47 6.47 0 0 0 12.025 8a6.47 6.47 0 0 0-1.904-4.596l-1.414 1.414A4.47 4.47 0 0 1 10.025 8a4.47 4.47 0 0 1-1.318 3.182z"/><path d="M8.707 11.182A2.47 2.47 0 0 0 9.025 8a2.47 2.47 0 0 0-.318-1.182L8.707 5.404A4.47 4.47 0 0 1 10.025 8a4.47 4.47 0 0 1-1.318 3.182zM4.252 0C2.42 0 1 1.42 1 3.252v9.496C1 14.58 2.42 16 4.252 16h1.598a1 1 0 0 0 1-1V1a1 1 0 0 0-1-1zm-1.5 4.5A1.5 1.5 0 0 1 4.252 3h1.5a1.5 1.5 0 0 1 0 3h-1.5A1.5 1.5 0 0 1 2.752 4.5"/></svg> Listen to explanation`;
                    if (audioUrl) {
                        currentAudio = new Audio(audioUrl);
                        currentAudio.play();
                        listenHelpBtn.classList.add('audio-btn-playing');
                        currentAudio.onended = () => listenHelpBtn.classList.remove('audio-btn-playing');
                        currentAudio.onpause = () => listenHelpBtn.classList.remove('audio-btn-playing');
                    }
                });
            }

            if (closeHomeworkHelpBtn) {
                closeHomeworkHelpBtn.addEventListener('click', () => {
                    if (currentAudio) currentAudio.pause();
                    homeworkHelpModal.classList.remove('flex');
                    homeworkHelpModal.classList.add('hidden');
                });
            }

            // Story Maker
            if (storyMaker) {
                storyMaker.addEventListener('click', () => {
                    if (storyMakerModal) {
                        storyMakerModal.classList.remove('hidden');
                        storyMakerModal.classList.add('flex');
                    }
                });
            }

            if (closeStoryMakerBtn) {
                closeStoryMakerBtn.addEventListener('click', () => {
                    if (storyMakerModal) {
                        storyMakerModal.classList.remove('flex');
                        storyMakerModal.classList.add('hidden');
                    }
                });
            }

            if (generateStoryBtn) {
                generateStoryBtn.addEventListener('click', async () => {
                    const word = storyWordInput.value.trim();
                    if (!word) {
                        if (storyResult) storyResult.textContent = 'Please enter a word first!';
                        return;
                    }
                    generateStoryBtn.disabled = true;
                    if (visualizeStoryBtn) visualizeStoryBtn.classList.add('hidden');
                    if (storyImageResult) storyImageResult.innerHTML = '';
                    if (storyResult) storyResult.innerHTML = '<div class="flex justify-center items-center"><div class="loader-book">📖</div></div>';
                   
                    const prompt = `You are a creative storyteller for a child in India (ages 6-14). Write a short, imaginative story starter (2-3 paragraphs) based on this single word: "${word}". Make it interesting and end it in a way that makes the reader wonder what happens next.`;
                    const response = await callGeminiText(prompt);
                    if (storyResult) storyResult.innerHTML = response.replace(/\n/g, '<br>');
                    generateStoryBtn.disabled = false;
                    if (visualizeStoryBtn) visualizeStoryBtn.classList.remove('hidden');
                });
            }

            if (visualizeStoryBtn) {
                visualizeStoryBtn.addEventListener('click', async () => {
                    const storyText = storyResult.innerText;
                    if (!storyText) return;
                    visualizeStoryBtn.disabled = true;
                    storyImageResult.innerHTML = '<div class="flex justify-center items-center"><div class="spinner w-8 h-8 border-4 rounded-full"></div></div>';
                    const imagePrompt = `A vibrant, colorful, and cheerful illustration for a children's storybook, in a simple, friendly art style. The scene is: ${storyText}`;
                    const base64Data = await callImagen(imagePrompt);
                    if (base64Data) {
                        storyImageResult.innerHTML = `<img src="data:image/png;base64,${base64Data}" alt="Visualization of the story" class="rounded-lg object-cover w-full h-full">`;
                    } else {
                        storyImageResult.innerHTML = '<p class="text-center text-red-500">Could not create an image.</p>';
                    }
                    visualizeStoryBtn.disabled = false;
                });
            }

            // Curious Corner
            if (askCuriousQuestionBtn) {
                askCuriousQuestionBtn.addEventListener('click', async () => {
                    const question = curiousQuestionInput.value.trim();
                    if (!question) {
                        if (curiousAnswer) {
                            curiousAnswer.classList.remove('hidden');
                            curiousAnswer.textContent = 'Please type a question first.';
                        }
                        return;
                    }
                    if (curiousAnswer) curiousAnswer.classList.remove('hidden');
                    if (curiousAnswer) curiousAnswer.innerHTML = '<div class="flex justify-center items-center"><div class="loader-thinking">🤔</div></div>';
                    askCuriousQuestionBtn.disabled = true;

                    const prompt = `You are an AI teacher for a young student in rural India (class 1-8). Answer the following question in very simple, short sentences. Use an easy-to-understand analogy if it helps. Question: ${question}`;
                    const response = await callGeminiText(prompt);
                    if (curiousAnswer) curiousAnswer.innerHTML = response.replace(/\n/g, '<br>');
                    askCuriousQuestionBtn.disabled = false;
                });
            }
        });
    </script>
</body>
</html>
